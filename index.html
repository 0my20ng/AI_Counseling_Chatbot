<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 상담 챗봇 - 전문 심리 상담 시스템</title>
    <style>
        /* =================================
           기본 스타일링 및 리셋
        ================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* =================================
           메인 컨테이너 스타일
        ================================= */
        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 80vh;
            min-height: 600px;
        }

        /* =================================
           설정 패널 스타일
        ================================= */
        .settings-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: none;
        }

        .settings-panel.show {
            display: block;
        }

        .api-config {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .api-config select,
        .api-config input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-config input[type="password"] {
            flex: 1;
            min-width: 200px;
        }

        .save-config-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .save-config-btn:hover {
            background: #3d8bfe;
        }

        .api-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
        }

        .api-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* =================================
           헤더 영역 스타일
        ================================= */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .settings-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .settings-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* 세션 정보 및 상태 표시 */
        .session-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .session-id {
            font-family: monospace;
            opacity: 0.8;
        }

        /* 상태 펄스 애니메이션 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* =================================
           채팅 영역 스타일
        ================================= */
        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 메시지 컨테이너 */
        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.5s ease-in;
        }

        /* 메시지 나타나는 애니메이션 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 사용자 메시지는 오른쪽 정렬 */
        .message.user {
            flex-direction: row-reverse;
        }

        /* 메시지 말풍선 스타일 */
        .message-bubble {
            max-width: 75%;
            padding: 16px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            line-height: 1.5;
        }

        /* 봇 메시지 말풍선 */
        .message.bot .message-bubble {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            border-bottom-left-radius: 6px;
            border: 1px solid #dee2e6;
        }

        /* 사용자 메시지 말풍선 */
        .message.user .message-bubble {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        /* 시스템 메시지 */
        .message.system .message-bubble {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 1px solid #ffeaa7;
            text-align: center;
            max-width: 90%;
            margin: 0 auto;
        }

        /* 아바타 스타일 */
        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .bot-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .system-avatar {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            color: white;
        }

        /* =================================
           특수 UI 컴포넌트 스타일
        ================================= */

        /* 모드 선택 카드 */
        .mode-selection {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .mode-card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .mode-card:hover {
            border-color: #4facfe;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.2);
        }

        .mode-card.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
        }

        .mode-card h3 {
            color: #4facfe;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .mode-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        /* 평가 질문 카드 */
        .assessment-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #4facfe;
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
        }

        /* 완료된 평가 질문 스타일 */
        .assessment-card.completed .rating-option {
            cursor: not-allowed;
        }

        .assessment-card.completed .rating-option.selected {
            opacity: 1 !important;
        }

        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            background: #4facfe;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .assessment-type {
            background: rgba(79, 172, 254, 0.1);
            color: #4facfe;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .question-text {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* 평점 선택 버튼 */
        .rating-scale {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .rating-option {
            flex: 1;
            min-width: 120px;
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            line-height: 1.3;
        }

        .rating-option:hover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.05);
        }

        .rating-option.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-weight: 600;
        }

        .rating-number {
            display: block;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* 감정 분석 결과 표시 */
        .emotion-analysis {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }

        .emotion-analysis h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .emotion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        }

        .emotion-item:last-child {
            border-bottom: none;
        }

        .emotion-bar {
            width: 100px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .emotion-fill {
            height: 100%;
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            transition: width 0.5s ease;
        }

        /* 키워드 분석 */
        .keyword-analysis {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }

        .keyword-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .keyword-tag {
            background: rgba(255, 152, 0, 0.1);
            color: #e65100;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        /* 결과 요약 카드 */
        .summary-card {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 2px solid #9c27b0;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .summary-header h3 {
            color: #7b1fa2;
            font-size: 20px;
        }

        .score-display {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .score-number {
            font-size: 36px;
            font-weight: bold;
            color: #7b1fa2;
            margin-bottom: 5px;
        }

        .score-interpretation {
            color: #666;
            font-size: 14px;
        }

        /* 권장사항 리스트 */
        .recommendations {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .recommendations h4 {
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        .recommendation-icon {
            background: #2196f3;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* 개인정보 보호 공지 */
        .privacy-notice {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: #2e7d32;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 타이핑 인디케이터 */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-style: italic;
            padding: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* 빠른 응답 버튼 */
        .quick-responses {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .quick-response {
            padding: 10px 16px;
            background: rgba(79, 172, 254, 0.1);
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4facfe;
        }

        .quick-response:hover {
            background: rgba(79, 172, 254, 0.2);
            transform: translateY(-2px);
        }

        /* =================================
           입력 영역 스타일
        ================================= */
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            resize: none;
            min-height: 50px;
            max-height: 100px;
        }

        .input-field:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* 환영 화면 */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #4facfe;
        }

        /* =================================
           모바일 반응형 스타일
        ================================= */
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
                margin: 0;
            }
            
            .message-bubble {
                max-width: 85%;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .mode-selection {
                flex-direction: column;
            }

            .mode-card {
                min-width: auto;
            }

            .rating-scale {
                flex-direction: column;
            }

            .rating-option {
                min-width: auto;
            }

            .api-config {
                flex-direction: column;
                align-items: stretch;
            }

            .api-config input[type="password"] {
                min-width: auto;
            }
        }

        /* =================================
           유틸리티 클래스
        ================================= */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- 메인 컨테이너 -->
    <div class="container">
        <!-- 설정 패널 -->
        <div class="settings-panel" id="settingsPanel">
            <div class="api-config">
                <select id="aiProvider">
                    <option value="openai">OpenAI GPT</option>
                    <option value="google">Google Gemini</option>
                    <option value="local">로컬 모델 (무료)</option>
                </select>
                <input type="password" id="apiKey" placeholder="API 키 입력 (선택사항)">
                <button class="save-config-btn" onclick="chatbot.saveApiConfig()">저장</button>
            </div>
            <div class="api-status" id="apiStatus">
                설정을 저장하여 AI 연결을 테스트하세요.
            </div>
        </div>

        <!-- 헤더 영역 -->
        <div class="header">
            <div class="header-content">
                <div>
                    <button class="settings-toggle" onclick="chatbot.toggleSettings()">⚙️ AI 설정</button>
                    <h1>🧠 AI 전문 상담 챗봇</h1>
                    <p>익명 보장 • 자연스러운 대화 • 개인정보 보호</p>
                </div>
                <!-- 세션 정보 -->
                <div class="session-info">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>안전한 연결</span>
                    </div>
                    <div class="session-id" id="sessionId">세션: 로딩중...</div>
                </div>
            </div>
        </div>

        <!-- 채팅 영역 -->
        <div class="chat-container" id="chatContainer">
            <!-- 개인정보 보호 공지 -->
            <div class="privacy-notice">
                🔒 <strong>개인정보 보호</strong>: 모든 대화는 익명화되어 임시 저장되며, 상담 종료 시 자동 삭제됩니다.
            </div>
            
            <!-- 환영 화면 -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-icon">🤝</div>
                <h2>자연스러운 AI 상담사에 오신 것을 환영합니다</h2>
                <p>GPT, Gemini 등 최신 AI 모델을 활용한<br>
                공감적이고 자연스러운 상담을 제공합니다.</p>
                
                <!-- 상담 모드 선택 -->
                <div class="mode-selection mt-20">
                    <div class="mode-card" onclick="chatbot.selectMode('conversation')">
                        <h3>💬 자유 대화 상담</h3>
                        <p>자연스러운 대화를 통한<br>감정 분석 및 상담</p>
                    </div>
                    <div class="mode-card" onclick="chatbot.selectMode('assessment')">
                        <h3>📋 표준 심리검사</h3>
                        <p>PHQ-9, GAD-7, PSS<br>표준화된 평가</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 입력 영역 -->
        <div class="input-container">
            <textarea 
                class="input-field" 
                id="messageInput" 
                placeholder="편안하게 현재 상황이나 고민을 말씀해 주세요..."
                maxlength="1000"
                rows="1"
            ></textarea>
            <button class="send-button" id="sendButton">➤</button>
        </div>
    </div>

    <script>
        /**
         * 향상된 AI 상담 챗봇 클래스 - 자연스러운 AI 응답 연동
         */
        class EnhancedAICounselingChatbot {
            constructor() {
                // DOM 요소들 참조
                this.chatContainer = document.getElementById('chatContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.welcomeScreen = document.getElementById('welcomeScreen');
                this.sessionIdElement = document.getElementById('sessionId');
                this.settingsPanel = document.getElementById('settingsPanel');
                this.apiStatus = document.getElementById('apiStatus');
                
                // AI 설정
                this.aiConfig = {
                    provider: 'local', // 기본값은 로컬 모델
                    apiKey: null,
                    isConnected: false
                };
                
                // 세션 관리
                this.session = {
                    id: this.generateSessionId(),
                    responses: [],
                    scores: {},
                    emotionalProfile: {},
                    conversationSummary: '',
                    createdAt: new Date().toISOString(),
                    mode: null
                };
                
                // 대화 상태 관리
                this.conversationState = {
                    phase: 'greeting',
                    currentAssessmentType: null,
                    currentQuestionIndex: 0,
                    conversationHistory: [],
                    emotionalThemes: new Set(),
                    keyProblems: []
                };
                
                this.isTyping = false;
                
                // 평가 도구 데이터
                this.assessmentData = {
                    phq9: {
                        name: "PHQ-9 우울증 선별검사",
                        questions: [
                            "지난 2주 동안, 일을 하는데 흥미나 즐거움을 거의 느끼지 못했다",
                            "지난 2주 동안, 기분이 가라앉거나, 우울하거나, 절망적이라고 느꼈다",
                            "지난 2주 동안, 잠들기 어렵거나, 자다가 깨거나, 너무 많이 잠을 잤다",
                            "지난 2주 동안, 피곤하다고 느꼈거나 기운이 거의 없었다",
                            "지난 2주 동안, 식욕이 떨어졌거나 너무 많이 먹었다",
                            "지난 2주 동안, 자신이 나쁜 사람이라고 느꼈거나, 실패자라고 느꼈거나, 자신 때문에 자신이나 가족이 불행하게 되었다고 느꼈다",
                            "지난 2주 동안, 신문을 읽거나 텔레비전을 보는 것과 같은 일에 집중하는 것이 어려웠다",
                            "지난 2주 동안, 다른 사람들이 주목할 정도로 평소보다 말과 행동이 느려졌거나, 또는 반대로 평상시보다 많이 움직여서 가만히 앉아 있을 수 없었다",
                            "지난 2주 동안, 자신이 죽는 것이 더 낫다고 생각하거나 자신을 해칠 생각을 했다"
                        ]
                    },
                    gad7: {
                        name: "GAD-7 불안장애 선별검사",
                        questions: [
                            "지난 2주 동안, 초조하거나 불안하거나 조마조마하게 느꼈다",
                            "지난 2주 동안, 걱정하는 것을 멈추거나 조절할 수 없었다",
                            "지난 2주 동안, 여러 가지 것들을 너무 많이 걱정했다",
                            "지난 2주 동안, 편하게 있기가 어려웠다",
                            "지난 2주 동안, 너무 안절부절못해서 가만히 있기가 힘들었다",
                            "지난 2주 동안, 쉽게 짜증이 나거나 성을 잘 냈다",
                            "지난 2주 동안, 무서운 일이 생길 것 같아서 두려웠다"
                        ]
                    },
                    stress: {
                        name: "지각된 스트레스 척도(PSS)",
                        questions: [
                            "최근 한 달 동안, 예상치 못한 일 때문에 기분이 상한 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 인생의 중요한 일들을 조절할 수 없다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 신경이 예민하고 스트레스를 받는다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 자신의 문제들을 성공적으로 다룰 수 있다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 인생이 자신의 뜻대로 되어간다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 어려운 일을 효과적으로 대처할 수 있다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 인생의 중요한 변화들을 통제할 수 있다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 원하는 대로 일이 풀리지 않아 좌절한 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 감정 조절이 어렵다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 생활 속 사건들이 나를 압도한다고 느낀 적이 얼마나 자주 있었나요?"
                        ]
                    }
                };

                // 평가 척도 설명
                this.scaleDescriptions = {
                    0: "전혀 그렇지 않다",
                    1: "며칠 동안 그랬다",
                    2: "일주일 이상 그랬다",
                    3: "거의 매일 그랬다"
                };

                // 키워드 패턴 (감정 및 상황 분석용) - 대폭 확장
                this.keywordPatterns = {
                    depression: [
                        // 기본 우울 표현
                        "우울", "슬픔", "절망", "의욕없", "흥미없", "죽고싶", "허무", "공허", "외로", "혼자",
                        "무가치", "자책", "피곤", "기운없", "무력감", "낙담", "희망없", "실망", "무기력", "눈물",
                        // 확장된 우울 표현
                        "막막", "깊은 한숨", "생각만해도", "의미없", "아무것도", "소용없", "포기", "체념",
                        "자존감", "자신감없", "열등감", "비관적", "어둠", "침울", "멍하", "먹먹", "가슴이답답",
                        "울컥", "서러움", "쓸쓸", "고독", "고립", "단절", "소외", "버려진", "잊혀진",
                        "무너짐", "추락", "밑바닥", "끝", "마지막", "돌이킬수없", "회복불가", "치유불가",
                        // 신체적 증상
                        "잠못자", "식욕없", "무거운몸", "늘어짐", "축처짐", "기력없", "에너지없", "활력없",
                        "집중안됨", "기억안남", "결정장애", "우유부단", "미루기", "회피", "도피", "은둔",
                        // 인지적 표현
                        "자꾸생각", "반복생각", "꼬리물기", "부정적", "비판적", "완벽주의", "실패감",
                        "죄책감", "원망", "후회", "자책", "자기혐오", "자기부정", "자아비판"
                    ],
                    anxiety: [
                        // 기본 불안 표현
                        "불안", "걱정", "초조", "두려", "긴장", "공포", "떨림", "심장", "숨이막", "공황",
                        "불확실", "예민", "긴박", "긴장감", "근심", "걱정스러움", "압박감", "긴장되", "불편",
                        // 확장된 불안 표현
                        "조바심", "안절부절", "덜덜", "벌벌", "오금저림", "식은땀", "진땀", "손떨림",
                        "심장박동", "가슴두근", "숨가쁨", "호흡곤란", "질식", "답답함", "목막힘", "목이붓",
                        "어지러움", "현기증", "머리띵", "멍함", "정신없음", "집중안됨", "산만함",
                        // 상황적 불안
                        "최악의상황", "만약에", "혹시나", "불길한", "예감", "징조", "불안감", "위기감",
                        "위험신호", "경고", "알람", "스트레스", "압박", "부담", "중압감", "긴박함",
                        "촉박함", "시급함", "급함", "서둘러", "빨리", "늦었", "놓침", "실수",
                        // 신체 반응
                        "배아픔", "속쓰림", "소화불량", "변비", "설사", "속울렁", "구토", "메스꺼움",
                        "근육경직", "목어깨", "뒷목", "두통", "편두통", "눈피로", "눈떨림", "입마름",
                        // 행동적 표현
                        "확인", "재확인", "반복", "강박", "완벽", "계획", "준비", "대비", "예방",
                        "회피", "도망", "피함", "멀리함", "거부", "거절", "미룸", "연기"
                    ],
                    stress: [
                        // 기본 스트레스 표현
                        "스트레스", "압박", "힘들", "버거", "감당", "부담", "피로", "지침", "과로", "번아웃",
                        "피곤", "지치", "소진", "초과근무", "피곤함", "압도", "압도되", "한계", "탈진",
                        // 확장된 스트레스 표현
                        "벅차", "감당안됨", "손에안잡힘", "통제불가", "조절안됨", "관리안됨", "처리안됨",
                        "해결안됨", "풀리지않", "엉킨", "복잡", "꼬인", "난해", "어려움", "곤란",
                        "막막함", "답없음", "출구없음", "길없음", "방법없음", "해답없음", "대안없음",
                        // 시간 압박
                        "시간없", "촉박", "급함", "서둘러", "빨리", "바빠", "정신없", "쫓김", "밀림",
                        "데드라인", "마감", "기한", "시한", "제한", "한정", "부족", "모자람", "딸림",
                        // 업무/학업 스트레스
                        "과제", "숙제", "시험", "평가", "점수", "성적", "순위", "등급", "경쟁", "비교",
                        "실적", "성과", "목표", "할당량", "노르마", "기준", "요구사항", "조건", "의무",
                        "책임", "의무", "부담", "압박", "기대", "요구", "압력", "강요", "강제",
                        // 신체적 피로
                        "녹초", "탈진", "기력소진", "에너지고갈", "배터리방전", "충전필요", "휴식필요",
                        "재충전", "회복", "치유", "힐링", "쉼", "잠", "수면", "편안", "안정"
                    ],
                    anger: [
                        // 기본 분노 표현
                        "화", "짜증", "분노", "열받", "빡쳐", "속상", "억울", "분한", "성질", "화남",
                        "원망", "불만", "짜증나", "답답", "폭발", "화가치밀", "분개", "성질나", "분노조절",
                        // 확장된 분노 표현
                        "미치겠", "돌겠", "환장", "열불", "빡침", "뚜껑열림", "폭발직전", "한계점",
                        "참을성", "인내심", "한계", "끝", "극한", "절정", "정점", "최고조", "피크",
                        "울분", "분통", "격분", "격노", "노발대발", "버럭", "폭발", "터짐", "소리",
                        // 감정 표현
                        "억울함", "분함", "원통함", "한탄", "한스러움", "속상함", "서운함", "실망",
                        "배신감", "불신", "의심", "불공평", "불평등", "차별", "편견", "무시", "멸시",
                        "경멸", "조롱", "비웃음", "모독", "모멸", "굴욕", "창피", "수치", "부끄러움",
                        // 대상별 분노
                        "상사", "동료", "부하", "선배", "후배", "친구", "가족", "부모", "자식", "배우자",
                        "연인", "타인", "사회", "세상", "시스템", "제도", "규칙", "법", "정부", "회사",
                        // 행동 충동
                        "때리고싶", "부수고싶", "소리지르고싶", "욕하고싶", "도망치고싶", "그만두고싶",
                        "포기하고싶", "버리고싶", "던지고싶", "차버리고싶", "박살내고싶", "망가뜨리고싶"
                    ],
                    relationships: [
                        // 기본 관계 표현
                        "가족", "친구", "연인", "동료", "상사", "부모", "자식", "배우자", "갈등", "다툼",
                        "대화단절", "왕따", "단절", "사이멀어짐", "배신", "신뢰문제", "친밀감", "오해", "거절",
                        // 확장된 관계 표현
                        "소통", "대화", "이해", "공감", "지지", "지원", "도움", "협력", "화합", "조화",
                        "갈등", "충돌", "마찰", "마음상함", "서운함", "섭섭함", "아쉬움", "그리움",
                        "외로움", "고독", "고립", "소외", "배제", "따돌림", "무시", "홀대", "냉대",
                        // 가족 관계
                        "엄마", "아빠", "형", "누나", "언니", "오빠", "동생", "할머니", "할아버지",
                        "시부모", "장인", "장모", "시댁", "친정", "혈육", "가족사랑", "가족갈등",
                        "세대차이", "가치관차이", "육아", "양육", "교육", "훈육", "관심", "애정",
                        // 연인/부부 관계
                        "사랑", "애정", "로맨스", "데이트", "만남", "헤어짐", "이별", "결혼", "이혼",
                        "바람", "불륜", "외도", "질투", "시기", "의심", "불신", "믿음", "신뢰",
                        "약속", "맹세", "다짐", "결심", "다정", "달콤", "행복", "즐거움", "기쁨",
                        // 친구 관계
                        "우정", "동료", "선후배", "동기", "동창", "친목", "모임", "만남", "약속",
                        "배신", "실망", "신뢰", "믿음", "지지", "응원", "격려", "위로", "공감",
                        // 직장 관계
                        "상하관계", "위계질서", "권력", "권위", "지위", "직급", "직책", "책임",
                        "업무협력", "팀워크", "소통", "보고", "지시", "명령", "요청", "부탁",
                        "갈등", "경쟁", "견제", "시기", "질투", "텃세", "파벌", "줄서기", "눈치"
                    ],
                    work_school: [
                        // 기본 업무/학업 표현
                        "직장", "회사", "학교", "업무", "공부", "시험", "취업", "승진", "성적", "진로",
                        "과제", "평가", "동기부여", "성과압박", "업무량", "졸업", "입시", "경쟁", "시간압박",
                        // 확장된 업무 표현
                        "출근", "퇴근", "야근", "주말근무", "초과근무", "잔업", "특근", "교대근무",
                        "프로젝트", "보고서", "회의", "미팅", "프레젠테이션", "발표", "기획", "제안",
                        "실적", "성과", "목표", "계획", "전략", "방향", "방침", "정책", "규정",
                        "승진", "평가", "인사", "배치", "전보", "발령", "임명", "해임", "퇴직",
                        // 직장 스트레스
                        "상사", "부하", "동료", "선배", "후배", "팀장", "과장", "부장", "임원",
                        "갈등", "마찰", "불화", "견제", "텃세", "파벌", "줄서기", "눈치", "정치",
                        "압박", "스트레스", "부담", "책임", "의무", "할당", "노르마", "할당량",
                        // 학업 관련
                        "수업", "강의", "수강", "과목", "학점", "학년", "학기", "방학", "개강",
                        "시험", "중간고사", "기말고사", "모의고사", "수능", "입시", "대입", "취업",
                        "성적", "점수", "등급", "석차", "순위", "경쟁", "비교", "우등", "우수",
                        "과제", "숙제", "리포트", "발표", "토론", "세미나", "프로젝트", "연구",
                        // 진로/취업
                        "진로", "장래", "미래", "꿈", "목표", "계획", "비전", "포부", "야망",
                        "취업", "구직", "채용", "면접", "입사", "지원", "이력서", "자소서",
                        "스펙", "경력", "경험", "자격증", "능력", "실력", "역량", "기술", "전문성"
                    ],
                    physical: [
                        // 기본 신체 표현
                        "아픔", "피로", "수면", "식욕", "두통", "소화", "몸살", "아프", "건강", "병원",
                        "근육통", "허리통증", "피곤함", "피로감", "어지럼", "체력저하", "질병", "약물", "수면장애",
                        // 확장된 신체 표현
                        "몸무거움", "기력없음", "에너지없음", "활력없음", "생기없음", "원기없음",
                        "컨디션난조", "몸상태", "건강상태", "체력", "면역력", "저항력", "회복력",
                        // 수면 관련
                        "잠못잠", "불면", "뒤척임", "새벽에깸", "일찍깸", "늦잠", "과수면", "수면부족",
                        "깊은잠", "얕은잠", "잠들기어려움", "수면리듬", "수면패턴", "수면질", "꿈",
                        "악몽", "잠꼬대", "이갈이", "코골이", "수면무호흡", "잠깨움", "졸림", "나른함",
                        // 식욕/소화
                        "식욕없음", "과식", "폭식", "식욕증가", "체중", "살찜", "살빠짐", "다이어트",
                        "소화불량", "속쓰림", "위염", "역류", "구토", "메스꺼움", "복통", "설사", "변비",
                        // 통증 관련
                        "두통", "편두통", "목통증", "어깨통증", "허리통증", "관절통", "근육통",
                        "신경통", "생리통", "치통", "배앓이", "가슴통증", "호흡곤란", "숨가쁨",
                        // 기타 증상
                        "현기증", "어지럼", "메스꺼움", "울렁거림", "구역감", "토할것같음",
                        "심장박동", "가슴두근", "혈압", "맥박", "체온", "열", "오한", "춥다",
                        "땀", "진땀", "식은땀", "탈수", "갈증", "목마름", "입마름", "침마름",
                        // 감각 관련
                        "시야흐림", "눈피로", "눈떨림", "귀울림", "이명", "청력", "후각", "미각",
                        "촉각", "감각", "둔감", "예민", "민감", "자극", "반응", "알레르기"
                    ],
                    loneliness: [
                        "혼자", "외로움", "고독", "고립", "단절", "소외", "배제", "따돌림", "무시",
                        "홀로", "혼자서", "나만", "아무도", "없음", "비어있음", "공허함", "허무함",
                        "쓸쓸함", "적막", "정적", "침묵", "무음", "조용함", "적요", "고요함",
                        "사람없음", "연락없음", "만남없음", "대화없음", "소통없음", "교류없음",
                        "친구없음", "가족없음", "연인없음", "동반자없음", "파트너없음", "상대없음",
                        "이해받지못함", "공감받지못함", "관심받지못함", "사랑받지못함", "인정받지못함"
                    ],
                    self_esteem: [
                        "자존감", "자신감", "자아", "자기", "나", "스스로", "자립", "독립",
                        "자존심", "자부심", "자랑", "긍지", "자부", "자신", "확신", "믿음",
                        "열등감", "우월감", "비교", "평가", "판단", "기준", "잣대", "척도",
                        "자기혐오", "자기부정", "자기비하", "자기비판", "자책", "자기성찰",
                        "자기개발", "자기계발", "성장", "발전", "향상", "개선", "변화", "변화"
                    ],
                    fear: [
                        "두려움", "공포", "무서움", "겁", "공포심", "두려워", "무서워", "겁나",
                        "불안", "걱정", "염려", "근심", "우려", "위험", "위기", "위협", "경고",
                        "실패", "좌절", "패배", "실수", "잘못", "틀림", "오류", "착각", "오해",
                        "거절", "거부", "반대", "부정", "비판", "비난", "욕", "나쁜말", "악플",
                        "미래", "앞일", "내일", "다음", "나중", "훗날", "장래", "장차", "앞으로"
                    ]
                };

                this.initializeSession();
                this.initializeEventListeners();
                this.loadSavedConfig();
            }

            /**
             * 세션 초기화
             */
            initializeSession() {
                this.sessionIdElement.textContent = `세션: ${this.session.id}`;
                console.log('익명 세션 시작:', this.session.id);
            }

            /**
             * 익명 세션 ID 생성
             */
            generateSessionId() {
                const timestamp = Date.now().toString();
                return this.hashString(timestamp).substring(0, 12);
            }

            /**
             * 간단한 해시 함수
             */
            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }

            /**
             * 이벤트 리스너 초기화
             */
            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = this.messageInput.scrollHeight + 'px';
                });
            }

            /**
             * 설정 패널 토글
             */
            toggleSettings() {
                this.settingsPanel.classList.toggle('show');
            }

            /**
             * API 설정 저장
             */
            async saveApiConfig() {
                const provider = document.getElementById('aiProvider').value;
                const apiKey = document.getElementById('apiKey').value;
                
                this.aiConfig.provider = provider;
                this.aiConfig.apiKey = apiKey || null;
                
                // 로컬 스토리지에 저장 (API 키는 세션에만)
                localStorage.setItem('aiProvider', provider);
                if (apiKey) {
                    sessionStorage.setItem('apiKey', apiKey);
                }
                
                // 연결 테스트
                await this.testApiConnection();
            }

            /**
             * 저장된 설정 로드
             */
            loadSavedConfig() {
                const savedProvider = localStorage.getItem('aiProvider');
                const savedApiKey = sessionStorage.getItem('apiKey');
                
                if (savedProvider) {
                    document.getElementById('aiProvider').value = savedProvider;
                    this.aiConfig.provider = savedProvider;
                }
                
                if (savedApiKey) {
                    document.getElementById('apiKey').value = savedApiKey;
                    this.aiConfig.apiKey = savedApiKey;
                    this.testApiConnection();
                }
            }

            /**
             * API 연결 테스트
             */
            async testApiConnection() {
                const statusElement = this.apiStatus;
                
                try {
                    statusElement.className = 'api-status';
                    statusElement.textContent = '연결 테스트 중...';
                    
                    if (this.aiConfig.provider === 'local') {
                        this.aiConfig.isConnected = true;
                        statusElement.className = 'api-status connected';
                        statusElement.textContent = '✅ 로컬 모델 사용 (무료, 제한적 성능)';
                        return;
                    }
                    
                    if (!this.aiConfig.apiKey) {
                        statusElement.className = 'api-status error';
                        statusElement.textContent = '❌ API 키가 필요합니다';
                        return;
                    }
                    
                    // 간단한 테스트 요청
                    const testResponse = await this.callAIAPI("안녕하세요", true);
                    
                    if (testResponse) {
                        this.aiConfig.isConnected = true;
                        statusElement.className = 'api-status connected';
                        statusElement.textContent = `✅ ${this.aiConfig.provider.toUpperCase()} 연결 성공`;
                    } else {
                        throw new Error('API 응답 없음');
                    }
                    
                } catch (error) {
                    this.aiConfig.isConnected = false;
                    statusElement.className = 'api-status error';
                    statusElement.textContent = `❌ 연결 실패: ${error.message}`;
                }
            }

            /**
             * AI API 호출 (OpenAI, Google Gemini 등)
             */
            async callAIAPI(userMessage, isTest = false) {
                if (this.aiConfig.provider === 'local') {
                    return this.generateLocalResponse(userMessage, isTest);
                }
                
                try {
                    if (this.aiConfig.provider === 'openai') {
                        return await this.callOpenAI(userMessage, isTest);
                    } else if (this.aiConfig.provider === 'google') {
                        return await this.callGoogleGemini(userMessage, isTest);
                    }
                } catch (error) {
                    console.error('AI API 호출 실패:', error);
                    // API 실패 시 로컬 모델로 폴백
                    return this.generateLocalResponse(userMessage, isTest);
                }
            }

            /**
             * OpenAI API 호출
             */
            async callOpenAI(userMessage, isTest = false) {
                if (isTest) {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.aiConfig.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{ role: 'user', content: '테스트' }],
                            max_tokens: 50
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return '연결 성공';
                }

                const systemPrompt = this.buildSystemPrompt();
                const conversationContext = this.buildConversationContext();
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.aiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...conversationContext,
                            { role: 'user', content: userMessage }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.choices[0].message.content;
            }

            /**
             * Google Gemini API 호출
             */
            async callGoogleGemini(userMessage, isTest = false) {
                if (isTest) {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.aiConfig.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: '테스트' }] }]
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return '연결 성공';
                }

                const systemPrompt = this.buildSystemPrompt();
                const fullPrompt = `${systemPrompt}\n\n사용자: ${userMessage}\n\n상담사:`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.aiConfig.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }],
                        generationConfig: {
                            maxOutputTokens: 500,
                            temperature: 0.7
                        }
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            /**
             * 로컬 모델 응답 생성 (대폭 개선된 버전)
             */
            generateLocalResponse(userMessage, isTest = false) {
                if (isTest) return '로컬 모델 사용';

                const keywords = this.extractKeywords(userMessage);
                const sentiment = this.analyzeSentiment(userMessage);
                const messageLength = userMessage.length;
                const conversationCount = this.conversationState.conversationHistory.length;
                
                // 대화 단계에 따른 응답 조절
                const conversationPhase = this.determineConversationPhase(conversationCount);
                
                // 감정별 다양한 응답 패턴 (대폭 확장)
                const responses = {
                    depression: {
                        opening: [
                            "마음이 많이 무거우신 것 같아요. 이런 감정을 표현해주셔서 고맙습니다.",
                            "힘든 시간을 보내고 계시는군요. 그런 마음을 느끼는 것 자체가 용기있는 일이에요.",
                            "우울한 감정이 지속되고 있는 것 같아요. 혼자 견뎌내려 하지 마세요.",
                            "지금 느끼시는 감정들이 얼마나 힘든지 이해해요. 충분히 그럴 만한 상황인 것 같아요.",
                            "마음의 짐이 무거워 보여요. 이렇게 솔직하게 말씀해주셔서 감사합니다."
                        ],
                        middle: [
                            "이런 감정이 언제부터 시작되었는지 기억나시나요? 특별한 계기가 있었을까요?",
                            "우울감이 하루 중 언제 가장 심하게 느껴지시나요? 패턴이 있는지 궁금해요.",
                            "지금까지 이런 기분을 극복해보려고 어떤 노력들을 해보셨나요?",
                            "가족이나 친구들에게 이런 마음을 털어놓아보신 적이 있으신가요?",
                            "평소 기분이 좋았던 때를 떠올려보시면 어떤 활동을 하고 계셨나요?"
                        ],
                        deep: [
                            "이런 감정들이 일상생활에 어떤 영향을 미치고 있나요? 잠이나 식사는 어떠신가요?",
                            "자신에 대해 부정적인 생각이 많아지셨나요? 어떤 생각들이 자주 드시는지요?",
                            "미래에 대한 희망이나 계획을 세우기 어려우신가요? 그런 마음 충분히 이해해요.",
                            "혹시 전문적인 도움을 받아보는 것에 대해 어떻게 생각하시나요?",
                            "지금 당장 가장 필요하다고 느끼는 것이 있다면 무엇일까요?"
                        ]
                    },
                    anxiety: {
                        opening: [
                            "불안한 마음이 크게 느껴지고 계시는군요. 그런 감정을 인정하는 것부터 시작이에요.",
                            "걱정이 많으신 것 같아요. 마음이 편하지 않으시죠?",
                            "불안감이 일상을 힘들게 만들고 있는 것 같아요. 어떤 상황에서 더 심해지나요?",
                            "긴장되고 예민해지는 마음이 느껴져요. 몸도 함께 긴장되어 있으실 것 같아요.",
                            "마음이 조급하고 안절부절하신 것 같아요. 그런 감정이 얼마나 힘든지 알아요."
                        ],
                        middle: [
                            "어떤 상황이나 생각이 불안감을 더 크게 만드시나요?",
                            "불안할 때 몸에서 느껴지는 증상들이 있나요? 심장 박동이나 숨쉬기는 어떠신가요?",
                            "밤에 잠들기 어려우시거나 자꾸 깨시는 일이 있나요?",
                            "불안한 생각들이 머리에서 떠나지 않아서 집중하기 어려우신가요?",
                            "예전에는 괜찮았던 일들도 지금은 걱정되시나요? 언제부터 그랬는지 기억나시나요?"
                        ],
                        deep: [
                            "가장 두려워하시는 것이 실제로 일어날 가능성은 얼마나 된다고 생각하세요?",
                            "불안할 때 도움이 되는 호흡법이나 이완 방법을 시도해보신 적이 있나요?",
                            "주변 사람들이 당신의 불안감을 이해해주고 있나요? 지지받고 계신가요?",
                            "불안감 때문에 피하게 되는 상황들이 늘어나고 있나요?",
                            "이런 불안감을 전문가와 상담해보는 것에 대해서는 어떻게 생각하세요?"
                        ]
                    },
                    stress: {
                        opening: [
                            "많은 스트레스를 받고 계시는 것 같아요. 정말 힘드셨을 것 같아요.",
                            "압박감이 상당히 크게 느껴지시는군요. 어깨가 무거우실 것 같아요.",
                            "여러 가지 일들이 한꺼번에 몰려와서 부담스러우신 것 같아요.",
                            "스트레스가 한계점에 다다른 것 같아요. 휴식이 절실해 보여요.",
                            "감당하기 어려운 상황들이 계속되고 있는 것 같아요. 정말 수고 많으세요."
                        ],
                        middle: [
                            "현재 가장 큰 스트레스 요인이 무엇인가요? 여러 가지가 겹쳐있나요?",
                            "스트레스 때문에 몸에 나타나는 증상들이 있나요? 피로감이나 두통은 어떠신가요?",
                            "이런 상황이 얼마나 지속되었나요? 언제부터 이렇게 힘들어지셨나요?",
                            "스트레스를 해소할 수 있는 시간이나 방법이 있으신가요?",
                            "주변에서 도움을 받을 수 있는 사람이나 자원이 있나요?"
                        ],
                        deep: [
                            "지금 상황에서 가장 우선순위를 두어야 할 것들을 정리해보셨나요?",
                            "완벽하게 하려고 하시는 성향이 스트레스를 더 키우고 있지는 않나요?",
                            "스트레스 관리를 위해 생활 패턴을 바꿔볼 여지가 있을까요?",
                            "이런 스트레스 상황이 반복된다면 어떤 대처 방법이 필요할까요?",
                            "전문적인 스트레스 관리 기법을 배워보는 것은 어떨까요?"
                        ]
                    },
                    anger: {
                        opening: [
                            "화가 많이 나셨군요. 그런 감정을 느끼는 것도 자연스러운 반응이에요.",
                            "분노가 치밀어 오르고 계시는 것 같아요. 억울하고 답답하시죠?",
                            "정말 화가 나실 만한 상황이었을 것 같아요. 어떤 일이 있으셨나요?",
                            "감정이 북받쳐 오르고 계시는군요. 그 마음 충분히 이해해요.",
                            "분한 마음이 크게 느껴져요. 참기 어려우셨을 것 같아요."
                        ],
                        middle: [
                            "어떤 상황에서 가장 화가 나시나요? 구체적으로 어떤 일이었을까요?",
                            "화가 날 때 몸에서 어떤 변화를 느끼시나요? 심장이 빨리 뛰거나 손이 떨리나요?",
                            "이런 분노감이 자주 생기시나요? 아니면 특별한 상황에서만 그러시나요?",
                            "화가 난 후에는 어떤 기분이 드시나요? 후회되거나 더 우울해지시나요?",
                            "분노를 표현하는 방법에 대해 고민해보신 적이 있나요?"
                        ],
                        deep: [
                            "이런 분노의 밑바탕에는 어떤 감정이 숨어있다고 생각하세요? 상처나 실망감일까요?",
                            "화를 건강하게 표현하거나 해소하는 방법을 찾아보셨나요?",
                            "분노 때문에 중요한 관계들이 영향을 받고 있지는 않나요?",
                            "이런 감정들을 조절하는 것에 대해 전문적인 도움을 받아보신 적이 있나요?",
                            "분노를 긍정적인 변화의 에너지로 바꿀 수 있는 방법이 있을까요?"
                        ]
                    },
                    relationships: {
                        opening: [
                            "인간관계에서 어려움을 겪고 계시는군요. 사람과의 관계는 정말 복잡하죠.",
                            "주변 사람들과의 관계에서 힘든 일이 있으셨나요? 마음이 상하셨을 것 같아요.",
                            "소중한 사람과의 관계에 문제가 생기면 정말 힘들죠. 어떤 상황이신가요?",
                            "사람들과의 관계에서 소외감이나 외로움을 느끼고 계시는 것 같아요.",
                            "갈등이나 오해로 인해 관계가 어려워진 것 같아요. 마음이 많이 아프실 거예요."
                        ],
                        middle: [
                            "어떤 관계에서 가장 큰 어려움을 느끼시나요? 가족, 친구, 동료 중에서요?",
                            "그 사람과의 관계에서 어떤 부분이 가장 힘드시나요?",
                            "서로 다른 생각이나 가치관 때문에 갈등이 생기는 건가요?",
                            "소통에서 어려움을 느끼시나요? 말이 잘 통하지 않는 느낌이신가요?",
                            "그 관계를 개선하기 위해 어떤 노력들을 해보셨나요?"
                        ],
                        deep: [
                            "건강한 관계를 유지하는 것에 대해 어떻게 생각하세요?",
                            "경계를 설정하는 것이 필요한 관계는 아닌가요?",
                            "그 사람과의 관계에서 당신이 진정 원하는 것은 무엇인가요?",
                            "관계 개선을 위해 전문적인 상담을 받아보는 것은 어떨까요?",
                            "혹은 그 관계를 정리하는 것도 하나의 선택일 수 있어요. 어떻게 생각하세요?"
                        ]
                    },
                    work_school: {
                        opening: [
                            "직장이나 학교에서 힘든 일이 있으셨군요. 정말 스트레스받으셨을 것 같아요.",
                            "업무나 학업 부담이 크게 느껴지고 계시는 것 같아요.",
                            "직장/학교 환경에서 어려움을 겪고 계시는군요. 어떤 상황인가요?",
                            "성과나 평가에 대한 압박감이 크신 것 같아요.",
                            "진로나 미래에 대한 고민이 많으신 것 같아요. 마음이 복잡하시겠어요."
                        ],
                        middle: [
                            "가장 큰 스트레스 요인이 업무량인가요, 아니면 인간관계인가요?",
                            "현재 상황이 언제부터 시작되었나요? 특별한 변화가 있었나요?",
                            "동료나 상사, 선생님과의 관계는 어떠신가요?",
                            "일과 삶의 균형을 맞추기 어려우신가요?",
                            "이런 상황이 개선될 가능성이 있다고 보시나요?"
                        ],
                        deep: [
                            "현재 하고 계신 일이 당신의 가치관과 맞다고 생각하세요?",
                            "장기적인 커리어 계획이나 목표가 있으신가요?",
                            "환경을 바꾸는 것(이직, 전학 등)을 고려해보셨나요?",
                            "스트레스 관리나 시간 관리 기술을 배워보시는 건 어떨까요?",
                            "전문적인 커리어 상담을 받아보시는 것도 도움이 될 것 같아요."
                        ]
                    },
                    physical: {
                        opening: [
                            "신체적으로도 힘드신 것 같아요. 몸과 마음은 서로 연결되어 있거든요.",
                            "몸의 증상들이 마음의 상태와도 관련이 있을 수 있어요.",
                            "신체적인 불편함이 일상에 많은 영향을 미치고 계시는군요.",
                            "몸이 아프면 마음도 더욱 힘들어지죠. 어떤 증상이 가장 괴로우신가요?",
                            "건강 문제로 인한 스트레스도 상당하실 것 같아요."
                        ],
                        middle: [
                            "이런 증상들이 언제부터 시작되었나요? 스트레스와 관련이 있을까요?",
                            "병원 진료는 받아보셨나요? 전문의 소견은 어떠셨나요?",
                            "증상이 일상생활에 어떤 영향을 미치고 있나요?",
                            "수면 패턴이나 식습관에 변화가 있으셨나요?",
                            "규칙적인 운동이나 생활 관리는 하고 계시나요?"
                        ],
                        deep: [
                            "스트레스나 감정 상태가 신체 증상에 영향을 미치고 있다고 생각하세요?",
                            "심리적인 부분과 신체 증상을 함께 관리하는 것이 필요할 것 같아요.",
                            "생활 습관 개선을 통해 나아질 수 있는 부분이 있을까요?",
                            "통합적인 건강 관리 방법에 대해 관심이 있으신가요?",
                            "필요하다면 정신건강의학과 상담도 도움이 될 수 있어요."
                        ]
                    },
                    loneliness: {
                        opening: [
                            "외로움을 많이 느끼고 계시는군요. 그런 마음이 얼마나 힘든지 이해해요.",
                            "혼자라는 느낌이 크게 다가오고 있는 것 같아요. 정말 쓸쓸하시겠어요.",
                            "사람들과 단절된 느낌을 받고 계시는 것 같아요. 마음이 많이 아프실 거예요.",
                            "소속감이나 연결감을 느끼기 어려우신 상황인 것 같아요.",
                            "고립감이 깊어지고 있는 것 같아요. 누군가와 진정한 소통이 그리우시죠?"
                        ],
                        middle: [
                            "언제부터 이런 외로움을 느끼기 시작하셨나요?",
                            "주변에 사람들이 있어도 외로움을 느끼시나요?",
                            "진정으로 이해해주는 사람이 필요하신 것 같아요. 그런 사람이 있나요?",
                            "새로운 사람들을 만나기 어려운 상황인가요?",
                            "외로울 때 보통 어떻게 시간을 보내시나요?"
                        ],
                        deep: [
                            "의미 있는 관계를 만들어가는 것에 대해 어떻게 생각하세요?",
                            "혼자만의 시간과 외로움은 다른 것 같아요. 어떻게 느끼시나요?",
                            "사회적 활동이나 모임에 참여해보시는 건 어떨까요?",
                            "온라인에서라도 비슷한 관심사를 가진 사람들과 교류해보셨나요?",
                            "전문 상담을 통해 관계 형성에 대해 도움받아보시는 것은 어떨까요?"
                        ]
                    },
                    self_esteem: {
                        opening: [
                            "자신에 대해 부정적으로 생각하고 계시는 것 같아요. 마음이 많이 아프시겠어요.",
                            "자존감이 많이 낮아져 있는 상태인 것 같아요. 스스로를 힘들게 하고 계시는군요.",
                            "자신을 너무 혹독하게 대하고 계시는 것 같아요. 조금 더 따뜻하게 바라봐주세요.",
                            "자기 자신에 대한 신뢰나 믿음이 흔들리고 있는 것 같아요.",
                            "다른 사람들과 비교하며 스스로를 평가절하하고 계시는 것 같아요."
                        ],
                        middle: [
                            "언제부터 자신에 대해 이렇게 부정적으로 생각하게 되셨나요?",
                            "특별한 사건이나 경험이 자존감에 영향을 미쳤나요?",
                            "자신의 장점이나 잘하는 것들을 인정하기 어려우신가요?",
                            "다른 사람들의 평가나 시선을 많이 의식하시나요?",
                            "완벽하지 않으면 가치가 없다고 느끼시나요?"
                        ],
                        deep: [
                            "자신에게 친구처럼 따뜻하게 말해주는 연습을 해보시는 건 어떨까요?",
                            "작은 성취나 노력들도 인정하고 칭찬해주시나요?",
                            "자존감 회복을 위한 구체적인 방법들을 함께 찾아보면 어떨까요?",
                            "자기 수용과 자기 사랑에 대해 어떻게 생각하세요?",
                            "자존감 향상을 위한 전문적인 도움을 받아보시는 것도 좋을 것 같아요."
                        ]
                    },
                    fear: {
                        opening: [
                            "두려움이나 공포감을 느끼고 계시는군요. 그런 감정이 얼마나 힘든지 알아요.",
                            "무서운 마음이 크게 다가오고 있는 것 같아요. 불안하고 떨리시겠어요.",
                            "미지의 것들에 대한 두려움이 있으신 것 같아요. 자연스러운 반응이에요.",
                            "어떤 상황이나 결과에 대한 공포감이 느껴지시는군요.",
                            "걱정과 두려움이 일상을 지배하고 있는 것 같아요."
                        ],
                        middle: [
                            "구체적으로 어떤 것이 가장 두려우신가요?",
                            "이런 두려움이 언제부터 시작되었나요?",
                            "두려운 상황을 피하게 되시나요?",
                            "두려움 때문에 하지 못하는 일들이 있나요?",
                            "과거에 비슷한 경험이 있으셨나요?"
                        ],
                        deep: [
                            "이 두려움이 실제로 일어날 가능성은 얼마나 될까요?",
                            "두려움을 극복하기 위해 시도해볼 수 있는 작은 단계들이 있을까요?",
                            "용기를 내서 두려움과 마주해본 경험이 있나요?",
                            "두려움 관리에 대한 전문적인 도움이 필요할 것 같아요.",
                            "점진적인 노출이나 인지치료가 도움이 될 수 있어요."
                        ]
                    },
                    general: {
                        opening: [
                            "지금 마음이 어떠신지 잘 들어보겠습니다. 편하게 말씀해주세요.",
                            "현재 상황이 쉽지 않으신 것 같아요. 어떤 부분이 가장 힘드신가요?",
                            "말씀해주신 내용을 통해 많은 고민이 있으시다는 걸 느낄 수 있어요.",
                            "지금 느끼시는 감정들이 복잡하실 것 같아요. 하나씩 풀어가보죠.",
                            "이렇게 솔직하게 이야기해주셔서 감사해요. 함께 생각해보겠습니다."
                        ],
                        middle: [
                            "이런 상황에서 가장 우선적으로 해결하고 싶은 것이 있나요?",
                            "비슷한 어려움을 겪어본 적이 있으신가요? 그때는 어떻게 해결하셨나요?",
                            "주변에서 도움을 받을 수 있는 사람이 있나요?",
                            "이 문제가 일상생활에 어떤 영향을 미치고 있나요?",
                            "변화를 위해 어떤 노력들을 해보셨나요?"
                        ],
                        deep: [
                            "지금까지의 대화를 통해 어떤 통찰이나 깨달음이 있으셨나요?",
                            "앞으로 어떤 방향으로 나아가고 싶으신가요?",
                            "전문적인 도움이 필요한 부분이 있다고 생각하세요?",
                            "지금 가장 필요한 것이 무엇이라고 생각하시나요?",
                            "작은 변화부터 시작해볼 수 있는 것들이 있을까요?"
                        ]
                    }
                };

                // 상황별 특수 응답 패턴
                const situationalResponses = {
                    crisis: [
                        "지금 정말 힘든 순간을 보내고 계시는군요. 이런 감정을 느끼는 것 자체가 용기 있는 일이에요.",
                        "극도로 어려운 상황에 계시는 것 같아요. 혼자서 견뎌내려 하지 마시고 도움을 요청하세요.",
                        "이런 고통스러운 감정들이 영원히 지속되지는 않을 거예요. 지금은 안전이 가장 중요해요."
                    ],
                    improvement: [
                        "조금씩 나아지고 계시는 것 같아서 다행이에요. 그 변화를 인정해주세요.",
                        "긍정적인 변화가 느껴져요. 지금까지의 노력들이 결실을 맺고 있는 것 같아요.",
                        "회복의 조짐이 보여서 정말 기쁩니다. 계속 이 방향으로 나아가시면 될 것 같아요."
                    ],
                    confusion: [
                        "지금 마음이 많이 복잡하고 혼란스러우신 것 같아요. 그런 감정도 자연스러워요.",
                        "여러 감정이 뒤엉켜 있어서 정리가 안 되시는 것 같아요. 천천히 하나씩 풀어보죠.",
                        "혼란스러운 마음이 느껴져요. 지금은 명확한 답을 찾으려 하지 마시고 그 감정을 인정해주세요."
                    ]
                };

                // 대화 맥락 기반 응답 조절
                const contextualFactors = this.analyzeConversationContext(userMessage, conversationCount);
                
                // 주요 감정 카테고리 결정
                const dominantCategory = this.getDominantEmotionCategory(keywords);
                
                // 응답 선택 로직
                let selectedResponse = this.selectContextualResponse(
                    dominantCategory, 
                    conversationPhase, 
                    contextualFactors, 
                    responses, 
                    situationalResponses
                );

                // 개인화된 후속 질문 생성
                const followUpQuestion = this.generateContextualFollowUp(
                    dominantCategory, 
                    conversationPhase, 
                    contextualFactors,
                    conversationCount
                );

                // 격려나 지지 메시지 추가 (경우에 따라)
                const supportMessage = this.generateSupportMessage(contextualFactors, conversationCount);

                // 최종 응답 구성
                let finalResponse = selectedResponse;
                if (followUpQuestion) {
                    finalResponse += " " + followUpQuestion;
                }
                if (supportMessage && Math.random() > 0.7) { // 30% 확률로 지지 메시지 추가
                    finalResponse += " " + supportMessage;
                }

                return finalResponse;
            }

            /**
             * 대화 단계 결정
             */
            determineConversationPhase(conversationCount) {
                if (conversationCount <= 2) return 'opening';
                else if (conversationCount <= 6) return 'middle';
                else return 'deep';
            }

            /**
             * 주요 감정 카테고리 결정
             */
            getDominantEmotionCategory(keywords) {
                if (Object.keys(keywords).length === 0) return 'general';
                
                // 키워드 빈도에 따른 가중치 계산
                const categoryWeights = {};
                Object.entries(keywords).forEach(([category, words]) => {
                    categoryWeights[category] = words.length;
                });

                // 가장 높은 가중치를 가진 카테고리 반환
                return Object.entries(categoryWeights)
                    .sort((a, b) => b[1] - a[1])[0][0];
            }

            /**
             * 대화 맥락 분석
             */
            analyzeConversationContext(userMessage, conversationCount) {
                const context = {
                    intensity: this.analyzeEmotionalIntensity(userMessage),
                    urgency: this.detectUrgency(userMessage),
                    progress: this.detectProgress(userMessage),
                    confusion: this.detectConfusion(userMessage),
                    repetition: this.detectRepetition(userMessage, conversationCount),
                    length: userMessage.length > 100 ? 'long' : userMessage.length > 30 ? 'medium' : 'short'
                };
                return context;
            }

            /**
             * 감정 강도 분석
             */
            analyzeEmotionalIntensity(message) {
                const highIntensityWords = [
                    '정말', '너무', '매우', '완전히', '극도로', '심각하게', '절대', '전혀',
                    '죽을것같', '미치겠', '견딜수없', '한계', '최악', '끝', '절망적',
                    '!!!', '!!', '...', 'ㅠㅠ', 'ㅜㅜ', '진짜', '레알'
                ];
                
                const messageLower = message.toLowerCase();
                const intensityScore = highIntensityWords.reduce((score, word) => {
                    return score + (messageLower.includes(word) ? 1 : 0);
                }, 0);
                
                if (intensityScore >= 3) return 'high';
                else if (intensityScore >= 1) return 'medium';
                else return 'low';
            }

            /**
             * 긴급성 감지
             */
            detectUrgency(message) {
                const urgencyKeywords = [
                    '지금당장', '즉시', '빨리', '급하게', '응급', '위급', '위험',
                    '죽고싶', '자해', '자살', '끝내고싶', '더이상못', '한계'
                ];
                
                return urgencyKeywords.some(keyword => 
                    message.toLowerCase().includes(keyword)
                );
            }

            /**
             * 진전/개선 감지
             */
            detectProgress(message) {
                const progressKeywords = [
                    '나아지', '좋아지', '개선', '회복', '극복', '해결', '성공',
                    '발전', '성장', '변화', '희망', '긍정적', '다행', '기쁘'
                ];
                
                return progressKeywords.some(keyword => 
                    message.toLowerCase().includes(keyword)
                );
            }

            /**
             * 혼란 상태 감지
             */
            detectConfusion(message) {
                const confusionKeywords = [
                    '모르겠', '헷갈', '혼란', '복잡', '애매', '불분명', '확실하지않',
                    '어떻게해야', '뭘해야', '어디서부터', '무엇부터', '갈피못잡'
                ];
                
                return confusionKeywords.some(keyword => 
                    message.toLowerCase().includes(keyword)
                );
            }

            /**
             * 반복 패턴 감지
             */
            detectRepetition(message, conversationCount) {
                if (conversationCount < 3) return false;
                
                // 최근 대화에서 비슷한 주제나 키워드가 반복되는지 확인
                const recentHistory = this.conversationState.conversationHistory.slice(-3);
                const currentKeywords = this.extractKeywords(message);
                
                return recentHistory.some(conv => {
                    const prevKeywords = conv.keywords || {};
                    return Object.keys(currentKeywords).some(category => 
                        prevKeywords.hasOwnProperty(category)
                    );
                });
            }

            /**
             * 맥락에 맞는 응답 선택
             */
            selectContextualResponse(category, phase, context, responses, situationalResponses) {
                // 위기 상황 우선 처리
                if (context.urgency) {
                    return this.getRandomResponse(situationalResponses.crisis);
                }
                
                // 진전이 있는 경우
                if (context.progress) {
                    return this.getRandomResponse(situationalResponses.improvement);
                }
                
                // 혼란 상태인 경우
                if (context.confusion) {
                    return this.getRandomResponse(situationalResponses.confusion);
                }
                
                // 일반적인 경우 - 카테고리와 단계에 따른 응답
                const categoryResponses = responses[category] || responses.general;
                const phaseResponses = categoryResponses[phase] || categoryResponses.opening;
                
                return this.getRandomResponse(phaseResponses);
            }

            /**
             * 맥락에 맞는 후속 질문 생성
             */
            generateContextualFollowUp(category, phase, context, conversationCount) {
                // 반복되는 대화에서는 다른 접근
                if (context.repetition) {
                    const alternativeQuestions = [
                        "다른 관점에서 이 문제를 바라볼 수 있을까요?",
                        "이 주제에 대해 계속 이야기하고 싶으신 이유가 있을까요?",
                        "혹시 아직 말씀하지 않으신 중요한 부분이 있나요?",
                        "새로운 시각으로 접근해보면 어떨까요?"
                    ];
                    return this.getRandomResponse(alternativeQuestions);
                }

                // 강도가 높은 감정 상태
                if (context.intensity === 'high') {
                    const intensiveQuestions = [
                        "지금 가장 급하게 해결해야 할 것이 무엇일까요?",
                        "이런 강한 감정을 느끼게 된 구체적인 상황이 있나요?",
                        "지금 당장 필요한 지원이나 도움이 있을까요?",
                        "이 감정의 강도가 10점 만점에 몇 점 정도인가요?"
                    ];
                    return this.getRandomResponse(intensiveQuestions);
                }

                // 대화 단계별 맞춤 질문
                const phaseQuestions = {
                    opening: [
                        "이런 상황이 얼마나 지속되었나요?",
                        "언제부터 이런 감정을 느끼기 시작하셨나요?",
                        "가장 힘든 부분이 어떤 것인가요?",
                        "평소와 다른 점이 있다면 무엇인가요?"
                    ],
                    middle: [
                        "이 문제가 일상생활에 어떤 영향을 미치고 있나요?",
                        "비슷한 경험을 해본 적이 있으신가요?",
                        "주변 사람들은 이 상황을 알고 있나요?",
                        "어떤 부분에서 변화가 필요하다고 생각하세요?"
                    ],
                    deep: [
                        "지금까지 대화를 통해 새롭게 깨달은 것이 있나요?",
                        "앞으로 어떤 방향으로 나아가고 싶으신가요?",
                        "이 경험을 통해 배운 것이 있다면 무엇인가요?",
                        "다음 단계로 무엇을 시도해보고 싶으신가요?"
                    ]
                };

                return this.getRandomResponse(phaseQuestions[phase]);
            }

            /**
             * 지지 메시지 생성
             */
            generateSupportMessage(context, conversationCount) {
                const supportMessages = [
                    "당신의 용기에 박수를 보내드리고 싶어요.",
                    "이렇게 솔직하게 표현해주셔서 정말 감사합니다.",
                    "혼자가 아니라는 것을 기억해주세요.",
                    "지금까지 잘 견뎌내고 계세요.",
                    "변화는 시간이 걸리지만 반드시 가능해요.",
                    "당신의 감정은 모두 소중하고 의미가 있어요.",
                    "완벽하지 않아도 괜찮아요. 있는 그대로도 충분히 가치 있어요.",
                    "작은 걸음이라도 앞으로 나아가고 계시는 거예요."
                ];

                // 대화가 길어질수록 더 개인적인 지지 메시지
                if (conversationCount > 5) {
                    const deepSupportMessages = [
                        "지금까지의 대화를 통해 당신의 진정성이 느껴져요.",
                        "이런 깊은 대화를 나누어주셔서 영광입니다.",
                        "당신의 성찰하는 모습이 정말 인상적이에요.",
                        "함께 이 여정을 걸어가고 있다고 생각해주세요."
                    ];
                    return this.getRandomResponse([...supportMessages, ...deepSupportMessages]);
                }

                return this.getRandomResponse(supportMessages);
            }

            /**
             * 랜덤 응답 선택 (중복 방지 로직 포함)
             */
            getRandomResponse(responseArray) {
                if (!responseArray || responseArray.length === 0) {
                    return "말씀해주신 내용을 깊이 이해하려고 노력하고 있어요.";
                }

                // 최근 사용된 응답 추적 (간단한 중복 방지)
                if (!this.recentResponses) {
                    this.recentResponses = [];
                }

                // 최근 3개 응답과 다른 것 선택
                const availableResponses = responseArray.filter(response => 
                    !this.recentResponses.includes(response)
                );
                
                const selectedResponse = availableResponses.length > 0 
                    ? availableResponses[Math.floor(Math.random() * availableResponses.length)]
                    : responseArray[Math.floor(Math.random() * responseArray.length)];

                // 최근 응답 기록 업데이트
                this.recentResponses.push(selectedResponse);
                if (this.recentResponses.length > 3) {
                    this.recentResponses.shift();
                }

                return selectedResponse;
            }

            /**
             * 시스템 프롬프트 구성
             */
            buildSystemPrompt() {
                return `당신은 전문적인 심리상담사입니다. 다음 지침을 따라주세요:

1. 공감적이고 따뜻한 톤으로 응답하세요
2. 내담자의 감정을 인정하고 검증해주세요
3. 판단하지 말고 경청하는 자세를 유지하세요
4. 적절한 질문을 통해 더 깊은 탐색을 도와주세요
5. 전문적 치료가 필요하다고 판단되면 권유하세요
6. 자해나 자살 위험이 감지되면 즉시 전문기관 연락을 권하세요
7. 응답은 3-5문장으로 간결하게 작성하세요

현재 상담 모드: ${this.session.mode || '대화형 상담'}
주요 감정 테마: ${Array.from(this.conversationState.emotionalThemes).join(', ') || '분석 중'}`;
            }

            /**
             * 대화 컨텍스트 구성
             */
            buildConversationContext() {
                const context = [];
                const recentHistory = this.conversationState.conversationHistory.slice(-6); // 최근 6개 대화만
                
                recentHistory.forEach(conv => {
                    context.push({ role: 'user', content: conv.input });
                    if (conv.response) {
                        context.push({ role: 'assistant', content: conv.response });
                    }
                });
                
                return context;
            }

            /**
             * 상담 모드 선택 처리
             */
            selectMode(mode) {
                this.session.mode = mode;
                this.conversationState.phase = 'conversation';
                
                this.welcomeScreen.style.display = 'none';
                
                if (mode === 'conversation') {
                    this.addSystemMessage("💬 자유 대화 상담 모드를 선택하셨습니다.");
                    this.addBotMessage(
                        "안녕하세요! 편안한 마음으로 현재 상황이나 고민을 자유롭게 말씀해주세요. " +
                        "필요하다면 언제든 표준 심리검사를 제안드릴 수 있습니다.",
                        ["기분이 좋지 않아요", "요즘 힘든 일이 많아요", "스트레스를 많이 받고 있어요", "누군가와 이야기하고 싶어요"]
                    );
                } else {
                    this.addSystemMessage("📋 표준 심리검사 모드를 선택하셨습니다.");
                    this.addBotMessage(
                        "어떤 문제로 검사를 받고 싶으신지 간단히 말씀해주세요. " +
                        "적절한 표준화된 심리검사를 추천해드리겠습니다.",
                        ["우울감이 지속되고 있어요", "불안하고 걱정이 많아요", "스트레스가 심해요", "전반적으로 힘들어요"]
                    );
                }
            }

            /**
             * 메시지 전송 처리
             */
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || this.isTyping) return;

                this.addUserMessage(message);
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                this.sendButton.disabled = true;

                await this.processResponse(message);
                this.sendButton.disabled = false;
            }

            /**
             * 응답 처리 및 다음 단계 결정
             */
            async processResponse(userInput) {
                // 특수 명령어 처리
                if (userInput.toLowerCase().includes('검사') || userInput.toLowerCase().includes('평가')) {
                    if (this.session.mode === 'conversation') {
                        this.addSystemMessage("📋 표준 심리검사로 전환합니다.");
                        this.session.mode = 'assessment';
                        this.determineAssessmentPath(userInput);
                        return;
                    }
                } else if (userInput.toLowerCase().includes('분석') && this.conversationState.conversationHistory.length > 0) {
                    this.provideConversationAnalysis();
                    return;
                } else if (userInput.toLowerCase().includes('종료')) {
                    this.endConversation();
                    return;
                }

                // 감정 및 키워드 분석
                const analysis = this.analyzeSentimentAndEmotion(userInput);
                const keywords = this.extractKeywords(userInput);
                
                // 대화 기록에 추가
                this.conversationState.conversationHistory.push({
                    input: this.anonymizeText(userInput),
                    analysis: analysis,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                });

                // 감정 테마 업데이트
                Object.keys(keywords).forEach(theme => {
                    this.conversationState.emotionalThemes.add(theme);
                });

                // 타이핑 인디케이터 표시
                this.showTypingIndicator();

                try {
                    // AI 응답 생성
                    const aiResponse = await this.callAIAPI(userInput);
                    
                    this.removeTypingIndicator();
                    
                    // 응답을 대화 기록에 추가
                    if (this.conversationState.conversationHistory.length > 0) {
                        this.conversationState.conversationHistory[this.conversationState.conversationHistory.length - 1].response = aiResponse;
                    }
                    
                    this.addBotMessage(aiResponse);
                    
                    // 감정 분석 결과 표시 (키워드가 감지된 경우)
                    if (Object.keys(keywords).length > 0) {
                        setTimeout(() => {
                            this.showEmotionAnalysis(keywords, analysis);
                        }, 1000);
                    }
                    
                    // 위험 상황 감지
                    this.checkForRiskFactors(userInput, keywords);
                    
                    // 정기적 분석 제공 (5회마다)
                    if (this.conversationState.conversationHistory.length % 5 === 0) {
                        setTimeout(() => {
                            this.addSystemMessage("📊 대화 분석을 제공합니다.");
                            this.provideConversationAnalysis();
                        }, 2000);
                    }
                    
                    // 검사 제안 (특정 키워드 반복 시)
                    this.suggestAssessmentIfNeeded(keywords);
                    
                } catch (error) {
                    this.removeTypingIndicator();
                    this.addBotMessage("죄송합니다. 일시적인 문제가 발생했습니다. 다시 말씀해주시겠어요?");
                    console.error('응답 생성 오류:', error);
                }
            }

            /**
             * 위험 요소 감지 및 대응
             */
            checkForRiskFactors(userInput, keywords) {
                const riskKeywords = ['죽고싶', '자살', '자해', '끝내고싶', '사라지고싶', '더이상', '포기'];
                const hasRiskKeywords = riskKeywords.some(keyword => userInput.toLowerCase().includes(keyword));
                
                if (hasRiskKeywords) {
                    setTimeout(() => {
                        this.addSystemMessage("🆘 긴급 상황 감지");
                        this.addBotMessage(
                            "지금 매우 힘든 상황에 계신 것 같습니다. 혼자서 이 모든 것을 감당하지 마세요. " +
                            "전문가의 도움을 받으실 것을 강력히 권합니다.\n\n" +
                            "• 생명의전화: 1393 (24시간)\n" +
                            "• 청소년전화: 1388\n" +
                            "• 정신건강위기상담전화: 1577-0199\n\n" +
                            "당신의 생명은 소중합니다."
                        );
                    }, 500);
                }
            }

            /**
             * 검사 제안 로직
             */
            suggestAssessmentIfNeeded(keywords) {
                const keywordCounts = {};
                
                // 지금까지의 대화에서 키워드 빈도 계산
                this.conversationState.conversationHistory.forEach(conv => {
                    Object.keys(conv.keywords).forEach(category => {
                        keywordCounts[category] = (keywordCounts[category] || 0) + 1;
                    });
                });
                
                // 특정 키워드가 3회 이상 나타나면 검사 제안
                Object.entries(keywordCounts).forEach(([category, count]) => {
                    if (count >= 3 && this.session.mode === 'conversation') {
                        setTimeout(() => {
                            let assessmentName = '';
                            let assessmentType = '';
                            
                            if (category === 'depression') {
                                assessmentName = 'PHQ-9 우울증 선별검사';
                                assessmentType = 'phq9';
                            } else if (category === 'anxiety') {
                                assessmentName = 'GAD-7 불안장애 선별검사';
                                assessmentType = 'gad7';
                            } else if (category === 'stress') {
                                assessmentName = '지각된 스트레스 척도(PSS)';
                                assessmentType = 'stress';
                            }
                            
                            if (assessmentName) {
                                this.addBotMessage(
                                    `대화를 통해 ${category === 'depression' ? '우울감' : category === 'anxiety' ? '불안감' : '스트레스'} 관련 내용이 지속적으로 나타나고 있습니다. ` +
                                    `보다 정확한 평가를 위해 ${assessmentName}를 받아보시는 것은 어떨까요?`,
                                    ["네, 검사를 받아보겠습니다", "아니요, 대화를 계속하겠습니다", "나중에 받아보겠습니다"]
                                );
                            }
                        }, 1500);
                    }
                });
            }

            /**
             * 평가 경로 결정
             */
            determineAssessmentPath(userInput) {
                const userLower = userInput.toLowerCase();
                
                if (this.keywordPatterns.depression.some(keyword => userLower.includes(keyword))) {
                    this.conversationState.currentAssessmentType = 'phq9';
                    this.addSystemMessage("🔍 우울감과 관련된 내용이 감지되었습니다.");
                } else if (this.keywordPatterns.anxiety.some(keyword => userLower.includes(keyword))) {
                    this.conversationState.currentAssessmentType = 'gad7';
                    this.addSystemMessage("🔍 불안감과 관련된 내용이 감지되었습니다.");
                } else {
                    this.conversationState.currentAssessmentType = 'stress';
                    this.addSystemMessage("🔍 전반적인 스트레스 평가를 진행하겠습니다.");
                }

                const assessmentName = this.assessmentData[this.conversationState.currentAssessmentType].name;
                this.addBotMessage(`${assessmentName}를 진행하겠습니다. 각 질문에 솔직하게 답변해주세요.`);

                this.conversationState.phase = 'assessment';
                this.conversationState.currentQuestionIndex = 0;
                this.session.scores[this.conversationState.currentAssessmentType] = [];
                
                setTimeout(() => this.askNextAssessmentQuestion(), 1000);
            }

            /**
             * 다음 평가 질문 제시
             */
            askNextAssessmentQuestion() {
                const assessmentType = this.conversationState.currentAssessmentType;
                const questions = this.assessmentData[assessmentType].questions;
                const currentIndex = this.conversationState.currentQuestionIndex;
                
                if (currentIndex < questions.length) {
                    this.addAssessmentQuestion(
                        questions[currentIndex],
                        currentIndex + 1,
                        questions.length,
                        this.assessmentData[assessmentType].name
                    );
                } else {
                    this.conversationState.phase = 'summary';
                    setTimeout(() => this.provideSummaryAndRecommendations(), 1000);
                }
            }

            /**
             * 평가 질문 UI 생성
             */
            addAssessmentQuestion(question, currentNum, totalNum, assessmentName) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'message bot';
                
                questionDiv.innerHTML = `
                    <div class="avatar bot-avatar">📋</div>
                    <div class="message-bubble">
                        <div class="assessment-card">
                            <div class="assessment-header">
                                <div class="question-number">${currentNum}/${totalNum}</div>
                                <div class="assessment-type">${assessmentName}</div>
                            </div>
                            <div class="question-text">${question}</div>
                            <div class="rating-scale">
                                ${Object.entries(this.scaleDescriptions).map(([score, desc]) => `
                                    <div class="rating-option" onclick="chatbot.selectRating(${score})">
                                        <span class="rating-number">${score}</span>
                                        <span>${desc}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(questionDiv);
                this.scrollToBottom();
            }

            /**
             * 평가 점수 선택 처리
             */
            selectRating(score) {
                const currentQuestionCard = event.target.closest('.assessment-card');
                if (!currentQuestionCard || currentQuestionCard.classList.contains('completed')) {
                    return;
                }
                
                const options = currentQuestionCard.querySelectorAll('.rating-option');
                
                options.forEach(option => option.classList.remove('selected'));
                event.target.closest('.rating-option').classList.add('selected');
                
                this.conversationState.selectedRating = score;
                
                currentQuestionCard.classList.add('completed');
                options.forEach(option => {
                    option.style.pointerEvents = 'none';
                    option.style.opacity = '0.6';
                });
                
                event.target.closest('.rating-option').style.opacity = '1';
                
                setTimeout(() => {
                    this.handleAssessmentResponse(score.toString(), null);
                }, 500);
            }

            /**
             * 평가 응답 처리
             */
            handleAssessmentResponse(userInput, analysis) {
                const score = parseInt(userInput);
                if (isNaN(score) || score < 0 || score > 3) {
                    this.addBotMessage("❌ 0-3 사이의 점수를 선택해주세요.");
                    return;
                }

                const assessmentType = this.conversationState.currentAssessmentType;
                this.session.scores[assessmentType].push(score);
                
                this.conversationState.currentQuestionIndex++;
                setTimeout(() => this.askNextAssessmentQuestion(), 500);
            }

            /**
             * 개인정보 익명화 처리
             */
            anonymizeText(text) {
                const patterns = [
                    { regex: /\b[가-힣]{2,4}\b(?=\s*(?:님|씨|이|가|은|는))/g, replacement: '[이름]' },
                    { regex: /\b\d{2,3}-\d{3,4}-\d{4}\b/g, replacement: '[전화번호]' },
                    { regex: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g, replacement: '[이메일]' },
                    { regex: /\b\d{6}-\d{7}\b/g, replacement: '[주민번호]' }
                ];

                let anonymized = text;
                patterns.forEach(pattern => {
                    anonymized = anonymized.replace(pattern.regex, pattern.replacement);
                });
                return anonymized;
            }

            /**
             * 감정 및 상황 분석
             */
            analyzeSentimentAndEmotion(text) {
                const analysis = {
                    sentiment: this.analyzeSentiment(text),
                    emotions: this.analyzeEmotions(text),
                    confidence: Math.random() * 0.3 + 0.7
                };
                return analysis;
            }

            /**
             * 감정 점수 분석
             */
            analyzeSentiment(text) {
                const positiveWords = ["좋", "행복", "기쁨", "만족", "즐거", "편안", "희망", "사랑"];
                const negativeWords = ["나쁘", "슬프", "화나", "우울", "불안", "걱정", "힘들", "괴로"];
                
                let positiveScore = 0;
                let negativeScore = 0;
                
                const textLower = text.toLowerCase();
                positiveWords.forEach(word => {
                    if (textLower.includes(word)) positiveScore++;
                });
                negativeWords.forEach(word => {
                    if (textLower.includes(word)) negativeScore++;
                });
                
                if (positiveScore > negativeScore) return 'positive';
                else if (negativeScore > positiveScore) return 'negative';
                else return 'neutral';
            }

            /**
             * 세부 감정 분석
             */
            analyzeEmotions(text) {
                const emotions = {};
                const textLower = text.toLowerCase();
                
                Object.entries(this.keywordPatterns).forEach(([emotion, keywords]) => {
                    let score = 0;
                    keywords.forEach(keyword => {
                        if (textLower.includes(keyword)) score++;
                    });
                    if (score > 0) {
                        emotions[emotion] = Math.min(score / keywords.length, 1.0);
                    }
                });
                
                return emotions;
            }

            /**
             * 키워드 추출
             */
            extractKeywords(text) {
                const foundKeywords = {};
                const textLower = text.toLowerCase();
                
                Object.entries(this.keywordPatterns).forEach(([category, keywords]) => {
                    const foundInCategory = keywords.filter(keyword => textLower.includes(keyword));
                    if (foundInCategory.length > 0) {
                        foundKeywords[category] = foundInCategory;
                    }
                });
                
                return foundKeywords;
            }

            /**
             * 감정 분석 결과 표시
             */
            showEmotionAnalysis(keywords, analysis) {
                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'emotion-analysis';
                
                let keywordHtml = '';
                if (Object.keys(keywords).length > 0) {
                    const categoryNames = {
                        depression: "우울감",
                        anxiety: "불안감",
                        stress: "스트레스",
                        anger: "분노감",
                        relationships: "인간관계",
                        work_school: "직장/학업",
                        physical: "신체증상"
                    };
                    
                    keywordHtml = `
                        <div class="keyword-analysis">
                            <h4>🔍 감지된 키워드</h4>
                            <div class="keyword-tags">
                                ${Object.keys(keywords).map(category => 
                                    `<span class="keyword-tag">${categoryNames[category] || category}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }

                analysisDiv.innerHTML = `
                    <h4>💭 감정 분석 결과</h4>
                    <div class="emotion-item">
                        <span>전반적 감정</span>
                        <span>${analysis.sentiment === 'positive' ? '긍정적' : analysis.sentiment === 'negative' ? '부정적' : '중립적'}</span>
                    </div>
                    ${keywordHtml}
                `;
                
                this.chatContainer.appendChild(analysisDiv);
                this.scrollToBottom();
            }

            /**
             * 대화 분석 제공
             */
            provideConversationAnalysis() {
                if (this.conversationState.conversationHistory.length === 0) {
                    this.addBotMessage("아직 분석할 대화 내용이 충분하지 않습니다.");
                    return;
                }

                // 키워드 빈도 분석
                const keywordFrequency = {};
                const emotionalPatterns = [];
                
                this.conversationState.conversationHistory.forEach((conv, index) => {
                    Object.keys(conv.keywords).forEach(category => {
                        keywordFrequency[category] = (keywordFrequency[category] || 0) + 1;
                    });
                    
                    // 감정 패턴 추적
                    if (conv.analysis && conv.analysis.sentiment) {
                        emotionalPatterns.push(conv.analysis.sentiment);
                    }
                });

                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'message bot';
                
                const sortedKeywords = Object.entries(keywordFrequency)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const categoryNames = {
                    depression: "우울감 관련",
                    anxiety: "불안감 관련", 
                    stress: "스트레스 관련",
                    anger: "분노감 관련",
                    relationships: "인간관계 관련",
                    work_school: "직장/학업 관련",
                    physical: "신체적 증상 관련"
                };

                // 감정 변화 분석
                const recentEmotions = emotionalPatterns.slice(-5);
                const emotionalTrend = this.analyzeEmotionalTrend(recentEmotions);

                analysisDiv.innerHTML = `
                    <div class="avatar bot-avatar">📊</div>
                    <div class="message-bubble">
                        <div class="summary-card">
                            <div class="summary-header">
                                <h3>📊 종합 대화 분석</h3>
                            </div>
                            
                            <h4>🔍 주요 관심사 (${this.conversationState.conversationHistory.length}회 대화 기준):</h4>
                            ${sortedKeywords.length > 0 ? sortedKeywords.map(([category, count]) => 
                                `<div class="emotion-item">
                                    <span>${categoryNames[category] || category}</span>
                                    <span>${count}회 언급</span>
                                </div>`
                            ).join('') : '<p>특별한 패턴이 감지되지 않았습니다.</p>'}
                            
                            <h4 style="margin-top: 15px;">💭 감정 상태 변화:</h4>
                            <p>${emotionalTrend}</p>
                            
                            <h4 style="margin-top: 15px;">🎯 주요 발견사항:</h4>
                            ${this.generateInsights(sortedKeywords, emotionalPatterns)}
                            
                            <div style="margin-top: 20px; padding: 15px; background: rgba(79, 172, 254, 0.1); border-radius: 10px;">
                                <p><strong>💡 상담사 소견:</strong> 지속적인 대화를 통해 ${this.conversationState.conversationHistory.length}회의 상호작용을 분석한 결과, 
                                ${sortedKeywords.length > 0 ? `주로 ${categoryNames[sortedKeywords[0][0]]} 영역에서 어려움을 겪고 계신 것으로 보입니다.` : '다양한 주제에 대해 균형잡힌 대화를 나누고 계십니다.'}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(analysisDiv);
                this.scrollToBottom();
            }

            /**
             * 감정 트렌드 분석
             */
            analyzeEmotionalTrend(emotions) {
                if (emotions.length < 3) return "분석을 위한 데이터가 부족합니다.";
                
                const positiveCount = emotions.filter(e => e === 'positive').length;
                const negativeCount = emotions.filter(e => e === 'negative').length;
                const neutralCount = emotions.filter(e => e === 'neutral').length;
                
                if (negativeCount > positiveCount + neutralCount) {
                    return "최근 대화에서 부정적인 감정이 지속적으로 나타나고 있습니다.";
                } else if (positiveCount > negativeCount + neutralCount) {
                    return "최근 대화에서 긍정적인 감정이 증가하는 경향을 보입니다.";
                } else {
                    return "감정 상태가 변화하며 안정적인 패턴을 유지하고 있습니다.";
                }
            }

            /**
             * 인사이트 생성
             */
            generateInsights(sortedKeywords, emotionalPatterns) {
                const insights = [];
                
                if (sortedKeywords.length > 0) {
                    const topCategory = sortedKeywords[0][0];
                    const topCount = sortedKeywords[0][1];
                    
                    if (topCount >= 3) {
                        insights.push(`• ${topCategory === 'depression' ? '우울감' : topCategory === 'anxiety' ? '불안감' : '스트레스'} 관련 주제가 반복적으로 나타나고 있어 주의깊은 관찰이 필요합니다.`);
                    }
                }
                
                if (emotionalPatterns.filter(e => e === 'negative').length > emotionalPatterns.length * 0.7) {
                    insights.push('• 부정적 감정이 지배적으로 나타나고 있어 전문적 지원이 도움될 수 있습니다.');
                }
                
                if (sortedKeywords.some(([cat]) => cat === 'relationships')) {
                    insights.push('• 인간관계 영역에서의 어려움이 감지되었습니다.');
                }
                
                if (insights.length === 0) {
                    insights.push('• 다양한 주제에 대해 균형잡힌 표현을 하고 계십니다.');
                }
                
                return insights.join('<br>');
            }

            /**
             * 결과 요약 및 권장사항 제공
             */
            provideSummaryAndRecommendations() {
                const assessmentType = this.conversationState.currentAssessmentType;
                const scores = this.session.scores[assessmentType];
                const totalScore = scores.reduce((sum, score) => sum + score, 0);
                const interpretation = this.interpretScore(totalScore, assessmentType);
                
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'message bot';
                
                summaryDiv.innerHTML = `
                    <div class="avatar bot-avatar">📋</div>
                    <div class="message-bubble">
                        <div class="summary-card">
                            <div class="summary-header">
                                <h3>📊 평가 결과 및 분석</h3>
                            </div>
                            
                            <div class="score-display">
                                <div class="score-number">${totalScore}</div>
                                <div class="score-interpretation">${this.assessmentData[assessmentType].name}</div>
                                <div style="margin-top: 10px; font-weight: 600; color: #7b1fa2;">
                                    해석: ${interpretation}
                                </div>
                            </div>

                            <div class="recommendations">
                                <h4>💡 권장사항</h4>
                                ${this.generateRecommendations(totalScore, assessmentType)}
                            </div>

                            <div style="margin-top: 20px; padding: 15px; background: rgba(33, 150, 243, 0.1); border-radius: 10px;">
                                <h4 style="color: #1976d2; margin-bottom: 10px;">📚 전문 기관 연락처</h4>
                                <div class="recommendation-item">
                                    <div class="recommendation-icon">📞</div>
                                    <div>
                                        <strong>정신건강복지센터:</strong> 1577-0199<br>
                                        <strong>생명의전화:</strong> 1393<br>
                                        <strong>청소년전화:</strong> 1388
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(summaryDiv);
                this.scrollToBottom();

                // 상담 계속 여부 확인
                setTimeout(() => {
                    this.addBotMessage(
                        "검사 결과를 바탕으로 추가 상담을 계속하시거나, 다른 검사를 받아보실 수 있습니다. 어떻게 도와드릴까요?",
                        ["대화 상담을 계속하겠습니다", "다른 검사도 받아보고 싶어요", "상담을 종료하겠습니다"]
                    );
                    this.conversationState.phase = 'conversation';
                    this.session.mode = 'conversation';
                }, 1000);
            }

            /**
             * 점수 해석
             */
            interpretScore(score, assessmentType) {
                switch (assessmentType) {
                    case 'phq9':
                        if (score <= 4) return "최소 수준의 우울감";
                        else if (score <= 9) return "경미한 우울감";
                        else if (score <= 14) return "중등도 우울감";
                        else if (score <= 19) return "중등도-심한 우울감";
                        else return "심한 우울감";

                    case 'gad7':
                        if (score <= 4) return "최소 수준의 불안감";
                        else if (score <= 9) return "경미한 불안감";
                        else if (score <= 14) return "중등도 불안감";
                        else return "심한 불안감";

                    case 'stress':
                        if (score <= 13) return "낮은 스트레스 수준";
                        else if (score <= 26) return "보통 스트레스 수준";
                        else return "높은 스트레스 수준";

                    default:
                        return "평가 완료";
                }
            }

            /**
             * 맞춤형 권장사항 생성
             */
            generateRecommendations(score, assessmentType) {
                let recommendations = '';

                if (assessmentType === 'phq9' && score >= 10) {
                    recommendations = `
                        <div class="recommendation-item">
                            <div class="recommendation-icon">🏥</div>
                            <div>
                                <strong>중등도 이상의 우울감이 감지되었습니다.</strong><br>
                                전문적인 상담이나 치료를 받으시는 것을 권장드립니다.
                            </div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">🆘</div>
                            <div>
                                <strong>응급상황:</strong> 자해나 자살 생각이 있다면<br>
                                즉시 119 또는 생명의전화(1393)에 연락하세요.
                            </div>
                        </div>
                    `;
                } else if (assessmentType === 'gad7' && score >= 10) {
                    recommendations = `
                        <div class="recommendation-item">
                            <div class="recommendation-icon">😰</div>
                            <div>
                                <strong>중등도 이상의 불안감이 감지되었습니다.</strong><br>
                                이완 기법, 규칙적인 운동, 전문 상담을 고려해보세요.
                            </div>
                        </div>
                    `;
                } else {
                    recommendations = `
                        <div class="recommendation-item">
                            <div class="recommendation-icon">🌱</div>
                            <div><strong>규칙적인 생활 리듬 유지</strong></div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">🏃</div>
                            <div><strong>적절한 운동과 휴식</strong></div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">👥</div>
                            <div><strong>사회적 지지체계 활용</strong></div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">💬</div>
                            <div><strong>필요시 전문가 상담</strong></div>
                        </div>
                    `;
                }

                return recommendations;
            }

            /**
             * 사용자 메시지를 화면에 추가
             */
            addUserMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="avatar user-avatar">👤</div>
                    <div class="message-bubble">${this.escapeHtml(message)}</div>
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * 봇 메시지를 화면에 추가
             */
            addBotMessage(message, quickResponses = []) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                
                let quickResponsesHtml = '';
                if (quickResponses.length > 0) {
                    quickResponsesHtml = `
                        <div class="quick-responses">
                            ${quickResponses.map(response => 
                                `<div class="quick-response" onclick="chatbot.selectQuickResponse('${response}')">${response}</div>`
                            ).join('')}
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    <div class="avatar bot-avatar">🤖</div>
                    <div class="message-bubble">
                        ${this.escapeHtml(message).replace(/\n/g, '<br>')}
                        ${quickResponsesHtml}
                    </div>
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * 시스템 메시지 추가
             */
            addSystemMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div class="avatar system-avatar">📢</div>
                    <div class="message-bubble">${this.escapeHtml(message)}</div>
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * 빠른 응답 선택 처리
             */
            selectQuickResponse(response) {
                this.messageInput.value = response;
                this.sendMessage();
            }

            /**
             * 타이핑 인디케이터 표시
             */
            showTypingIndicator() {
                this.isTyping = true;
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot typing-message';
                typingDiv.innerHTML = `
                    <div class="avatar bot-avatar">🤖</div>
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <span>AI 상담사가 분석 중</span>
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                `;
                this.chatContainer.appendChild(typingDiv);
                this.scrollToBottom();
            }

            /**
             * 타이핑 인디케이터 제거
             */
            removeTypingIndicator() {
                this.isTyping = false;
                const typingMessage = this.chatContainer.querySelector('.typing-message');
                if (typingMessage) {
                    typingMessage.remove();
                }
            }

            /**
             * 상담 종료 처리
             */
            endConversation() {
                this.addSystemMessage("상담을 종료합니다.");
                this.addBotMessage(
                    "🙏 상담에 참여해주셔서 감사합니다.\n" +
                    "🔒 모든 대화 기록이 안전하게 삭제됩니다.\n" +
                    "💚 언제든 다시 도움이 필요하시면 페이지를 새로고침해서 새로운 상담을 시작하세요."
                );
                
                this.messageInput.disabled = true;
                this.sendButton.disabled = true;
                
                setTimeout(() => {
                    this.session = null;
                    console.log('세션 데이터가 안전하게 삭제되었습니다.');
                }, 2000);
            }

            /**
             * 채팅 컨테이너를 맨 아래로 스크롤
             */
            scrollToBottom() {
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }

            /**
             * HTML 이스케이프 처리 (XSS 방지)
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * 비동기 지연 함수
             */
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        /**
         * 전역 변수 및 초기화
         */
        let chatbot;
        document.addEventListener('DOMContentLoaded', () => {
            chatbot = new EnhancedAICounselingChatbot();
        });
    </script>
</body>
</html>
