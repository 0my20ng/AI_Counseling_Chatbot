<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 상담 챗봇 - 전문 심리 상담 시스템</title>
    <style>
        /* =================================
           기본 스타일링 및 리셋
        ================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* =================================
           메인 컨테이너 스타일
        ================================= */
        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 80vh;
            min-height: 600px;
        }

        /* =================================
           설정 패널 스타일
        ================================= */
        .settings-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: none;
        }

        .settings-panel.show {
            display: block;
        }

        .api-config {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .api-config select,
        .api-config input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-config input[type="password"] {
            flex: 1;
            min-width: 200px;
        }

        .save-config-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .save-config-btn:hover {
            background: #3d8bfe;
        }

        .api-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
        }

        .api-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* =================================
           헤더 영역 스타일
        ================================= */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .settings-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .settings-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* 세션 정보 및 상태 표시 */
        .session-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .session-id {
            font-family: monospace;
            opacity: 0.8;
        }

        /* 상태 펄스 애니메이션 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* =================================
           채팅 영역 스타일
        ================================= */
        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 메시지 컨테이너 */
        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.5s ease-in;
        }

        /* 메시지 나타나는 애니메이션 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 사용자 메시지는 오른쪽 정렬 */
        .message.user {
            flex-direction: row-reverse;
        }

        /* 메시지 말풍선 스타일 */
        .message-bubble {
            max-width: 75%;
            padding: 16px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            line-height: 1.5;
        }

        /* 봇 메시지 말풍선 */
        .message.bot .message-bubble {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            border-bottom-left-radius: 6px;
            border: 1px solid #dee2e6;
        }

        /* 사용자 메시지 말풍선 */
        .message.user .message-bubble {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        /* 시스템 메시지 */
        .message.system .message-bubble {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 1px solid #ffeaa7;
            text-align: center;
            max-width: 90%;
            margin: 0 auto;
        }

        /* 아바타 스타일 */
        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .bot-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .system-avatar {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            color: white;
        }

        /* =================================
           특수 UI 컴포넌트 스타일
        ================================= */

        /* 모드 선택 카드 */
        .mode-selection {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .mode-card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .mode-card:hover {
            border-color: #4facfe;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.2);
        }

        .mode-card.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
        }

        .mode-card h3 {
            color: #4facfe;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .mode-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        /* 평가 질문 카드 */
        .assessment-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #4facfe;
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
        }

        /* 완료된 평가 질문 스타일 */
        .assessment-card.completed .rating-option {
            cursor: not-allowed;
        }

        .assessment-card.completed .rating-option.selected {
            opacity: 1 !important;
        }

        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            background: #4facfe;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .assessment-type {
            background: rgba(79, 172, 254, 0.1);
            color: #4facfe;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .question-text {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* 평점 선택 버튼 */
        .rating-scale {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .rating-option {
            flex: 1;
            min-width: 120px;
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            line-height: 1.3;
        }

        .rating-option:hover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.05);
        }

        .rating-option.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-weight: 600;
        }

        .rating-number {
            display: block;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* 감정 분석 결과 표시 */
        .emotion-analysis {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }

        .emotion-analysis h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .emotion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        }

        .emotion-item:last-child {
            border-bottom: none;
        }

        .emotion-bar {
            width: 100px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .emotion-fill {
            height: 100%;
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            transition: width 0.5s ease;
        }

        /* 키워드 분석 */
        .keyword-analysis {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }

        .keyword-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .keyword-tag {
            background: rgba(255, 152, 0, 0.1);
            color: #e65100;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        /* 결과 요약 카드 */
        .summary-card {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 2px solid #9c27b0;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .summary-header h3 {
            color: #7b1fa2;
            font-size: 20px;
        }

        .score-display {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .score-number {
            font-size: 36px;
            font-weight: bold;
            color: #7b1fa2;
            margin-bottom: 5px;
        }

        .score-interpretation {
            color: #666;
            font-size: 14px;
        }

        /* 권장사항 리스트 */
        .recommendations {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .recommendations h4 {
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        .recommendation-icon {
            background: #2196f3;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* 개인정보 보호 공지 */
        .privacy-notice {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: #2e7d32;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 타이핑 인디케이터 */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-style: italic;
            padding: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* 빠른 응답 버튼 */
        .quick-responses {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .quick-response {
            padding: 10px 16px;
            background: rgba(79, 172, 254, 0.1);
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4facfe;
        }

        .quick-response:hover {
            background: rgba(79, 172, 254, 0.2);
            transform: translateY(-2px);
        }

        /* =================================
           입력 영역 스타일
        ================================= */
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            resize: none;
            min-height: 50px;
            max-height: 100px;
        }

        .input-field:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* 환영 화면 */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #4facfe;
        }

        /* =================================
           모바일 반응형 스타일
        ================================= */
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
                margin: 0;
            }
            
            .message-bubble {
                max-width: 85%;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .mode-selection {
                flex-direction: column;
            }

            .mode-card {
                min-width: auto;
            }

            .rating-scale {
                flex-direction: column;
            }

            .rating-option {
                min-width: auto;
            }

            .api-config {
                flex-direction: column;
                align-items: stretch;
            }

            .api-config input[type="password"] {
                min-width: auto;
            }
        }

        /* =================================
           유틸리티 클래스
        ================================= */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- 메인 컨테이너 -->
    <div class="container">
        <!-- 설정 패널 -->
        <div class="settings-panel" id="settingsPanel">
            <div class="api-config">
                <select id="aiProvider">
                    <option value="openai">OpenAI GPT</option>
                    <option value="google">Google Gemini</option>
                    <option value="local">로컬 모델 (무료)</option>
                </select>
                <input type="password" id="apiKey" placeholder="API 키 입력 (선택사항)">
                <button class="save-config-btn" onclick="chatbot.saveApiConfig()">저장</button>
            </div>
            <div class="api-status" id="apiStatus">
                설정을 저장하여 AI 연결을 테스트하세요.
            </div>
        </div>

        <!-- 헤더 영역 -->
        <div class="header">
            <div class="header-content">
                <div>
                    <button class="settings-toggle" onclick="chatbot.toggleSettings()">⚙️ AI 설정</button>
                    <h1>🧠 AI 전문 상담 챗봇</h1>
                    <p>익명 보장 • 자연스러운 대화 • 개인정보 보호</p>
                </div>
                <!-- 세션 정보 -->
                <div class="session-info">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>안전한 연결</span>
                    </div>
                    <div class="session-id" id="sessionId">세션: 로딩중...</div>
                </div>
            </div>
        </div>

        <!-- 채팅 영역 -->
        <div class="chat-container" id="chatContainer">
            <!-- 개인정보 보호 공지 -->
            <div class="privacy-notice">
                🔒 <strong>개인정보 보호</strong>: 모든 대화는 익명화되어 임시 저장되며, 상담 종료 시 자동 삭제됩니다.
            </div>
            
            <!-- 환영 화면 -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-icon">🤝</div>
                <h2>자연스러운 AI 상담사에 오신 것을 환영합니다</h2>
                <p>GPT, Gemini 등 최신 AI 모델을 활용한<br>
                공감적이고 자연스러운 상담을 제공합니다.</p>
                
                <!-- 상담 모드 선택 -->
                <div class="mode-selection mt-20">
                    <div class="mode-card" onclick="chatbot.selectMode('conversation')">
                        <h3>💬 자유 대화 상담</h3>
                        <p>자연스러운 대화를 통한<br>감정 분석 및 상담</p>
                    </div>
                    <div class="mode-card" onclick="chatbot.selectMode('assessment')">
                        <h3>📋 표준 심리검사</h3>
                        <p>PHQ-9, GAD-7, PSS<br>표준화된 평가</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 입력 영역 -->
        <div class="input-container">
            <textarea 
                class="input-field" 
                id="messageInput" 
                placeholder="편안하게 현재 상황이나 고민을 말씀해 주세요..."
                maxlength="1000"
                rows="1"
            ></textarea>
            <button class="send-button" id="sendButton">➤</button>
        </div>
    </div>

    <script>
        /**
         * 향상된 AI 상담 챗봇 클래스 - 자연스러운 AI 응답 연동
         */
        class EnhancedAICounselingChatbot {
            constructor() {
                // DOM 요소들 참조
                this.chatContainer = document.getElementById('chatContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.welcomeScreen = document.getElementById('welcomeScreen');
                this.sessionIdElement = document.getElementById('sessionId');
                this.settingsPanel = document.getElementById('settingsPanel');
                this.apiStatus = document.getElementById('apiStatus');
                
                // AI 설정
                this.aiConfig = {
                    provider: 'local', // 기본값은 로컬 모델
                    apiKey: null,
                    isConnected: false
                };
                
                // 세션 관리
                this.session = {
                    id: this.generateSessionId(),
                    responses: [],
                    scores: {},
                    emotionalProfile: {},
                    conversationSummary: '',
                    createdAt: new Date().toISOString(),
                    mode: null
                };
                
                // 대화 상태 관리
                this.conversationState = {
                    phase: 'greeting',
                    currentAssessmentType: null,
                    currentQuestionIndex: 0,
                    conversationHistory: [],
                    emotionalThemes: new Set(),
                    keyProblems: []
                };
                
                this.isTyping = false;
                
                // 평가 도구 데이터
                this.assessmentData = {
                    phq9: {
                        name: "PHQ-9 우울증 선별검사",
                        questions: [
                            "지난 2주 동안, 일을 하는데 흥미나 즐거움을 거의 느끼지 못했다",
                            "지난 2주 동안, 기분이 가라앉거나, 우울하거나, 절망적이라고 느꼈다",
                            "지난 2주 동안, 잠들기 어렵거나, 자다가 깨거나, 너무 많이 잠을 잤다",
                            "지난 2주 동안, 피곤하다고 느꼈거나 기운이 거의 없었다",
                            "지난 2주 동안, 식욕이 떨어졌거나 너무 많이 먹었다",
                            "지난 2주 동안, 자신이 나쁜 사람이라고 느꼈거나, 실패자라고 느꼈거나, 자신 때문에 자신이나 가족이 불행하게 되었다고 느꼈다",
                            "지난 2주 동안, 신문을 읽거나 텔레비전을 보는 것과 같은 일에 집중하는 것이 어려웠다",
                            "지난 2주 동안, 다른 사람들이 주목할 정도로 평소보다 말과 행동이 느려졌거나, 또는 반대로 평상시보다 많이 움직여서 가만히 앉아 있을 수 없었다",
                            "지난 2주 동안, 자신이 죽는 것이 더 낫다고 생각하거나 자신을 해칠 생각을 했다"
                        ]
                    },
                    gad7: {
                        name: "GAD-7 불안장애 선별검사",
                        questions: [
                            "지난 2주 동안, 초조하거나 불안하거나 조마조마하게 느꼈다",
                            "지난 2주 동안, 걱정하는 것을 멈추거나 조절할 수 없었다",
                            "지난 2주 동안, 여러 가지 것들을 너무 많이 걱정했다",
                            "지난 2주 동안, 편하게 있기가 어려웠다",
                            "지난 2주 동안, 너무 안절부절못해서 가만히 있기가 힘들었다",
                            "지난 2주 동안, 쉽게 짜증이 나거나 성을 잘 냈다",
                            "지난 2주 동안, 무서운 일이 생길 것 같아서 두려웠다"
                        ]
                    },
                    stress: {
                        name: "지각된 스트레스 척도(PSS)",
                        questions: [
                            "최근 한 달 동안, 예상치 못한 일 때문에 기분이 상한 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 인생의 중요한 일들을 조절할 수 없다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 신경이 예민하고 스트레스를 받는다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 자신의 문제들을 성공적으로 다룰 수 있다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 인생이 자신의 뜻대로 되어간다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 어려운 일을 효과적으로 대처할 수 있다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 인생의 중요한 변화들을 통제할 수 있다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 원하는 대로 일이 풀리지 않아 좌절한 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 감정 조절이 어렵다고 느낀 적이 얼마나 자주 있었나요?",
                            "최근 한 달 동안, 생활 속 사건들이 나를 압도한다고 느낀 적이 얼마나 자주 있었나요?"
                        ]
                    }
                };

                // 평가 척도 설명
                this.scaleDescriptions = {
                    0: "전혀 그렇지 않다",
                    1: "며칠 동안 그랬다",
                    2: "일주일 이상 그랬다",
                    3: "거의 매일 그랬다"
                };

                // 키워드 패턴 (감정 및 상황 분석용)
                this.keywordPatterns = {
                    depression: [
                        "우울", "슬픔", "절망", "의욕없", "흥미없", "죽고싶", "허무", "공허", "외로", "혼자",
                        "무가치", "자책", "피곤", "기운없", "무력감", "낙담", "희망없", "실망", "무기력", "눈물"
                    ],
                    anxiety: [
                        "불안", "걱정", "초조", "두려", "긴장", "공포", "떨림", "심장", "숨이막", "공황",
                        "불확실", "예민", "긴박", "긴장감", "근심", "걱정스러움", "압박감", "긴장되", "불편"
                    ],
                    stress: [
                        "스트레스", "압박", "힘들", "버거", "감당", "부담", "피로", "지침", "과로", "번아웃",
                        "피곤", "지치", "소진", "초과근무", "피곤함", "압도", "압도되", "한계", "탈진"
                    ],
                    anger: [
                        "화", "짜증", "분노", "열받", "빡쳐", "속상", "억울", "분한", "성질", "화남",
                        "원망", "불만", "짜증나", "답답", "폭발", "화가치밀", "분개", "성질나", "분노조절"
                    ],
                    relationships: [
                        "가족", "친구", "연인", "동료", "상사", "부모", "자식", "배우자", "갈등", "다툼",
                        "대화단절", "왕따", "단절", "사이멀어짐", "배신", "신뢰문제", "친밀감", "오해", "거절"
                    ],
                    work_school: [
                        "직장", "회사", "학교", "업무", "공부", "시험", "취업", "승진", "성적", "진로",
                        "과제", "평가", "동기부여", "성과압박", "업무량", "졸업", "입시", "경쟁", "시간압박"
                    ],
                    physical: [
                        "아픔", "피로", "수면", "식욕", "두통", "소화", "몸살", "아프", "건강", "병원",
                        "근육통", "허리통증", "피곤함", "피로감", "어지럼", "체력저하", "질병", "약물", "수면장애"
                    ]
                };

                this.initializeSession();
                this.initializeEventListeners();
                this.loadSavedConfig();
            }

            /**
             * 세션 초기화
             */
            initializeSession() {
                this.sessionIdElement.textContent = `세션: ${this.session.id}`;
                console.log('익명 세션 시작:', this.session.id);
            }

            /**
             * 익명 세션 ID 생성
             */
            generateSessionId() {
                const timestamp = Date.now().toString();
                return this.hashString(timestamp).substring(0, 12);
            }

            /**
             * 간단한 해시 함수
             */
            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }

            /**
             * 이벤트 리스너 초기화
             */
            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = this.messageInput.scrollHeight + 'px';
                });
            }

            /**
             * 설정 패널 토글
             */
            toggleSettings() {
                this.settingsPanel.classList.toggle('show');
            }

            /**
             * API 설정 저장
             */
            async saveApiConfig() {
                const provider = document.getElementById('aiProvider').value;
                const apiKey = document.getElementById('apiKey').value;
                
                this.aiConfig.provider = provider;
                this.aiConfig.apiKey = apiKey || null;
                
                // 로컬 스토리지에 저장 (API 키는 세션에만)
                localStorage.setItem('aiProvider', provider);
                if (apiKey) {
                    sessionStorage.setItem('apiKey', apiKey);
                }
                
                // 연결 테스트
                await this.testApiConnection();
            }

            /**
             * 저장된 설정 로드
             */
            loadSavedConfig() {
                const savedProvider = localStorage.getItem('aiProvider');
                const savedApiKey = sessionStorage.getItem('apiKey');
                
                if (savedProvider) {
                    document.getElementById('aiProvider').value = savedProvider;
                    this.aiConfig.provider = savedProvider;
                }
                
                if (savedApiKey) {
                    document.getElementById('apiKey').value = savedApiKey;
                    this.aiConfig.apiKey = savedApiKey;
                    this.testApiConnection();
                }
            }

            /**
             * API 연결 테스트
             */
            async testApiConnection() {
                const statusElement = this.apiStatus;
                
                try {
                    statusElement.className = 'api-status';
                    statusElement.textContent = '연결 테스트 중...';
                    
                    if (this.aiConfig.provider === 'local') {
                        this.aiConfig.isConnected = true;
                        statusElement.className = 'api-status connected';
                        statusElement.textContent = '✅ 로컬 모델 사용 (무료, 제한적 성능)';
                        return;
                    }
                    
                    if (!this.aiConfig.apiKey) {
                        statusElement.className = 'api-status error';
                        statusElement.textContent = '❌ API 키가 필요합니다';
                        return;
                    }
                    
                    // 간단한 테스트 요청
                    const testResponse = await this.callAIAPI("안녕하세요", true);
                    
                    if (testResponse) {
                        this.aiConfig.isConnected = true;
                        statusElement.className = 'api-status connected';
                        statusElement.textContent = `✅ ${this.aiConfig.provider.toUpperCase()} 연결 성공`;
                    } else {
                        throw new Error('API 응답 없음');
                    }
                    
                } catch (error) {
                    this.aiConfig.isConnected = false;
                    statusElement.className = 'api-status error';
                    statusElement.textContent = `❌ 연결 실패: ${error.message}`;
                }
            }

            /**
             * AI API 호출 (OpenAI, Google Gemini 등)
             */
            async callAIAPI(userMessage, isTest = false) {
                if (this.aiConfig.provider === 'local') {
                    return this.generateLocalResponse(userMessage, isTest);
                }
                
                try {
                    if (this.aiConfig.provider === 'openai') {
                        return await this.callOpenAI(userMessage, isTest);
                    } else if (this.aiConfig.provider === 'google') {
                        return await this.callGoogleGemini(userMessage, isTest);
                    }
                } catch (error) {
                    console.error('AI API 호출 실패:', error);
                    // API 실패 시 로컬 모델로 폴백
                    return this.generateLocalResponse(userMessage, isTest);
                }
            }

            /**
             * OpenAI API 호출
             */
            async callOpenAI(userMessage, isTest = false) {
                if (isTest) {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.aiConfig.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{ role: 'user', content: '테스트' }],
                            max_tokens: 50
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return '연결 성공';
                }

                const systemPrompt = this.buildSystemPrompt();
                const conversationContext = this.buildConversationContext();
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.aiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...conversationContext,
                            { role: 'user', content: userMessage }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.choices[0].message.content;
            }

            /**
             * Google Gemini API 호출
             */
            async callGoogleGemini(userMessage, isTest = false) {
                if (isTest) {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.aiConfig.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: '테스트' }] }]
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return '연결 성공';
                }

                const systemPrompt = this.buildSystemPrompt();
                const fullPrompt = `${systemPrompt}\n\n사용자: ${userMessage}\n\n상담사:`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.aiConfig.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }],
                        generationConfig: {
                            maxOutputTokens: 500,
                            temperature: 0.7
                        }
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            /**
             * 로컬 모델 응답 생성 (폴백)
             */
            generateLocalResponse(userMessage, isTest = false) {
                if (isTest) return '로컬 모델 사용';

                const keywords = this.extractKeywords(userMessage);
                const sentiment = this.analyzeSentiment(userMessage);
                
                // 감정 기반 응답 생성
                const responses = {
                    depression: [
                        "힘든 시간을 보내고 계시는군요. 그런 감정을 느끼는 것이 자연스러운 반응이에요.",
                        "우울한 마음이 지속되고 있는 것 같아요. 혼자가 아니라는 것을 기억해주세요.",
                        "지금의 감정이 일시적일 수 있어요. 작은 변화부터 시작해보면 어떨까요?"
                    ],
                    anxiety: [
                        "불안한 마음이 크게 느껴지고 있군요. 천천히 깊게 숨을 쉬어보세요.",
                        "걱정이 많으신 것 같아요. 하나씩 차근차근 해결해나가면 됩니다.",
                        "불안감은 우리 모두가 경험하는 감정이에요. 당신만의 문제가 아닙니다."
                    ],
                    stress: [
                        "많은 스트레스를 받고 계시는 것 같아요. 잠시 휴식이 필요할 수도 있겠네요.",
                        "압박감이 크게 느껴지고 있군요. 우선순위를 정해보시는 것은 어떨까요?",
                        "스트레스 상황에서 벗어나 잠시 자신을 돌보는 시간을 가져보세요."
                    ],
                    general: [
                        "말씀해주신 내용을 잘 들었습니다. 어떤 부분이 가장 힘드신가요?",
                        "현재 상황이 쉽지 않으신 것 같아요. 더 자세히 이야기해주실 수 있을까요?",
                        "그 감정을 느끼는 것이 당연해요. 혼자서 모든 것을 감당하지 마세요."
                    ]
                };

                // 키워드 기반 응답 선택
                const topCategory = Object.keys(keywords)[0];
                let selectedResponses = responses.general;
                
                if (topCategory && responses[topCategory]) {
                    selectedResponses = responses[topCategory];
                }
                
                const randomResponse = selectedResponses[Math.floor(Math.random() * selectedResponses.length)];
                
                // 추가 질문 생성
                const followUpQuestions = [
                    "이런 상황이 언제부터 시작되었나요?",
                    "가장 힘든 순간은 언제인가요?",
                    "누군가와 이야기해본 적이 있나요?",
                    "어떤 도움이 필요하다고 생각하세요?",
                    "평소에 스트레스를 어떻게 해소하시나요?"
                ];
                
                const randomQuestion = followUpQuestions[Math.floor(Math.random() * followUpQuestions.length)];
                
                return `${randomResponse} ${randomQuestion}`;
            }

            /**
             * 시스템 프롬프트 구성
             */
            buildSystemPrompt() {
                return `당신은 전문적인 심리상담사입니다. 다음 지침을 따라주세요:

1. 공감적이고 따뜻한 톤으로 응답하세요
2. 내담자의 감정을 인정하고 검증해주세요
3. 판단하지 말고 경청하는 자세를 유지하세요
4. 적절한 질문을 통해 더 깊은 탐색을 도와주세요
5. 전문적 치료가 필요하다고 판단되면 권유하세요
6. 자해나 자살 위험이 감지되면 즉시 전문기관 연락을 권하세요
7. 응답은 3-5문장으로 간결하게 작성하세요

현재 상담 모드: ${this.session.mode || '대화형 상담'}
주요 감정 테마: ${Array.from(this.conversationState.emotionalThemes).join(', ') || '분석 중'}`;
            }

            /**
             * 대화 컨텍스트 구성
             */
            buildConversationContext() {
                const context = [];
                const recentHistory = this.conversationState.conversationHistory.slice(-6); // 최근 6개 대화만
                
                recentHistory.forEach(conv => {
                    context.push({ role: 'user', content: conv.input });
                    if (conv.response) {
                        context.push({ role: 'assistant', content: conv.response });
                    }
                });
                
                return context;
            }

            /**
             * 상담 모드 선택 처리
             */
            selectMode(mode) {
                this.session.mode = mode;
                this.conversationState.phase = 'conversation';
                
                this.welcomeScreen.style.display = 'none';
                
                if (mode === 'conversation') {
                    this.addSystemMessage("💬 자유 대화 상담 모드를 선택하셨습니다.");
                    this.addBotMessage(
                        "안녕하세요! 편안한 마음으로 현재 상황이나 고민을 자유롭게 말씀해주세요. " +
                        "필요하다면 언제든 표준 심리검사를 제안드릴 수 있습니다.",
                        ["기분이 좋지 않아요", "요즘 힘든 일이 많아요", "스트레스를 많이 받고 있어요", "누군가와 이야기하고 싶어요"]
                    );
                } else {
                    this.addSystemMessage("📋 표준 심리검사 모드를 선택하셨습니다.");
                    this.addBotMessage(
                        "어떤 문제로 검사를 받고 싶으신지 간단히 말씀해주세요. " +
                        "적절한 표준화된 심리검사를 추천해드리겠습니다.",
                        ["우울감이 지속되고 있어요", "불안하고 걱정이 많아요", "스트레스가 심해요", "전반적으로 힘들어요"]
                    );
                }
            }

            /**
             * 메시지 전송 처리
             */
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || this.isTyping) return;

                this.addUserMessage(message);
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                this.sendButton.disabled = true;

                await this.processResponse(message);
                this.sendButton.disabled = false;
            }

            /**
             * 응답 처리 및 다음 단계 결정
             */
            async processResponse(userInput) {
                // 특수 명령어 처리
                if (userInput.toLowerCase().includes('검사') || userInput.toLowerCase().includes('평가')) {
                    if (this.session.mode === 'conversation') {
                        this.addSystemMessage("📋 표준 심리검사로 전환합니다.");
                        this.session.mode = 'assessment';
                        this.determineAssessmentPath(userInput);
                        return;
                    }
                } else if (userInput.toLowerCase().includes('분석') && this.conversationState.conversationHistory.length > 0) {
                    this.provideConversationAnalysis();
                    return;
                } else if (userInput.toLowerCase().includes('종료')) {
                    this.endConversation();
                    return;
                }

                // 감정 및 키워드 분석
                const analysis = this.analyzeSentimentAndEmotion(userInput);
                const keywords = this.extractKeywords(userInput);
                
                // 대화 기록에 추가
                this.conversationState.conversationHistory.push({
                    input: this.anonymizeText(userInput),
                    analysis: analysis,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                });

                // 감정 테마 업데이트
                Object.keys(keywords).forEach(theme => {
                    this.conversationState.emotionalThemes.add(theme);
                });

                // 타이핑 인디케이터 표시
                this.showTypingIndicator();

                try {
                    // AI 응답 생성
                    const aiResponse = await this.callAIAPI(userInput);
                    
                    this.removeTypingIndicator();
                    
                    // 응답을 대화 기록에 추가
                    if (this.conversationState.conversationHistory.length > 0) {
                        this.conversationState.conversationHistory[this.conversationState.conversationHistory.length - 1].response = aiResponse;
                    }
                    
                    this.addBotMessage(aiResponse);
                    
                    // 감정 분석 결과 표시 (키워드가 감지된 경우)
                    if (Object.keys(keywords).length > 0) {
                        setTimeout(() => {
                            this.showEmotionAnalysis(keywords, analysis);
                        }, 1000);
                    }
                    
                    // 위험 상황 감지
                    this.checkForRiskFactors(userInput, keywords);
                    
                    // 정기적 분석 제공 (5회마다)
                    if (this.conversationState.conversationHistory.length % 5 === 0) {
                        setTimeout(() => {
                            this.addSystemMessage("📊 대화 분석을 제공합니다.");
                            this.provideConversationAnalysis();
                        }, 2000);
                    }
                    
                    // 검사 제안 (특정 키워드 반복 시)
                    this.suggestAssessmentIfNeeded(keywords);
                    
                } catch (error) {
                    this.removeTypingIndicator();
                    this.addBotMessage("죄송합니다. 일시적인 문제가 발생했습니다. 다시 말씀해주시겠어요?");
                    console.error('응답 생성 오류:', error);
                }
            }

            /**
             * 위험 요소 감지 및 대응
             */
            checkForRiskFactors(userInput, keywords) {
                const riskKeywords = ['죽고싶', '자살', '자해', '끝내고싶', '사라지고싶', '더이상', '포기'];
                const hasRiskKeywords = riskKeywords.some(keyword => userInput.toLowerCase().includes(keyword));
                
                if (hasRiskKeywords) {
                    setTimeout(() => {
                        this.addSystemMessage("🆘 긴급 상황 감지");
                        this.addBotMessage(
                            "지금 매우 힘든 상황에 계신 것 같습니다. 혼자서 이 모든 것을 감당하지 마세요. " +
                            "전문가의 도움을 받으실 것을 강력히 권합니다.\n\n" +
                            "• 생명의전화: 1393 (24시간)\n" +
                            "• 청소년전화: 1388\n" +
                            "• 정신건강위기상담전화: 1577-0199\n\n" +
                            "당신의 생명은 소중합니다."
                        );
                    }, 500);
                }
            }

            /**
             * 검사 제안 로직
             */
            suggestAssessmentIfNeeded(keywords) {
                const keywordCounts = {};
                
                // 지금까지의 대화에서 키워드 빈도 계산
                this.conversationState.conversationHistory.forEach(conv => {
                    Object.keys(conv.keywords).forEach(category => {
                        keywordCounts[category] = (keywordCounts[category] || 0) + 1;
                    });
                });
                
                // 특정 키워드가 3회 이상 나타나면 검사 제안
                Object.entries(keywordCounts).forEach(([category, count]) => {
                    if (count >= 3 && this.session.mode === 'conversation') {
                        setTimeout(() => {
                            let assessmentName = '';
                            let assessmentType = '';
                            
                            if (category === 'depression') {
                                assessmentName = 'PHQ-9 우울증 선별검사';
                                assessmentType = 'phq9';
                            } else if (category === 'anxiety') {
                                assessmentName = 'GAD-7 불안장애 선별검사';
                                assessmentType = 'gad7';
                            } else if (category === 'stress') {
                                assessmentName = '지각된 스트레스 척도(PSS)';
                                assessmentType = 'stress';
                            }
                            
                            if (assessmentName) {
                                this.addBotMessage(
                                    `대화를 통해 ${category === 'depression' ? '우울감' : category === 'anxiety' ? '불안감' : '스트레스'} 관련 내용이 지속적으로 나타나고 있습니다. ` +
                                    `보다 정확한 평가를 위해 ${assessmentName}를 받아보시는 것은 어떨까요?`,
                                    ["네, 검사를 받아보겠습니다", "아니요, 대화를 계속하겠습니다", "나중에 받아보겠습니다"]
                                );
                            }
                        }, 1500);
                    }
                });
            }

            /**
             * 평가 경로 결정
             */
            determineAssessmentPath(userInput) {
                const userLower = userInput.toLowerCase();
                
                if (this.keywordPatterns.depression.some(keyword => userLower.includes(keyword))) {
                    this.conversationState.currentAssessmentType = 'phq9';
                    this.addSystemMessage("🔍 우울감과 관련된 내용이 감지되었습니다.");
                } else if (this.keywordPatterns.anxiety.some(keyword => userLower.includes(keyword))) {
                    this.conversationState.currentAssessmentType = 'gad7';
                    this.addSystemMessage("🔍 불안감과 관련된 내용이 감지되었습니다.");
                } else {
                    this.conversationState.currentAssessmentType = 'stress';
                    this.addSystemMessage("🔍 전반적인 스트레스 평가를 진행하겠습니다.");
                }

                const assessmentName = this.assessmentData[this.conversationState.currentAssessmentType].name;
                this.addBotMessage(`${assessmentName}를 진행하겠습니다. 각 질문에 솔직하게 답변해주세요.`);

                this.conversationState.phase = 'assessment';
                this.conversationState.currentQuestionIndex = 0;
                this.session.scores[this.conversationState.currentAssessmentType] = [];
                
                setTimeout(() => this.askNextAssessmentQuestion(), 1000);
            }

            /**
             * 다음 평가 질문 제시
             */
            askNextAssessmentQuestion() {
                const assessmentType = this.conversationState.currentAssessmentType;
                const questions = this.assessmentData[assessmentType].questions;
                const currentIndex = this.conversationState.currentQuestionIndex;
                
                if (currentIndex < questions.length) {
                    this.addAssessmentQuestion(
                        questions[currentIndex],
                        currentIndex + 1,
                        questions.length,
                        this.assessmentData[assessmentType].name
                    );
                } else {
                    this.conversationState.phase = 'summary';
                    setTimeout(() => this.provideSummaryAndRecommendations(), 1000);
                }
            }

            /**
             * 평가 질문 UI 생성
             */
            addAssessmentQuestion(question, currentNum, totalNum, assessmentName) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'message bot';
                
                questionDiv.innerHTML = `
                    <div class="avatar bot-avatar">📋</div>
                    <div class="message-bubble">
                        <div class="assessment-card">
                            <div class="assessment-header">
                                <div class="question-number">${currentNum}/${totalNum}</div>
                                <div class="assessment-type">${assessmentName}</div>
                            </div>
                            <div class="question-text">${question}</div>
                            <div class="rating-scale">
                                ${Object.entries(this.scaleDescriptions).map(([score, desc]) => `
                                    <div class="rating-option" onclick="chatbot.selectRating(${score})">
                                        <span class="rating-number">${score}</span>
                                        <span>${desc}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(questionDiv);
                this.scrollToBottom();
            }

            /**
             * 평가 점수 선택 처리
             */
            selectRating(score) {
                const currentQuestionCard = event.target.closest('.assessment-card');
                if (!currentQuestionCard || currentQuestionCard.classList.contains('completed')) {
                    return;
                }
                
                const options = currentQuestionCard.querySelectorAll('.rating-option');
                
                options.forEach(option => option.classList.remove('selected'));
                event.target.closest('.rating-option').classList.add('selected');
                
                this.conversationState.selectedRating = score;
                
                currentQuestionCard.classList.add('completed');
                options.forEach(option => {
                    option.style.pointerEvents = 'none';
                    option.style.opacity = '0.6';
                });
                
                event.target.closest('.rating-option').style.opacity = '1';
                
                setTimeout(() => {
                    this.handleAssessmentResponse(score.toString(), null);
                }, 500);
            }

            /**
             * 평가 응답 처리
             */
            handleAssessmentResponse(userInput, analysis) {
                const score = parseInt(userInput);
                if (isNaN(score) || score < 0 || score > 3) {
                    this.addBotMessage("❌ 0-3 사이의 점수를 선택해주세요.");
                    return;
                }

                const assessmentType = this.conversationState.currentAssessmentType;
                this.session.scores[assessmentType].push(score);
                
                this.conversationState.currentQuestionIndex++;
                setTimeout(() => this.askNextAssessmentQuestion(), 500);
            }

            /**
             * 개인정보 익명화 처리
             */
            anonymizeText(text) {
                const patterns = [
                    { regex: /\b[가-힣]{2,4}\b(?=\s*(?:님|씨|이|가|은|는))/g, replacement: '[이름]' },
                    { regex: /\b\d{2,3}-\d{3,4}-\d{4}\b/g, replacement: '[전화번호]' },
                    { regex: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g, replacement: '[이메일]' },
                    { regex: /\b\d{6}-\d{7}\b/g, replacement: '[주민번호]' }
                ];

                let anonymized = text;
                patterns.forEach(pattern => {
                    anonymized = anonymized.replace(pattern.regex, pattern.replacement);
                });
                return anonymized;
            }

            /**
             * 감정 및 상황 분석
             */
            analyzeSentimentAndEmotion(text) {
                const analysis = {
                    sentiment: this.analyzeSentiment(text),
                    emotions: this.analyzeEmotions(text),
                    confidence: Math.random() * 0.3 + 0.7
                };
                return analysis;
            }

            /**
             * 감정 점수 분석
             */
            analyzeSentiment(text) {
                const positiveWords = ["좋", "행복", "기쁨", "만족", "즐거", "편안", "희망", "사랑"];
                const negativeWords = ["나쁘", "슬프", "화나", "우울", "불안", "걱정", "힘들", "괴로"];
                
                let positiveScore = 0;
                let negativeScore = 0;
                
                const textLower = text.toLowerCase();
                positiveWords.forEach(word => {
                    if (textLower.includes(word)) positiveScore++;
                });
                negativeWords.forEach(word => {
                    if (textLower.includes(word)) negativeScore++;
                });
                
                if (positiveScore > negativeScore) return 'positive';
                else if (negativeScore > positiveScore) return 'negative';
                else return 'neutral';
            }

            /**
             * 세부 감정 분석
             */
            analyzeEmotions(text) {
                const emotions = {};
                const textLower = text.toLowerCase();
                
                Object.entries(this.keywordPatterns).forEach(([emotion, keywords]) => {
                    let score = 0;
                    keywords.forEach(keyword => {
                        if (textLower.includes(keyword)) score++;
                    });
                    if (score > 0) {
                        emotions[emotion] = Math.min(score / keywords.length, 1.0);
                    }
                });
                
                return emotions;
            }

            /**
             * 키워드 추출
             */
            extractKeywords(text) {
                const foundKeywords = {};
                const textLower = text.toLowerCase();
                
                Object.entries(this.keywordPatterns).forEach(([category, keywords]) => {
                    const foundInCategory = keywords.filter(keyword => textLower.includes(keyword));
                    if (foundInCategory.length > 0) {
                        foundKeywords[category] = foundInCategory;
                    }
                });
                
                return foundKeywords;
            }

            /**
             * 감정 분석 결과 표시
             */
            showEmotionAnalysis(keywords, analysis) {
                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'emotion-analysis';
                
                let keywordHtml = '';
                if (Object.keys(keywords).length > 0) {
                    const categoryNames = {
                        depression: "우울감",
                        anxiety: "불안감",
                        stress: "스트레스",
                        anger: "분노감",
                        relationships: "인간관계",
                        work_school: "직장/학업",
                        physical: "신체증상"
                    };
                    
                    keywordHtml = `
                        <div class="keyword-analysis">
                            <h4>🔍 감지된 키워드</h4>
                            <div class="keyword-tags">
                                ${Object.keys(keywords).map(category => 
                                    `<span class="keyword-tag">${categoryNames[category] || category}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }

                analysisDiv.innerHTML = `
                    <h4>💭 감정 분석 결과</h4>
                    <div class="emotion-item">
                        <span>전반적 감정</span>
                        <span>${analysis.sentiment === 'positive' ? '긍정적' : analysis.sentiment === 'negative' ? '부정적' : '중립적'}</span>
                    </div>
                    ${keywordHtml}
                `;
                
                this.chatContainer.appendChild(analysisDiv);
                this.scrollToBottom();
            }

            /**
             * 대화 분석 제공
             */
            provideConversationAnalysis() {
                if (this.conversationState.conversationHistory.length === 0) {
                    this.addBotMessage("아직 분석할 대화 내용이 충분하지 않습니다.");
                    return;
                }

                // 키워드 빈도 분석
                const keywordFrequency = {};
                const emotionalPatterns = [];
                
                this.conversationState.conversationHistory.forEach((conv, index) => {
                    Object.keys(conv.keywords).forEach(category => {
                        keywordFrequency[category] = (keywordFrequency[category] || 0) + 1;
                    });
                    
                    // 감정 패턴 추적
                    if (conv.analysis && conv.analysis.sentiment) {
                        emotionalPatterns.push(conv.analysis.sentiment);
                    }
                });

                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'message bot';
                
                const sortedKeywords = Object.entries(keywordFrequency)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const categoryNames = {
                    depression: "우울감 관련",
                    anxiety: "불안감 관련", 
                    stress: "스트레스 관련",
                    anger: "분노감 관련",
                    relationships: "인간관계 관련",
                    work_school: "직장/학업 관련",
                    physical: "신체적 증상 관련"
                };

                // 감정 변화 분석
                const recentEmotions = emotionalPatterns.slice(-5);
                const emotionalTrend = this.analyzeEmotionalTrend(recentEmotions);

                analysisDiv.innerHTML = `
                    <div class="avatar bot-avatar">📊</div>
                    <div class="message-bubble">
                        <div class="summary-card">
                            <div class="summary-header">
                                <h3>📊 종합 대화 분석</h3>
                            </div>
                            
                            <h4>🔍 주요 관심사 (${this.conversationState.conversationHistory.length}회 대화 기준):</h4>
                            ${sortedKeywords.length > 0 ? sortedKeywords.map(([category, count]) => 
                                `<div class="emotion-item">
                                    <span>${categoryNames[category] || category}</span>
                                    <span>${count}회 언급</span>
                                </div>`
                            ).join('') : '<p>특별한 패턴이 감지되지 않았습니다.</p>'}
                            
                            <h4 style="margin-top: 15px;">💭 감정 상태 변화:</h4>
                            <p>${emotionalTrend}</p>
                            
                            <h4 style="margin-top: 15px;">🎯 주요 발견사항:</h4>
                            ${this.generateInsights(sortedKeywords, emotionalPatterns)}
                            
                            <div style="margin-top: 20px; padding: 15px; background: rgba(79, 172, 254, 0.1); border-radius: 10px;">
                                <p><strong>💡 상담사 소견:</strong> 지속적인 대화를 통해 ${this.conversationState.conversationHistory.length}회의 상호작용을 분석한 결과, 
                                ${sortedKeywords.length > 0 ? `주로 ${categoryNames[sortedKeywords[0][0]]} 영역에서 어려움을 겪고 계신 것으로 보입니다.` : '다양한 주제에 대해 균형잡힌 대화를 나누고 계십니다.'}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(analysisDiv);
                this.scrollToBottom();
            }

            /**
             * 감정 트렌드 분석
             */
            analyzeEmotionalTrend(emotions) {
                if (emotions.length < 3) return "분석을 위한 데이터가 부족합니다.";
                
                const positiveCount = emotions.filter(e => e === 'positive').length;
                const negativeCount = emotions.filter(e => e === 'negative').length;
                const neutralCount = emotions.filter(e => e === 'neutral').length;
                
                if (negativeCount > positiveCount + neutralCount) {
                    return "최근 대화에서 부정적인 감정이 지속적으로 나타나고 있습니다.";
                } else if (positiveCount > negativeCount + neutralCount) {
                    return "최근 대화에서 긍정적인 감정이 증가하는 경향을 보입니다.";
                } else {
                    return "감정 상태가 변화하며 안정적인 패턴을 유지하고 있습니다.";
                }
            }

            /**
             * 인사이트 생성
             */
            generateInsights(sortedKeywords, emotionalPatterns) {
                const insights = [];
                
                if (sortedKeywords.length > 0) {
                    const topCategory = sortedKeywords[0][0];
                    const topCount = sortedKeywords[0][1];
                    
                    if (topCount >= 3) {
                        insights.push(`• ${topCategory === 'depression' ? '우울감' : topCategory === 'anxiety' ? '불안감' : '스트레스'} 관련 주제가 반복적으로 나타나고 있어 주의깊은 관찰이 필요합니다.`);
                    }
                }
                
                if (emotionalPatterns.filter(e => e === 'negative').length > emotionalPatterns.length * 0.7) {
                    insights.push('• 부정적 감정이 지배적으로 나타나고 있어 전문적 지원이 도움될 수 있습니다.');
                }
                
                if (sortedKeywords.some(([cat]) => cat === 'relationships')) {
                    insights.push('• 인간관계 영역에서의 어려움이 감지되었습니다.');
                }
                
                if (insights.length === 0) {
                    insights.push('• 다양한 주제에 대해 균형잡힌 표현을 하고 계십니다.');
                }
                
                return insights.join('<br>');
            }

            /**
             * 결과 요약 및 권장사항 제공
             */
            provideSummaryAndRecommendations() {
                const assessmentType = this.conversationState.currentAssessmentType;
                const scores = this.session.scores[assessmentType];
                const totalScore = scores.reduce((sum, score) => sum + score, 0);
                const interpretation = this.interpretScore(totalScore, assessmentType);
                
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'message bot';
                
                summaryDiv.innerHTML = `
                    <div class="avatar bot-avatar">📋</div>
                    <div class="message-bubble">
                        <div class="summary-card">
                            <div class="summary-header">
                                <h3>📊 평가 결과 및 분석</h3>
                            </div>
                            
                            <div class="score-display">
                                <div class="score-number">${totalScore}</div>
                                <div class="score-interpretation">${this.assessmentData[assessmentType].name}</div>
                                <div style="margin-top: 10px; font-weight: 600; color: #7b1fa2;">
                                    해석: ${interpretation}
                                </div>
                            </div>

                            <div class="recommendations">
                                <h4>💡 권장사항</h4>
                                ${this.generateRecommendations(totalScore, assessmentType)}
                            </div>

                            <div style="margin-top: 20px; padding: 15px; background: rgba(33, 150, 243, 0.1); border-radius: 10px;">
                                <h4 style="color: #1976d2; margin-bottom: 10px;">📚 전문 기관 연락처</h4>
                                <div class="recommendation-item">
                                    <div class="recommendation-icon">📞</div>
                                    <div>
                                        <strong>정신건강복지센터:</strong> 1577-0199<br>
                                        <strong>생명의전화:</strong> 1393<br>
                                        <strong>청소년전화:</strong> 1388
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(summaryDiv);
                this.scrollToBottom();

                // 상담 계속 여부 확인
                setTimeout(() => {
                    this.addBotMessage(
                        "검사 결과를 바탕으로 추가 상담을 계속하시거나, 다른 검사를 받아보실 수 있습니다. 어떻게 도와드릴까요?",
                        ["대화 상담을 계속하겠습니다", "다른 검사도 받아보고 싶어요", "상담을 종료하겠습니다"]
                    );
                    this.conversationState.phase = 'conversation';
                    this.session.mode = 'conversation';
                }, 1000);
            }

            /**
             * 점수 해석
             */
            interpretScore(score, assessmentType) {
                switch (assessmentType) {
                    case 'phq9':
                        if (score <= 4) return "최소 수준의 우울감";
                        else if (score <= 9) return "경미한 우울감";
                        else if (score <= 14) return "중등도 우울감";
                        else if (score <= 19) return "중등도-심한 우울감";
                        else return "심한 우울감";

                    case 'gad7':
                        if (score <= 4) return "최소 수준의 불안감";
                        else if (score <= 9) return "경미한 불안감";
                        else if (score <= 14) return "중등도 불안감";
                        else return "심한 불안감";

                    case 'stress':
                        if (score <= 13) return "낮은 스트레스 수준";
                        else if (score <= 26) return "보통 스트레스 수준";
                        else return "높은 스트레스 수준";

                    default:
                        return "평가 완료";
                }
            }

            /**
             * 맞춤형 권장사항 생성
             */
            generateRecommendations(score, assessmentType) {
                let recommendations = '';

                if (assessmentType === 'phq9' && score >= 10) {
                    recommendations = `
                        <div class="recommendation-item">
                            <div class="recommendation-icon">🏥</div>
                            <div>
                                <strong>중등도 이상의 우울감이 감지되었습니다.</strong><br>
                                전문적인 상담이나 치료를 받으시는 것을 권장드립니다.
                            </div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">🆘</div>
                            <div>
                                <strong>응급상황:</strong> 자해나 자살 생각이 있다면<br>
                                즉시 119 또는 생명의전화(1393)에 연락하세요.
                            </div>
                        </div>
                    `;
                } else if (assessmentType === 'gad7' && score >= 10) {
                    recommendations = `
                        <div class="recommendation-item">
                            <div class="recommendation-icon">😰</div>
                            <div>
                                <strong>중등도 이상의 불안감이 감지되었습니다.</strong><br>
                                이완 기법, 규칙적인 운동, 전문 상담을 고려해보세요.
                            </div>
                        </div>
                    `;
                } else {
                    recommendations = `
                        <div class="recommendation-item">
                            <div class="recommendation-icon">🌱</div>
                            <div><strong>규칙적인 생활 리듬 유지</strong></div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">🏃</div>
                            <div><strong>적절한 운동과 휴식</strong></div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">👥</div>
                            <div><strong>사회적 지지체계 활용</strong></div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">💬</div>
                            <div><strong>필요시 전문가 상담</strong></div>
                        </div>
                    `;
                }

                return recommendations;
            }

            /**
             * 사용자 메시지를 화면에 추가
             */
            addUserMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="avatar user-avatar">👤</div>
                    <div class="message-bubble">${this.escapeHtml(message)}</div>
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * 봇 메시지를 화면에 추가
             */
            addBotMessage(message, quickResponses = []) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                
                let quickResponsesHtml = '';
                if (quickResponses.length > 0) {
                    quickResponsesHtml = `
                        <div class="quick-responses">
                            ${quickResponses.map(response => 
                                `<div class="quick-response" onclick="chatbot.selectQuickResponse('${response}')">${response}</div>`
                            ).join('')}
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    <div class="avatar bot-avatar">🤖</div>
                    <div class="message-bubble">
                        ${this.escapeHtml(message).replace(/\n/g, '<br>')}
                        ${quickResponsesHtml}
                    </div>
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * 시스템 메시지 추가
             */
            addSystemMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div class="avatar system-avatar">📢</div>
                    <div class="message-bubble">${this.escapeHtml(message)}</div>
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * 빠른 응답 선택 처리
             */
            selectQuickResponse(response) {
                this.messageInput.value = response;
                this.sendMessage();
            }

            /**
             * 타이핑 인디케이터 표시
             */
            showTypingIndicator() {
                this.isTyping = true;
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot typing-message';
                typingDiv.innerHTML = `
                    <div class="avatar bot-avatar">🤖</div>
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <span>AI 상담사가 분석 중</span>
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                `;
                this.chatContainer.appendChild(typingDiv);
                this.scrollToBottom();
            }

            /**
             * 타이핑 인디케이터 제거
             */
            removeTypingIndicator() {
                this.isTyping = false;
                const typingMessage = this.chatContainer.querySelector('.typing-message');
                if (typingMessage) {
                    typingMessage.remove();
                }
            }

            /**
             * 상담 종료 처리
             */
            endConversation() {
                this.addSystemMessage("상담을 종료합니다.");
                this.addBotMessage(
                    "🙏 상담에 참여해주셔서 감사합니다.\n" +
                    "🔒 모든 대화 기록이 안전하게 삭제됩니다.\n" +
                    "💚 언제든 다시 도움이 필요하시면 페이지를 새로고침해서 새로운 상담을 시작하세요."
                );
                
                this.messageInput.disabled = true;
                this.sendButton.disabled = true;
                
                setTimeout(() => {
                    this.session = null;
                    console.log('세션 데이터가 안전하게 삭제되었습니다.');
                }, 2000);
            }

            /**
             * 채팅 컨테이너를 맨 아래로 스크롤
             */
            scrollToBottom() {
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }

            /**
             * HTML 이스케이프 처리 (XSS 방지)
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * 비동기 지연 함수
             */
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        /**
         * 전역 변수 및 초기화
         */
        let chatbot;
        document.addEventListener('DOMContentLoaded', () => {
            chatbot = new EnhancedAICounselingChatbot();
        });
    </script>
</body>
</html>
