<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìƒë‹´ ì±—ë´‡ - ì „ë¬¸ ì‹¬ë¦¬ ìƒë‹´ ì‹œìŠ¤í…œ</title>
    <style>
        /* =================================
           ê¸°ë³¸ ìŠ¤íƒ€ì¼ë§ ë° ë¦¬ì…‹
        ================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* =================================
           ë©”ì¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼
        ================================= */
        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 80vh;
            min-height: 600px;
        }

        /* =================================
           ì„¤ì • íŒ¨ë„ ìŠ¤íƒ€ì¼
        ================================= */
        .settings-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: none;
        }

        .settings-panel.show {
            display: block;
        }

        .api-config {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .api-config select,
        .api-config input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-config input[type="password"] {
            flex: 1;
            min-width: 200px;
        }

        .save-config-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .save-config-btn:hover {
            background: #3d8bfe;
        }

        .api-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
        }

        .api-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* =================================
           í—¤ë” ì˜ì—­ ìŠ¤íƒ€ì¼
        ================================= */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .settings-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .settings-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ì„¸ì…˜ ì •ë³´ ë° ìƒíƒœ í‘œì‹œ */
        .session-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .session-id {
            font-family: monospace;
            opacity: 0.8;
        }

        /* ìƒíƒœ í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* =================================
           ì±„íŒ… ì˜ì—­ ìŠ¤íƒ€ì¼
        ================================= */
        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ */
        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.5s ease-in;
        }

        /* ë©”ì‹œì§€ ë‚˜íƒ€ë‚˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬ */
        .message.user {
            flex-direction: row-reverse;
        }

        /* ë©”ì‹œì§€ ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .message-bubble {
            max-width: 75%;
            padding: 16px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            line-height: 1.5;
        }

        /* ë´‡ ë©”ì‹œì§€ ë§í’ì„  */
        .message.bot .message-bubble {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            border-bottom-left-radius: 6px;
            border: 1px solid #dee2e6;
        }

        /* ì‚¬ìš©ì ë©”ì‹œì§€ ë§í’ì„  */
        .message.user .message-bubble {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ */
        .message.system .message-bubble {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 1px solid #ffeaa7;
            text-align: center;
            max-width: 90%;
            margin: 0 auto;
        }

        /* ì•„ë°”íƒ€ ìŠ¤íƒ€ì¼ */
        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .bot-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .system-avatar {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            color: white;
        }

        /* =================================
           íŠ¹ìˆ˜ UI ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼
        ================================= */

        /* ëª¨ë“œ ì„ íƒ ì¹´ë“œ */
        .mode-selection {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .mode-card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .mode-card:hover {
            border-color: #4facfe;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.2);
        }

        .mode-card.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
        }

        .mode-card h3 {
            color: #4facfe;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .mode-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        /* í‰ê°€ ì§ˆë¬¸ ì¹´ë“œ */
        .assessment-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #4facfe;
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
        }

        /* ì™„ë£Œëœ í‰ê°€ ì§ˆë¬¸ ìŠ¤íƒ€ì¼ */
        .assessment-card.completed .rating-option {
            cursor: not-allowed;
        }

        .assessment-card.completed .rating-option.selected {
            opacity: 1 !important;
        }

        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            background: #4facfe;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .assessment-type {
            background: rgba(79, 172, 254, 0.1);
            color: #4facfe;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .question-text {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* í‰ì  ì„ íƒ ë²„íŠ¼ */
        .rating-scale {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .rating-option {
            flex: 1;
            min-width: 120px;
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            line-height: 1.3;
        }

        .rating-option:hover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.05);
        }

        .rating-option.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-weight: 600;
        }

        .rating-number {
            display: block;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* ê°ì • ë¶„ì„ ê²°ê³¼ í‘œì‹œ */
        .emotion-analysis {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }

        .emotion-analysis h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .emotion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        }

        .emotion-item:last-child {
            border-bottom: none;
        }

        .emotion-bar {
            width: 100px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .emotion-fill {
            height: 100%;
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            transition: width 0.5s ease;
        }

        /* í‚¤ì›Œë“œ ë¶„ì„ */
        .keyword-analysis {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }

        .keyword-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .keyword-tag {
            background: rgba(255, 152, 0, 0.1);
            color: #e65100;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        /* ê²°ê³¼ ìš”ì•½ ì¹´ë“œ */
        .summary-card {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 2px solid #9c27b0;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .summary-header h3 {
            color: #7b1fa2;
            font-size: 20px;
        }

        .score-display {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .score-number {
            font-size: 36px;
            font-weight: bold;
            color: #7b1fa2;
            margin-bottom: 5px;
        }

        .score-interpretation {
            color: #666;
            font-size: 14px;
        }

        /* ê¶Œì¥ì‚¬í•­ ë¦¬ìŠ¤íŠ¸ */
        .recommendations {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .recommendations h4 {
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        .recommendation-icon {
            background: #2196f3;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* ê°œì¸ì •ë³´ ë³´í˜¸ ê³µì§€ */
        .privacy-notice {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: #2e7d32;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-style: italic;
            padding: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* ë¹ ë¥¸ ì‘ë‹µ ë²„íŠ¼ */
        .quick-responses {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .quick-response {
            padding: 10px 16px;
            background: rgba(79, 172, 254, 0.1);
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4facfe;
        }

        .quick-response:hover {
            background: rgba(79, 172, 254, 0.2);
            transform: translateY(-2px);
        }

        /* =================================
           ì…ë ¥ ì˜ì—­ ìŠ¤íƒ€ì¼
        ================================= */
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            resize: none;
            min-height: 50px;
            max-height: 100px;
        }

        .input-field:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* í™˜ì˜ í™”ë©´ */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #4facfe;
        }

        /* =================================
           ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼
        ================================= */
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
                margin: 0;
            }
            
            .message-bubble {
                max-width: 85%;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .mode-selection {
                flex-direction: column;
            }

            .mode-card {
                min-width: auto;
            }

            .rating-scale {
                flex-direction: column;
            }

            .rating-option {
                min-width: auto;
            }

            .api-config {
                flex-direction: column;
                align-items: stretch;
            }

            .api-config input[type="password"] {
                min-width: auto;
            }
        }

        /* =================================
           ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤
        ================================= */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container">
        <!-- ì„¤ì • íŒ¨ë„ -->
        <div class="settings-panel" id="settingsPanel">
            <div class="api-config">
                <select id="aiProvider">
                    <option value="openai">OpenAI GPT</option>
                    <option value="google">Google Gemini</option>
                    <option value="local">ë¡œì»¬ ëª¨ë¸ (ë¬´ë£Œ)</option>
                </select>
                <input type="password" id="apiKey" placeholder="API í‚¤ ì…ë ¥ (ì„ íƒì‚¬í•­)">
                <button class="save-config-btn" onclick="chatbot.saveApiConfig()">ì €ì¥</button>
            </div>
            <div class="api-status" id="apiStatus">
                ì„¤ì •ì„ ì €ì¥í•˜ì—¬ AI ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.
            </div>
        </div>

        <!-- í—¤ë” ì˜ì—­ -->
        <div class="header">
            <div class="header-content">
                <div>
                    <button class="settings-toggle" onclick="chatbot.toggleSettings()">âš™ï¸ AI ì„¤ì •</button>
                    <h1>ğŸ§  AI ì „ë¬¸ ìƒë‹´ ì±—ë´‡</h1>
                    <p>ìµëª… ë³´ì¥ â€¢ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” â€¢ ê°œì¸ì •ë³´ ë³´í˜¸</p>
                </div>
                <!-- ì„¸ì…˜ ì •ë³´ -->
                <div class="session-info">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>ì•ˆì „í•œ ì—°ê²°</span>
                    </div>
                    <div class="session-id" id="sessionId">ì„¸ì…˜: ë¡œë”©ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="chat-container" id="chatContainer">
            <!-- ê°œì¸ì •ë³´ ë³´í˜¸ ê³µì§€ -->
            <div class="privacy-notice">
                ğŸ”’ <strong>ê°œì¸ì •ë³´ ë³´í˜¸</strong>: ëª¨ë“  ëŒ€í™”ëŠ” ìµëª…í™”ë˜ì–´ ì„ì‹œ ì €ì¥ë˜ë©°, ìƒë‹´ ì¢…ë£Œ ì‹œ ìë™ ì‚­ì œë©ë‹ˆë‹¤.
            </div>
            
            <!-- í™˜ì˜ í™”ë©´ -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-icon">ğŸ¤</div>
                <h2>ìì—°ìŠ¤ëŸ¬ìš´ AI ìƒë‹´ì‚¬ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
                <p>GPT, Gemini ë“± ìµœì‹  AI ëª¨ë¸ì„ í™œìš©í•œ<br>
                ê³µê°ì ì´ê³  ìì—°ìŠ¤ëŸ¬ìš´ ìƒë‹´ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                
                <!-- ìƒë‹´ ëª¨ë“œ ì„ íƒ -->
                <div class="mode-selection mt-20">
                    <div class="mode-card" onclick="chatbot.selectMode('conversation')">
                        <h3>ğŸ’¬ ììœ  ëŒ€í™” ìƒë‹´</h3>
                        <p>ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ë¥¼ í†µí•œ<br>ê°ì • ë¶„ì„ ë° ìƒë‹´</p>
                    </div>
                    <div class="mode-card" onclick="chatbot.selectMode('assessment')">
                        <h3>ğŸ“‹ í‘œì¤€ ì‹¬ë¦¬ê²€ì‚¬</h3>
                        <p>PHQ-9, GAD-7, PSS<br>í‘œì¤€í™”ëœ í‰ê°€</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="input-container">
            <textarea 
                class="input-field" 
                id="messageInput" 
                placeholder="í¸ì•ˆí•˜ê²Œ í˜„ì¬ ìƒí™©ì´ë‚˜ ê³ ë¯¼ì„ ë§ì”€í•´ ì£¼ì„¸ìš”..."
                maxlength="1000"
                rows="1"
            ></textarea>
            <button class="send-button" id="sendButton">â¤</button>
        </div>
    </div>

    <script>
        /**
         * í–¥ìƒëœ AI ìƒë‹´ ì±—ë´‡ í´ë˜ìŠ¤ - ìì—°ìŠ¤ëŸ¬ìš´ AI ì‘ë‹µ ì—°ë™
         */
        class EnhancedAICounselingChatbot {
            constructor() {
                // DOM ìš”ì†Œë“¤ ì°¸ì¡°
                this.chatContainer = document.getElementById('chatContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.welcomeScreen = document.getElementById('welcomeScreen');
                this.sessionIdElement = document.getElementById('sessionId');
                this.settingsPanel = document.getElementById('settingsPanel');
                this.apiStatus = document.getElementById('apiStatus');
                
                // AI ì„¤ì •
                this.aiConfig = {
                    provider: 'local', // ê¸°ë³¸ê°’ì€ ë¡œì»¬ ëª¨ë¸
                    apiKey: null,
                    isConnected: false
                };
                
                // ì„¸ì…˜ ê´€ë¦¬
                this.session = {
                    id: this.generateSessionId(),
                    responses: [],
                    scores: {},
                    emotionalProfile: {},
                    conversationSummary: '',
                    createdAt: new Date().toISOString(),
                    mode: null
                };
                
                // ëŒ€í™” ìƒíƒœ ê´€ë¦¬
                this.conversationState = {
                    phase: 'greeting',
                    currentAssessmentType: null,
                    currentQuestionIndex: 0,
                    conversationHistory: [],
                    emotionalThemes: new Set(),
                    keyProblems: []
                };
                
                this.isTyping = false;
                
                // í‰ê°€ ë„êµ¬ ë°ì´í„°
                this.assessmentData = {
                    phq9: {
                        name: "PHQ-9 ìš°ìš¸ì¦ ì„ ë³„ê²€ì‚¬",
                        questions: [
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ì¼ì„ í•˜ëŠ”ë° í¥ë¯¸ë‚˜ ì¦ê±°ì›€ì„ ê±°ì˜ ëŠë¼ì§€ ëª»í–ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ê¸°ë¶„ì´ ê°€ë¼ì•‰ê±°ë‚˜, ìš°ìš¸í•˜ê±°ë‚˜, ì ˆë§ì ì´ë¼ê³  ëŠê¼ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ì ë“¤ê¸° ì–´ë µê±°ë‚˜, ìë‹¤ê°€ ê¹¨ê±°ë‚˜, ë„ˆë¬´ ë§ì´ ì ì„ ì¤ë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, í”¼ê³¤í•˜ë‹¤ê³  ëŠê¼ˆê±°ë‚˜ ê¸°ìš´ì´ ê±°ì˜ ì—†ì—ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ì‹ìš•ì´ ë–¨ì–´ì¡Œê±°ë‚˜ ë„ˆë¬´ ë§ì´ ë¨¹ì—ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ìì‹ ì´ ë‚˜ìœ ì‚¬ëŒì´ë¼ê³  ëŠê¼ˆê±°ë‚˜, ì‹¤íŒ¨ìë¼ê³  ëŠê¼ˆê±°ë‚˜, ìì‹  ë•Œë¬¸ì— ìì‹ ì´ë‚˜ ê°€ì¡±ì´ ë¶ˆí–‰í•˜ê²Œ ë˜ì—ˆë‹¤ê³  ëŠê¼ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ì‹ ë¬¸ì„ ì½ê±°ë‚˜ í…”ë ˆë¹„ì „ì„ ë³´ëŠ” ê²ƒê³¼ ê°™ì€ ì¼ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ì–´ë ¤ì› ë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ì£¼ëª©í•  ì •ë„ë¡œ í‰ì†Œë³´ë‹¤ ë§ê³¼ í–‰ë™ì´ ëŠë ¤ì¡Œê±°ë‚˜, ë˜ëŠ” ë°˜ëŒ€ë¡œ í‰ìƒì‹œë³´ë‹¤ ë§ì´ ì›€ì§ì—¬ì„œ ê°€ë§Œíˆ ì•‰ì•„ ìˆì„ ìˆ˜ ì—†ì—ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ìì‹ ì´ ì£½ëŠ” ê²ƒì´ ë” ë‚«ë‹¤ê³  ìƒê°í•˜ê±°ë‚˜ ìì‹ ì„ í•´ì¹  ìƒê°ì„ í–ˆë‹¤"
                        ]
                    },
                    gad7: {
                        name: "GAD-7 ë¶ˆì•ˆì¥ì•  ì„ ë³„ê²€ì‚¬",
                        questions: [
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ì´ˆì¡°í•˜ê±°ë‚˜ ë¶ˆì•ˆí•˜ê±°ë‚˜ ì¡°ë§ˆì¡°ë§ˆí•˜ê²Œ ëŠê¼ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ê±±ì •í•˜ëŠ” ê²ƒì„ ë©ˆì¶”ê±°ë‚˜ ì¡°ì ˆí•  ìˆ˜ ì—†ì—ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ì—¬ëŸ¬ ê°€ì§€ ê²ƒë“¤ì„ ë„ˆë¬´ ë§ì´ ê±±ì •í–ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, í¸í•˜ê²Œ ìˆê¸°ê°€ ì–´ë ¤ì› ë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆëª»í•´ì„œ ê°€ë§Œíˆ ìˆê¸°ê°€ í˜ë“¤ì—ˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ì‰½ê²Œ ì§œì¦ì´ ë‚˜ê±°ë‚˜ ì„±ì„ ì˜ ëƒˆë‹¤",
                            "ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ë¬´ì„œìš´ ì¼ì´ ìƒê¸¸ ê²ƒ ê°™ì•„ì„œ ë‘ë ¤ì› ë‹¤"
                        ]
                    },
                    stress: {
                        name: "ì§€ê°ëœ ìŠ¤íŠ¸ë ˆìŠ¤ ì²™ë„(PSS)",
                        questions: [
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ì˜ˆìƒì¹˜ ëª»í•œ ì¼ ë•Œë¬¸ì— ê¸°ë¶„ì´ ìƒí•œ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?",
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ì¸ìƒì˜ ì¤‘ìš”í•œ ì¼ë“¤ì„ ì¡°ì ˆí•  ìˆ˜ ì—†ë‹¤ê³  ëŠë‚€ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?",
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ì‹ ê²½ì´ ì˜ˆë¯¼í•˜ê³  ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ëŠ”ë‹¤ê³  ëŠë‚€ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?",
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ìì‹ ì˜ ë¬¸ì œë“¤ì„ ì„±ê³µì ìœ¼ë¡œ ë‹¤ë£° ìˆ˜ ìˆë‹¤ê³  ëŠë‚€ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?",
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ì¸ìƒì´ ìì‹ ì˜ ëœ»ëŒ€ë¡œ ë˜ì–´ê°„ë‹¤ê³  ëŠë‚€ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?",
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ì–´ë ¤ìš´ ì¼ì„ íš¨ê³¼ì ìœ¼ë¡œ ëŒ€ì²˜í•  ìˆ˜ ìˆë‹¤ê³  ëŠë‚€ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?",
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ì¸ìƒì˜ ì¤‘ìš”í•œ ë³€í™”ë“¤ì„ í†µì œí•  ìˆ˜ ìˆë‹¤ê³  ëŠë‚€ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?",
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ì›í•˜ëŠ” ëŒ€ë¡œ ì¼ì´ í’€ë¦¬ì§€ ì•Šì•„ ì¢Œì ˆí•œ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?",
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ê°ì • ì¡°ì ˆì´ ì–´ë µë‹¤ê³  ëŠë‚€ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?",
                            "ìµœê·¼ í•œ ë‹¬ ë™ì•ˆ, ìƒí™œ ì† ì‚¬ê±´ë“¤ì´ ë‚˜ë¥¼ ì••ë„í•œë‹¤ê³  ëŠë‚€ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆë‚˜ìš”?"
                        ]
                    }
                };

                // í‰ê°€ ì²™ë„ ì„¤ëª…
                this.scaleDescriptions = {
                    0: "ì „í˜€ ê·¸ë ‡ì§€ ì•Šë‹¤",
                    1: "ë©°ì¹  ë™ì•ˆ ê·¸ë¬ë‹¤",
                    2: "ì¼ì£¼ì¼ ì´ìƒ ê·¸ë¬ë‹¤",
                    3: "ê±°ì˜ ë§¤ì¼ ê·¸ë¬ë‹¤"
                };

                // í‚¤ì›Œë“œ íŒ¨í„´ (ê°ì • ë° ìƒí™© ë¶„ì„ìš©)
                this.keywordPatterns = {
                    depression: [
                        "ìš°ìš¸", "ìŠ¬í””", "ì ˆë§", "ì˜ìš•ì—†", "í¥ë¯¸ì—†", "ì£½ê³ ì‹¶", "í—ˆë¬´", "ê³µí—ˆ", "ì™¸ë¡œ", "í˜¼ì",
                        "ë¬´ê°€ì¹˜", "ìì±…", "í”¼ê³¤", "ê¸°ìš´ì—†", "ë¬´ë ¥ê°", "ë‚™ë‹´", "í¬ë§ì—†", "ì‹¤ë§", "ë¬´ê¸°ë ¥", "ëˆˆë¬¼"
                    ],
                    anxiety: [
                        "ë¶ˆì•ˆ", "ê±±ì •", "ì´ˆì¡°", "ë‘ë ¤", "ê¸´ì¥", "ê³µí¬", "ë–¨ë¦¼", "ì‹¬ì¥", "ìˆ¨ì´ë§‰", "ê³µí™©",
                        "ë¶ˆí™•ì‹¤", "ì˜ˆë¯¼", "ê¸´ë°•", "ê¸´ì¥ê°", "ê·¼ì‹¬", "ê±±ì •ìŠ¤ëŸ¬ì›€", "ì••ë°•ê°", "ê¸´ì¥ë˜", "ë¶ˆí¸"
                    ],
                    stress: [
                        "ìŠ¤íŠ¸ë ˆìŠ¤", "ì••ë°•", "í˜ë“¤", "ë²„ê±°", "ê°ë‹¹", "ë¶€ë‹´", "í”¼ë¡œ", "ì§€ì¹¨", "ê³¼ë¡œ", "ë²ˆì•„ì›ƒ",
                        "í”¼ê³¤", "ì§€ì¹˜", "ì†Œì§„", "ì´ˆê³¼ê·¼ë¬´", "í”¼ê³¤í•¨", "ì••ë„", "ì••ë„ë˜", "í•œê³„", "íƒˆì§„"
                    ],
                    anger: [
                        "í™”", "ì§œì¦", "ë¶„ë…¸", "ì—´ë°›", "ë¹¡ì³", "ì†ìƒ", "ì–µìš¸", "ë¶„í•œ", "ì„±ì§ˆ", "í™”ë‚¨",
                        "ì›ë§", "ë¶ˆë§Œ", "ì§œì¦ë‚˜", "ë‹µë‹µ", "í­ë°œ", "í™”ê°€ì¹˜ë°€", "ë¶„ê°œ", "ì„±ì§ˆë‚˜", "ë¶„ë…¸ì¡°ì ˆ"
                    ],
                    relationships: [
                        "ê°€ì¡±", "ì¹œêµ¬", "ì—°ì¸", "ë™ë£Œ", "ìƒì‚¬", "ë¶€ëª¨", "ìì‹", "ë°°ìš°ì", "ê°ˆë“±", "ë‹¤íˆ¼",
                        "ëŒ€í™”ë‹¨ì ˆ", "ì™•ë”°", "ë‹¨ì ˆ", "ì‚¬ì´ë©€ì–´ì§", "ë°°ì‹ ", "ì‹ ë¢°ë¬¸ì œ", "ì¹œë°€ê°", "ì˜¤í•´", "ê±°ì ˆ"
                    ],
                    work_school: [
                        "ì§ì¥", "íšŒì‚¬", "í•™êµ", "ì—…ë¬´", "ê³µë¶€", "ì‹œí—˜", "ì·¨ì—…", "ìŠ¹ì§„", "ì„±ì ", "ì§„ë¡œ",
                        "ê³¼ì œ", "í‰ê°€", "ë™ê¸°ë¶€ì—¬", "ì„±ê³¼ì••ë°•", "ì—…ë¬´ëŸ‰", "ì¡¸ì—…", "ì…ì‹œ", "ê²½ìŸ", "ì‹œê°„ì••ë°•"
                    ],
                    physical: [
                        "ì•„í””", "í”¼ë¡œ", "ìˆ˜ë©´", "ì‹ìš•", "ë‘í†µ", "ì†Œí™”", "ëª¸ì‚´", "ì•„í”„", "ê±´ê°•", "ë³‘ì›",
                        "ê·¼ìœ¡í†µ", "í—ˆë¦¬í†µì¦", "í”¼ê³¤í•¨", "í”¼ë¡œê°", "ì–´ì§€ëŸ¼", "ì²´ë ¥ì €í•˜", "ì§ˆë³‘", "ì•½ë¬¼", "ìˆ˜ë©´ì¥ì• "
                    ]
                };

                this.initializeSession();
                this.initializeEventListeners();
                this.loadSavedConfig();
            }

            /**
             * ì„¸ì…˜ ì´ˆê¸°í™”
             */
            initializeSession() {
                this.sessionIdElement.textContent = `ì„¸ì…˜: ${this.session.id}`;
                console.log('ìµëª… ì„¸ì…˜ ì‹œì‘:', this.session.id);
            }

            /**
             * ìµëª… ì„¸ì…˜ ID ìƒì„±
             */
            generateSessionId() {
                const timestamp = Date.now().toString();
                return this.hashString(timestamp).substring(0, 12);
            }

            /**
             * ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜
             */
            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }

            /**
             * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
             */
            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = this.messageInput.scrollHeight + 'px';
                });
            }

            /**
             * ì„¤ì • íŒ¨ë„ í† ê¸€
             */
            toggleSettings() {
                this.settingsPanel.classList.toggle('show');
            }

            /**
             * API ì„¤ì • ì €ì¥
             */
            async saveApiConfig() {
                const provider = document.getElementById('aiProvider').value;
                const apiKey = document.getElementById('apiKey').value;
                
                this.aiConfig.provider = provider;
                this.aiConfig.apiKey = apiKey || null;
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (API í‚¤ëŠ” ì„¸ì…˜ì—ë§Œ)
                localStorage.setItem('aiProvider', provider);
                if (apiKey) {
                    sessionStorage.setItem('apiKey', apiKey);
                }
                
                // ì—°ê²° í…ŒìŠ¤íŠ¸
                await this.testApiConnection();
            }

            /**
             * ì €ì¥ëœ ì„¤ì • ë¡œë“œ
             */
            loadSavedConfig() {
                const savedProvider = localStorage.getItem('aiProvider');
                const savedApiKey = sessionStorage.getItem('apiKey');
                
                if (savedProvider) {
                    document.getElementById('aiProvider').value = savedProvider;
                    this.aiConfig.provider = savedProvider;
                }
                
                if (savedApiKey) {
                    document.getElementById('apiKey').value = savedApiKey;
                    this.aiConfig.apiKey = savedApiKey;
                    this.testApiConnection();
                }
            }

            /**
             * API ì—°ê²° í…ŒìŠ¤íŠ¸
             */
            async testApiConnection() {
                const statusElement = this.apiStatus;
                
                try {
                    statusElement.className = 'api-status';
                    statusElement.textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
                    
                    if (this.aiConfig.provider === 'local') {
                        this.aiConfig.isConnected = true;
                        statusElement.className = 'api-status connected';
                        statusElement.textContent = 'âœ… ë¡œì»¬ ëª¨ë¸ ì‚¬ìš© (ë¬´ë£Œ, ì œí•œì  ì„±ëŠ¥)';
                        return;
                    }
                    
                    if (!this.aiConfig.apiKey) {
                        statusElement.className = 'api-status error';
                        statusElement.textContent = 'âŒ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤';
                        return;
                    }
                    
                    // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ìš”ì²­
                    const testResponse = await this.callAIAPI("ì•ˆë…•í•˜ì„¸ìš”", true);
                    
                    if (testResponse) {
                        this.aiConfig.isConnected = true;
                        statusElement.className = 'api-status connected';
                        statusElement.textContent = `âœ… ${this.aiConfig.provider.toUpperCase()} ì—°ê²° ì„±ê³µ`;
                    } else {
                        throw new Error('API ì‘ë‹µ ì—†ìŒ');
                    }
                    
                } catch (error) {
                    this.aiConfig.isConnected = false;
                    statusElement.className = 'api-status error';
                    statusElement.textContent = `âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
                }
            }

            /**
             * AI API í˜¸ì¶œ (OpenAI, Google Gemini ë“±)
             */
            async callAIAPI(userMessage, isTest = false) {
                if (this.aiConfig.provider === 'local') {
                    return this.generateLocalResponse(userMessage, isTest);
                }
                
                try {
                    if (this.aiConfig.provider === 'openai') {
                        return await this.callOpenAI(userMessage, isTest);
                    } else if (this.aiConfig.provider === 'google') {
                        return await this.callGoogleGemini(userMessage, isTest);
                    }
                } catch (error) {
                    console.error('AI API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                    // API ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ëª¨ë¸ë¡œ í´ë°±
                    return this.generateLocalResponse(userMessage, isTest);
                }
            }

            /**
             * OpenAI API í˜¸ì¶œ
             */
            async callOpenAI(userMessage, isTest = false) {
                if (isTest) {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.aiConfig.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{ role: 'user', content: 'í…ŒìŠ¤íŠ¸' }],
                            max_tokens: 50
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return 'ì—°ê²° ì„±ê³µ';
                }

                const systemPrompt = this.buildSystemPrompt();
                const conversationContext = this.buildConversationContext();
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.aiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...conversationContext,
                            { role: 'user', content: userMessage }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.choices[0].message.content;
            }

            /**
             * Google Gemini API í˜¸ì¶œ
             */
            async callGoogleGemini(userMessage, isTest = false) {
                if (isTest) {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.aiConfig.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: 'í…ŒìŠ¤íŠ¸' }] }]
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return 'ì—°ê²° ì„±ê³µ';
                }

                const systemPrompt = this.buildSystemPrompt();
                const fullPrompt = `${systemPrompt}\n\nì‚¬ìš©ì: ${userMessage}\n\nìƒë‹´ì‚¬:`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.aiConfig.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }],
                        generationConfig: {
                            maxOutputTokens: 500,
                            temperature: 0.7
                        }
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            /**
             * ë¡œì»¬ ëª¨ë¸ ì‘ë‹µ ìƒì„± (í´ë°±)
             */
            generateLocalResponse(userMessage, isTest = false) {
                if (isTest) return 'ë¡œì»¬ ëª¨ë¸ ì‚¬ìš©';

                const keywords = this.extractKeywords(userMessage);
                const sentiment = this.analyzeSentiment(userMessage);
                
                // ê°ì • ê¸°ë°˜ ì‘ë‹µ ìƒì„±
                const responses = {
                    depression: [
                        "í˜ë“  ì‹œê°„ì„ ë³´ë‚´ê³  ê³„ì‹œëŠ”êµ°ìš”. ê·¸ëŸ° ê°ì •ì„ ëŠë¼ëŠ” ê²ƒì´ ìì—°ìŠ¤ëŸ¬ìš´ ë°˜ì‘ì´ì—ìš”.",
                        "ìš°ìš¸í•œ ë§ˆìŒì´ ì§€ì†ë˜ê³  ìˆëŠ” ê²ƒ ê°™ì•„ìš”. í˜¼ìê°€ ì•„ë‹ˆë¼ëŠ” ê²ƒì„ ê¸°ì–µí•´ì£¼ì„¸ìš”.",
                        "ì§€ê¸ˆì˜ ê°ì •ì´ ì¼ì‹œì ì¼ ìˆ˜ ìˆì–´ìš”. ì‘ì€ ë³€í™”ë¶€í„° ì‹œì‘í•´ë³´ë©´ ì–´ë–¨ê¹Œìš”?"
                    ],
                    anxiety: [
                        "ë¶ˆì•ˆí•œ ë§ˆìŒì´ í¬ê²Œ ëŠê»´ì§€ê³  ìˆêµ°ìš”. ì²œì²œíˆ ê¹Šê²Œ ìˆ¨ì„ ì‰¬ì–´ë³´ì„¸ìš”.",
                        "ê±±ì •ì´ ë§ìœ¼ì‹  ê²ƒ ê°™ì•„ìš”. í•˜ë‚˜ì”© ì°¨ê·¼ì°¨ê·¼ í•´ê²°í•´ë‚˜ê°€ë©´ ë©ë‹ˆë‹¤.",
                        "ë¶ˆì•ˆê°ì€ ìš°ë¦¬ ëª¨ë‘ê°€ ê²½í—˜í•˜ëŠ” ê°ì •ì´ì—ìš”. ë‹¹ì‹ ë§Œì˜ ë¬¸ì œê°€ ì•„ë‹™ë‹ˆë‹¤."
                    ],
                    stress: [
                        "ë§ì€ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ê³  ê³„ì‹œëŠ” ê²ƒ ê°™ì•„ìš”. ì ì‹œ íœ´ì‹ì´ í•„ìš”í•  ìˆ˜ë„ ìˆê² ë„¤ìš”.",
                        "ì••ë°•ê°ì´ í¬ê²Œ ëŠê»´ì§€ê³  ìˆêµ°ìš”. ìš°ì„ ìˆœìœ„ë¥¼ ì •í•´ë³´ì‹œëŠ” ê²ƒì€ ì–´ë–¨ê¹Œìš”?",
                        "ìŠ¤íŠ¸ë ˆìŠ¤ ìƒí™©ì—ì„œ ë²—ì–´ë‚˜ ì ì‹œ ìì‹ ì„ ëŒë³´ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”."
                    ],
                    general: [
                        "ë§ì”€í•´ì£¼ì‹  ë‚´ìš©ì„ ì˜ ë“¤ì—ˆìŠµë‹ˆë‹¤. ì–´ë–¤ ë¶€ë¶„ì´ ê°€ì¥ í˜ë“œì‹ ê°€ìš”?",
                        "í˜„ì¬ ìƒí™©ì´ ì‰½ì§€ ì•Šìœ¼ì‹  ê²ƒ ê°™ì•„ìš”. ë” ìì„¸íˆ ì´ì•¼ê¸°í•´ì£¼ì‹¤ ìˆ˜ ìˆì„ê¹Œìš”?",
                        "ê·¸ ê°ì •ì„ ëŠë¼ëŠ” ê²ƒì´ ë‹¹ì—°í•´ìš”. í˜¼ìì„œ ëª¨ë“  ê²ƒì„ ê°ë‹¹í•˜ì§€ ë§ˆì„¸ìš”."
                    ]
                };

                // í‚¤ì›Œë“œ ê¸°ë°˜ ì‘ë‹µ ì„ íƒ
                const topCategory = Object.keys(keywords)[0];
                let selectedResponses = responses.general;
                
                if (topCategory && responses[topCategory]) {
                    selectedResponses = responses[topCategory];
                }
                
                const randomResponse = selectedResponses[Math.floor(Math.random() * selectedResponses.length)];
                
                // ì¶”ê°€ ì§ˆë¬¸ ìƒì„±
                const followUpQuestions = [
                    "ì´ëŸ° ìƒí™©ì´ ì–¸ì œë¶€í„° ì‹œì‘ë˜ì—ˆë‚˜ìš”?",
                    "ê°€ì¥ í˜ë“  ìˆœê°„ì€ ì–¸ì œì¸ê°€ìš”?",
                    "ëˆ„êµ°ê°€ì™€ ì´ì•¼ê¸°í•´ë³¸ ì ì´ ìˆë‚˜ìš”?",
                    "ì–´ë–¤ ë„ì›€ì´ í•„ìš”í•˜ë‹¤ê³  ìƒê°í•˜ì„¸ìš”?",
                    "í‰ì†Œì— ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì–´ë–»ê²Œ í•´ì†Œí•˜ì‹œë‚˜ìš”?"
                ];
                
                const randomQuestion = followUpQuestions[Math.floor(Math.random() * followUpQuestions.length)];
                
                return `${randomResponse} ${randomQuestion}`;
            }

            /**
             * ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
             */
            buildSystemPrompt() {
                return `ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ì‹¬ë¦¬ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ì§€ì¹¨ì„ ë”°ë¼ì£¼ì„¸ìš”:

1. ê³µê°ì ì´ê³  ë”°ëœ»í•œ í†¤ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”
2. ë‚´ë‹´ìì˜ ê°ì •ì„ ì¸ì •í•˜ê³  ê²€ì¦í•´ì£¼ì„¸ìš”
3. íŒë‹¨í•˜ì§€ ë§ê³  ê²½ì²­í•˜ëŠ” ìì„¸ë¥¼ ìœ ì§€í•˜ì„¸ìš”
4. ì ì ˆí•œ ì§ˆë¬¸ì„ í†µí•´ ë” ê¹Šì€ íƒìƒ‰ì„ ë„ì™€ì£¼ì„¸ìš”
5. ì „ë¬¸ì  ì¹˜ë£Œê°€ í•„ìš”í•˜ë‹¤ê³  íŒë‹¨ë˜ë©´ ê¶Œìœ í•˜ì„¸ìš”
6. ìí•´ë‚˜ ìì‚´ ìœ„í—˜ì´ ê°ì§€ë˜ë©´ ì¦‰ì‹œ ì „ë¬¸ê¸°ê´€ ì—°ë½ì„ ê¶Œí•˜ì„¸ìš”
7. ì‘ë‹µì€ 3-5ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”

í˜„ì¬ ìƒë‹´ ëª¨ë“œ: ${this.session.mode || 'ëŒ€í™”í˜• ìƒë‹´'}
ì£¼ìš” ê°ì • í…Œë§ˆ: ${Array.from(this.conversationState.emotionalThemes).join(', ') || 'ë¶„ì„ ì¤‘'}`;
            }

            /**
             * ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
             */
            buildConversationContext() {
                const context = [];
                const recentHistory = this.conversationState.conversationHistory.slice(-6); // ìµœê·¼ 6ê°œ ëŒ€í™”ë§Œ
                
                recentHistory.forEach(conv => {
                    context.push({ role: 'user', content: conv.input });
                    if (conv.response) {
                        context.push({ role: 'assistant', content: conv.response });
                    }
                });
                
                return context;
            }

            /**
             * ìƒë‹´ ëª¨ë“œ ì„ íƒ ì²˜ë¦¬
             */
            selectMode(mode) {
                this.session.mode = mode;
                this.conversationState.phase = 'conversation';
                
                this.welcomeScreen.style.display = 'none';
                
                if (mode === 'conversation') {
                    this.addSystemMessage("ğŸ’¬ ììœ  ëŒ€í™” ìƒë‹´ ëª¨ë“œë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.");
                    this.addBotMessage(
                        "ì•ˆë…•í•˜ì„¸ìš”! í¸ì•ˆí•œ ë§ˆìŒìœ¼ë¡œ í˜„ì¬ ìƒí™©ì´ë‚˜ ê³ ë¯¼ì„ ììœ ë¡­ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”. " +
                        "í•„ìš”í•˜ë‹¤ë©´ ì–¸ì œë“  í‘œì¤€ ì‹¬ë¦¬ê²€ì‚¬ë¥¼ ì œì•ˆë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                        ["ê¸°ë¶„ì´ ì¢‹ì§€ ì•Šì•„ìš”", "ìš”ì¦˜ í˜ë“  ì¼ì´ ë§ì•„ìš”", "ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë§ì´ ë°›ê³  ìˆì–´ìš”", "ëˆ„êµ°ê°€ì™€ ì´ì•¼ê¸°í•˜ê³  ì‹¶ì–´ìš”"]
                    );
                } else {
                    this.addSystemMessage("ğŸ“‹ í‘œì¤€ ì‹¬ë¦¬ê²€ì‚¬ ëª¨ë“œë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.");
                    this.addBotMessage(
                        "ì–´ë–¤ ë¬¸ì œë¡œ ê²€ì‚¬ë¥¼ ë°›ê³  ì‹¶ìœ¼ì‹ ì§€ ê°„ë‹¨íˆ ë§ì”€í•´ì£¼ì„¸ìš”. " +
                        "ì ì ˆí•œ í‘œì¤€í™”ëœ ì‹¬ë¦¬ê²€ì‚¬ë¥¼ ì¶”ì²œí•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.",
                        ["ìš°ìš¸ê°ì´ ì§€ì†ë˜ê³  ìˆì–´ìš”", "ë¶ˆì•ˆí•˜ê³  ê±±ì •ì´ ë§ì•„ìš”", "ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì‹¬í•´ìš”", "ì „ë°˜ì ìœ¼ë¡œ í˜ë“¤ì–´ìš”"]
                    );
                }
            }

            /**
             * ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
             */
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || this.isTyping) return;

                this.addUserMessage(message);
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                this.sendButton.disabled = true;

                await this.processResponse(message);
                this.sendButton.disabled = false;
            }

            /**
             * ì‘ë‹µ ì²˜ë¦¬ ë° ë‹¤ìŒ ë‹¨ê³„ ê²°ì •
             */
            async processResponse(userInput) {
                // íŠ¹ìˆ˜ ëª…ë ¹ì–´ ì²˜ë¦¬
                if (userInput.toLowerCase().includes('ê²€ì‚¬') || userInput.toLowerCase().includes('í‰ê°€')) {
                    if (this.session.mode === 'conversation') {
                        this.addSystemMessage("ğŸ“‹ í‘œì¤€ ì‹¬ë¦¬ê²€ì‚¬ë¡œ ì „í™˜í•©ë‹ˆë‹¤.");
                        this.session.mode = 'assessment';
                        this.determineAssessmentPath(userInput);
                        return;
                    }
                } else if (userInput.toLowerCase().includes('ë¶„ì„') && this.conversationState.conversationHistory.length > 0) {
                    this.provideConversationAnalysis();
                    return;
                } else if (userInput.toLowerCase().includes('ì¢…ë£Œ')) {
                    this.endConversation();
                    return;
                }

                // ê°ì • ë° í‚¤ì›Œë“œ ë¶„ì„
                const analysis = this.analyzeSentimentAndEmotion(userInput);
                const keywords = this.extractKeywords(userInput);
                
                // ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
                this.conversationState.conversationHistory.push({
                    input: this.anonymizeText(userInput),
                    analysis: analysis,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                });

                // ê°ì • í…Œë§ˆ ì—…ë°ì´íŠ¸
                Object.keys(keywords).forEach(theme => {
                    this.conversationState.emotionalThemes.add(theme);
                });

                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
                this.showTypingIndicator();

                try {
                    // AI ì‘ë‹µ ìƒì„±
                    const aiResponse = await this.callAIAPI(userInput);
                    
                    this.removeTypingIndicator();
                    
                    // ì‘ë‹µì„ ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€
                    if (this.conversationState.conversationHistory.length > 0) {
                        this.conversationState.conversationHistory[this.conversationState.conversationHistory.length - 1].response = aiResponse;
                    }
                    
                    this.addBotMessage(aiResponse);
                    
                    // ê°ì • ë¶„ì„ ê²°ê³¼ í‘œì‹œ (í‚¤ì›Œë“œê°€ ê°ì§€ëœ ê²½ìš°)
                    if (Object.keys(keywords).length > 0) {
                        setTimeout(() => {
                            this.showEmotionAnalysis(keywords, analysis);
                        }, 1000);
                    }
                    
                    // ìœ„í—˜ ìƒí™© ê°ì§€
                    this.checkForRiskFactors(userInput, keywords);
                    
                    // ì •ê¸°ì  ë¶„ì„ ì œê³µ (5íšŒë§ˆë‹¤)
                    if (this.conversationState.conversationHistory.length % 5 === 0) {
                        setTimeout(() => {
                            this.addSystemMessage("ğŸ“Š ëŒ€í™” ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.");
                            this.provideConversationAnalysis();
                        }, 2000);
                    }
                    
                    // ê²€ì‚¬ ì œì•ˆ (íŠ¹ì • í‚¤ì›Œë“œ ë°˜ë³µ ì‹œ)
                    this.suggestAssessmentIfNeeded(keywords);
                    
                } catch (error) {
                    this.removeTypingIndicator();
                    this.addBotMessage("ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?");
                    console.error('ì‘ë‹µ ìƒì„± ì˜¤ë¥˜:', error);
                }
            }

            /**
             * ìœ„í—˜ ìš”ì†Œ ê°ì§€ ë° ëŒ€ì‘
             */
            checkForRiskFactors(userInput, keywords) {
                const riskKeywords = ['ì£½ê³ ì‹¶', 'ìì‚´', 'ìí•´', 'ëë‚´ê³ ì‹¶', 'ì‚¬ë¼ì§€ê³ ì‹¶', 'ë”ì´ìƒ', 'í¬ê¸°'];
                const hasRiskKeywords = riskKeywords.some(keyword => userInput.toLowerCase().includes(keyword));
                
                if (hasRiskKeywords) {
                    setTimeout(() => {
                        this.addSystemMessage("ğŸ†˜ ê¸´ê¸‰ ìƒí™© ê°ì§€");
                        this.addBotMessage(
                            "ì§€ê¸ˆ ë§¤ìš° í˜ë“  ìƒí™©ì— ê³„ì‹  ê²ƒ ê°™ìŠµë‹ˆë‹¤. í˜¼ìì„œ ì´ ëª¨ë“  ê²ƒì„ ê°ë‹¹í•˜ì§€ ë§ˆì„¸ìš”. " +
                            "ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì‹¤ ê²ƒì„ ê°•ë ¥íˆ ê¶Œí•©ë‹ˆë‹¤.\n\n" +
                            "â€¢ ìƒëª…ì˜ì „í™”: 1393 (24ì‹œê°„)\n" +
                            "â€¢ ì²­ì†Œë…„ì „í™”: 1388\n" +
                            "â€¢ ì •ì‹ ê±´ê°•ìœ„ê¸°ìƒë‹´ì „í™”: 1577-0199\n\n" +
                            "ë‹¹ì‹ ì˜ ìƒëª…ì€ ì†Œì¤‘í•©ë‹ˆë‹¤."
                        );
                    }, 500);
                }
            }

            /**
             * ê²€ì‚¬ ì œì•ˆ ë¡œì§
             */
            suggestAssessmentIfNeeded(keywords) {
                const keywordCounts = {};
                
                // ì§€ê¸ˆê¹Œì§€ì˜ ëŒ€í™”ì—ì„œ í‚¤ì›Œë“œ ë¹ˆë„ ê³„ì‚°
                this.conversationState.conversationHistory.forEach(conv => {
                    Object.keys(conv.keywords).forEach(category => {
                        keywordCounts[category] = (keywordCounts[category] || 0) + 1;
                    });
                });
                
                // íŠ¹ì • í‚¤ì›Œë“œê°€ 3íšŒ ì´ìƒ ë‚˜íƒ€ë‚˜ë©´ ê²€ì‚¬ ì œì•ˆ
                Object.entries(keywordCounts).forEach(([category, count]) => {
                    if (count >= 3 && this.session.mode === 'conversation') {
                        setTimeout(() => {
                            let assessmentName = '';
                            let assessmentType = '';
                            
                            if (category === 'depression') {
                                assessmentName = 'PHQ-9 ìš°ìš¸ì¦ ì„ ë³„ê²€ì‚¬';
                                assessmentType = 'phq9';
                            } else if (category === 'anxiety') {
                                assessmentName = 'GAD-7 ë¶ˆì•ˆì¥ì•  ì„ ë³„ê²€ì‚¬';
                                assessmentType = 'gad7';
                            } else if (category === 'stress') {
                                assessmentName = 'ì§€ê°ëœ ìŠ¤íŠ¸ë ˆìŠ¤ ì²™ë„(PSS)';
                                assessmentType = 'stress';
                            }
                            
                            if (assessmentName) {
                                this.addBotMessage(
                                    `ëŒ€í™”ë¥¼ í†µí•´ ${category === 'depression' ? 'ìš°ìš¸ê°' : category === 'anxiety' ? 'ë¶ˆì•ˆê°' : 'ìŠ¤íŠ¸ë ˆìŠ¤'} ê´€ë ¨ ë‚´ìš©ì´ ì§€ì†ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤. ` +
                                    `ë³´ë‹¤ ì •í™•í•œ í‰ê°€ë¥¼ ìœ„í•´ ${assessmentName}ë¥¼ ë°›ì•„ë³´ì‹œëŠ” ê²ƒì€ ì–´ë–¨ê¹Œìš”?`,
                                    ["ë„¤, ê²€ì‚¬ë¥¼ ë°›ì•„ë³´ê² ìŠµë‹ˆë‹¤", "ì•„ë‹ˆìš”, ëŒ€í™”ë¥¼ ê³„ì†í•˜ê² ìŠµë‹ˆë‹¤", "ë‚˜ì¤‘ì— ë°›ì•„ë³´ê² ìŠµë‹ˆë‹¤"]
                                );
                            }
                        }, 1500);
                    }
                });
            }

            /**
             * í‰ê°€ ê²½ë¡œ ê²°ì •
             */
            determineAssessmentPath(userInput) {
                const userLower = userInput.toLowerCase();
                
                if (this.keywordPatterns.depression.some(keyword => userLower.includes(keyword))) {
                    this.conversationState.currentAssessmentType = 'phq9';
                    this.addSystemMessage("ğŸ” ìš°ìš¸ê°ê³¼ ê´€ë ¨ëœ ë‚´ìš©ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else if (this.keywordPatterns.anxiety.some(keyword => userLower.includes(keyword))) {
                    this.conversationState.currentAssessmentType = 'gad7';
                    this.addSystemMessage("ğŸ” ë¶ˆì•ˆê°ê³¼ ê´€ë ¨ëœ ë‚´ìš©ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    this.conversationState.currentAssessmentType = 'stress';
                    this.addSystemMessage("ğŸ” ì „ë°˜ì ì¸ ìŠ¤íŠ¸ë ˆìŠ¤ í‰ê°€ë¥¼ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.");
                }

                const assessmentName = this.assessmentData[this.conversationState.currentAssessmentType].name;
                this.addBotMessage(`${assessmentName}ë¥¼ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤. ê° ì§ˆë¬¸ì— ì†”ì§í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”.`);

                this.conversationState.phase = 'assessment';
                this.conversationState.currentQuestionIndex = 0;
                this.session.scores[this.conversationState.currentAssessmentType] = [];
                
                setTimeout(() => this.askNextAssessmentQuestion(), 1000);
            }

            /**
             * ë‹¤ìŒ í‰ê°€ ì§ˆë¬¸ ì œì‹œ
             */
            askNextAssessmentQuestion() {
                const assessmentType = this.conversationState.currentAssessmentType;
                const questions = this.assessmentData[assessmentType].questions;
                const currentIndex = this.conversationState.currentQuestionIndex;
                
                if (currentIndex < questions.length) {
                    this.addAssessmentQuestion(
                        questions[currentIndex],
                        currentIndex + 1,
                        questions.length,
                        this.assessmentData[assessmentType].name
                    );
                } else {
                    this.conversationState.phase = 'summary';
                    setTimeout(() => this.provideSummaryAndRecommendations(), 1000);
                }
            }

            /**
             * í‰ê°€ ì§ˆë¬¸ UI ìƒì„±
             */
            addAssessmentQuestion(question, currentNum, totalNum, assessmentName) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'message bot';
                
                questionDiv.innerHTML = `
                    <div class="avatar bot-avatar">ğŸ“‹</div>
                    <div class="message-bubble">
                        <div class="assessment-card">
                            <div class="assessment-header">
                                <div class="question-number">${currentNum}/${totalNum}</div>
                                <div class="assessment-type">${assessmentName}</div>
                            </div>
                            <div class="question-text">${question}</div>
                            <div class="rating-scale">
                                ${Object.entries(this.scaleDescriptions).map(([score, desc]) => `
                                    <div class="rating-option" onclick="chatbot.selectRating(${score})">
                                        <span class="rating-number">${score}</span>
                                        <span>${desc}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(questionDiv);
                this.scrollToBottom();
            }

            /**
             * í‰ê°€ ì ìˆ˜ ì„ íƒ ì²˜ë¦¬
             */
            selectRating(score) {
                const currentQuestionCard = event.target.closest('.assessment-card');
                if (!currentQuestionCard || currentQuestionCard.classList.contains('completed')) {
                    return;
                }
                
                const options = currentQuestionCard.querySelectorAll('.rating-option');
                
                options.forEach(option => option.classList.remove('selected'));
                event.target.closest('.rating-option').classList.add('selected');
                
                this.conversationState.selectedRating = score;
                
                currentQuestionCard.classList.add('completed');
                options.forEach(option => {
                    option.style.pointerEvents = 'none';
                    option.style.opacity = '0.6';
                });
                
                event.target.closest('.rating-option').style.opacity = '1';
                
                setTimeout(() => {
                    this.handleAssessmentResponse(score.toString(), null);
                }, 500);
            }

            /**
             * í‰ê°€ ì‘ë‹µ ì²˜ë¦¬
             */
            handleAssessmentResponse(userInput, analysis) {
                const score = parseInt(userInput);
                if (isNaN(score) || score < 0 || score > 3) {
                    this.addBotMessage("âŒ 0-3 ì‚¬ì´ì˜ ì ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                const assessmentType = this.conversationState.currentAssessmentType;
                this.session.scores[assessmentType].push(score);
                
                this.conversationState.currentQuestionIndex++;
                setTimeout(() => this.askNextAssessmentQuestion(), 500);
            }

            /**
             * ê°œì¸ì •ë³´ ìµëª…í™” ì²˜ë¦¬
             */
            anonymizeText(text) {
                const patterns = [
                    { regex: /\b[ê°€-í£]{2,4}\b(?=\s*(?:ë‹˜|ì”¨|ì´|ê°€|ì€|ëŠ”))/g, replacement: '[ì´ë¦„]' },
                    { regex: /\b\d{2,3}-\d{3,4}-\d{4}\b/g, replacement: '[ì „í™”ë²ˆí˜¸]' },
                    { regex: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g, replacement: '[ì´ë©”ì¼]' },
                    { regex: /\b\d{6}-\d{7}\b/g, replacement: '[ì£¼ë¯¼ë²ˆí˜¸]' }
                ];

                let anonymized = text;
                patterns.forEach(pattern => {
                    anonymized = anonymized.replace(pattern.regex, pattern.replacement);
                });
                return anonymized;
            }

            /**
             * ê°ì • ë° ìƒí™© ë¶„ì„
             */
            analyzeSentimentAndEmotion(text) {
                const analysis = {
                    sentiment: this.analyzeSentiment(text),
                    emotions: this.analyzeEmotions(text),
                    confidence: Math.random() * 0.3 + 0.7
                };
                return analysis;
            }

            /**
             * ê°ì • ì ìˆ˜ ë¶„ì„
             */
            analyzeSentiment(text) {
                const positiveWords = ["ì¢‹", "í–‰ë³µ", "ê¸°ì¨", "ë§Œì¡±", "ì¦ê±°", "í¸ì•ˆ", "í¬ë§", "ì‚¬ë‘"];
                const negativeWords = ["ë‚˜ì˜", "ìŠ¬í”„", "í™”ë‚˜", "ìš°ìš¸", "ë¶ˆì•ˆ", "ê±±ì •", "í˜ë“¤", "ê´´ë¡œ"];
                
                let positiveScore = 0;
                let negativeScore = 0;
                
                const textLower = text.toLowerCase();
                positiveWords.forEach(word => {
                    if (textLower.includes(word)) positiveScore++;
                });
                negativeWords.forEach(word => {
                    if (textLower.includes(word)) negativeScore++;
                });
                
                if (positiveScore > negativeScore) return 'positive';
                else if (negativeScore > positiveScore) return 'negative';
                else return 'neutral';
            }

            /**
             * ì„¸ë¶€ ê°ì • ë¶„ì„
             */
            analyzeEmotions(text) {
                const emotions = {};
                const textLower = text.toLowerCase();
                
                Object.entries(this.keywordPatterns).forEach(([emotion, keywords]) => {
                    let score = 0;
                    keywords.forEach(keyword => {
                        if (textLower.includes(keyword)) score++;
                    });
                    if (score > 0) {
                        emotions[emotion] = Math.min(score / keywords.length, 1.0);
                    }
                });
                
                return emotions;
            }

            /**
             * í‚¤ì›Œë“œ ì¶”ì¶œ
             */
            extractKeywords(text) {
                const foundKeywords = {};
                const textLower = text.toLowerCase();
                
                Object.entries(this.keywordPatterns).forEach(([category, keywords]) => {
                    const foundInCategory = keywords.filter(keyword => textLower.includes(keyword));
                    if (foundInCategory.length > 0) {
                        foundKeywords[category] = foundInCategory;
                    }
                });
                
                return foundKeywords;
            }

            /**
             * ê°ì • ë¶„ì„ ê²°ê³¼ í‘œì‹œ
             */
            showEmotionAnalysis(keywords, analysis) {
                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'emotion-analysis';
                
                let keywordHtml = '';
                if (Object.keys(keywords).length > 0) {
                    const categoryNames = {
                        depression: "ìš°ìš¸ê°",
                        anxiety: "ë¶ˆì•ˆê°",
                        stress: "ìŠ¤íŠ¸ë ˆìŠ¤",
                        anger: "ë¶„ë…¸ê°",
                        relationships: "ì¸ê°„ê´€ê³„",
                        work_school: "ì§ì¥/í•™ì—…",
                        physical: "ì‹ ì²´ì¦ìƒ"
                    };
                    
                    keywordHtml = `
                        <div class="keyword-analysis">
                            <h4>ğŸ” ê°ì§€ëœ í‚¤ì›Œë“œ</h4>
                            <div class="keyword-tags">
                                ${Object.keys(keywords).map(category => 
                                    `<span class="keyword-tag">${categoryNames[category] || category}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }

                analysisDiv.innerHTML = `
                    <h4>ğŸ’­ ê°ì • ë¶„ì„ ê²°ê³¼</h4>
                    <div class="emotion-item">
                        <span>ì „ë°˜ì  ê°ì •</span>
                        <span>${analysis.sentiment === 'positive' ? 'ê¸ì •ì ' : analysis.sentiment === 'negative' ? 'ë¶€ì •ì ' : 'ì¤‘ë¦½ì '}</span>
                    </div>
                    ${keywordHtml}
                `;
                
                this.chatContainer.appendChild(analysisDiv);
                this.scrollToBottom();
            }

            /**
             * ëŒ€í™” ë¶„ì„ ì œê³µ
             */
            provideConversationAnalysis() {
                if (this.conversationState.conversationHistory.length === 0) {
                    this.addBotMessage("ì•„ì§ ë¶„ì„í•  ëŒ€í™” ë‚´ìš©ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    return;
                }

                // í‚¤ì›Œë“œ ë¹ˆë„ ë¶„ì„
                const keywordFrequency = {};
                const emotionalPatterns = [];
                
                this.conversationState.conversationHistory.forEach((conv, index) => {
                    Object.keys(conv.keywords).forEach(category => {
                        keywordFrequency[category] = (keywordFrequency[category] || 0) + 1;
                    });
                    
                    // ê°ì • íŒ¨í„´ ì¶”ì 
                    if (conv.analysis && conv.analysis.sentiment) {
                        emotionalPatterns.push(conv.analysis.sentiment);
                    }
                });

                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'message bot';
                
                const sortedKeywords = Object.entries(keywordFrequency)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const categoryNames = {
                    depression: "ìš°ìš¸ê° ê´€ë ¨",
                    anxiety: "ë¶ˆì•ˆê° ê´€ë ¨", 
                    stress: "ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë ¨",
                    anger: "ë¶„ë…¸ê° ê´€ë ¨",
                    relationships: "ì¸ê°„ê´€ê³„ ê´€ë ¨",
                    work_school: "ì§ì¥/í•™ì—… ê´€ë ¨",
                    physical: "ì‹ ì²´ì  ì¦ìƒ ê´€ë ¨"
                };

                // ê°ì • ë³€í™” ë¶„ì„
                const recentEmotions = emotionalPatterns.slice(-5);
                const emotionalTrend = this.analyzeEmotionalTrend(recentEmotions);

                analysisDiv.innerHTML = `
                    <div class="avatar bot-avatar">ğŸ“Š</div>
                    <div class="message-bubble">
                        <div class="summary-card">
                            <div class="summary-header">
                                <h3>ğŸ“Š ì¢…í•© ëŒ€í™” ë¶„ì„</h3>
                            </div>
                            
                            <h4>ğŸ” ì£¼ìš” ê´€ì‹¬ì‚¬ (${this.conversationState.conversationHistory.length}íšŒ ëŒ€í™” ê¸°ì¤€):</h4>
                            ${sortedKeywords.length > 0 ? sortedKeywords.map(([category, count]) => 
                                `<div class="emotion-item">
                                    <span>${categoryNames[category] || category}</span>
                                    <span>${count}íšŒ ì–¸ê¸‰</span>
                                </div>`
                            ).join('') : '<p>íŠ¹ë³„í•œ íŒ¨í„´ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>'}
                            
                            <h4 style="margin-top: 15px;">ğŸ’­ ê°ì • ìƒíƒœ ë³€í™”:</h4>
                            <p>${emotionalTrend}</p>
                            
                            <h4 style="margin-top: 15px;">ğŸ¯ ì£¼ìš” ë°œê²¬ì‚¬í•­:</h4>
                            ${this.generateInsights(sortedKeywords, emotionalPatterns)}
                            
                            <div style="margin-top: 20px; padding: 15px; background: rgba(79, 172, 254, 0.1); border-radius: 10px;">
                                <p><strong>ğŸ’¡ ìƒë‹´ì‚¬ ì†Œê²¬:</strong> ì§€ì†ì ì¸ ëŒ€í™”ë¥¼ í†µí•´ ${this.conversationState.conversationHistory.length}íšŒì˜ ìƒí˜¸ì‘ìš©ì„ ë¶„ì„í•œ ê²°ê³¼, 
                                ${sortedKeywords.length > 0 ? `ì£¼ë¡œ ${categoryNames[sortedKeywords[0][0]]} ì˜ì—­ì—ì„œ ì–´ë ¤ì›€ì„ ê²ªê³  ê³„ì‹  ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.` : 'ë‹¤ì–‘í•œ ì£¼ì œì— ëŒ€í•´ ê· í˜•ì¡íŒ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ê³  ê³„ì‹­ë‹ˆë‹¤.'}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(analysisDiv);
                this.scrollToBottom();
            }

            /**
             * ê°ì • íŠ¸ë Œë“œ ë¶„ì„
             */
            analyzeEmotionalTrend(emotions) {
                if (emotions.length < 3) return "ë¶„ì„ì„ ìœ„í•œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.";
                
                const positiveCount = emotions.filter(e => e === 'positive').length;
                const negativeCount = emotions.filter(e => e === 'negative').length;
                const neutralCount = emotions.filter(e => e === 'neutral').length;
                
                if (negativeCount > positiveCount + neutralCount) {
                    return "ìµœê·¼ ëŒ€í™”ì—ì„œ ë¶€ì •ì ì¸ ê°ì •ì´ ì§€ì†ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤.";
                } else if (positiveCount > negativeCount + neutralCount) {
                    return "ìµœê·¼ ëŒ€í™”ì—ì„œ ê¸ì •ì ì¸ ê°ì •ì´ ì¦ê°€í•˜ëŠ” ê²½í–¥ì„ ë³´ì…ë‹ˆë‹¤.";
                } else {
                    return "ê°ì • ìƒíƒœê°€ ë³€í™”í•˜ë©° ì•ˆì •ì ì¸ íŒ¨í„´ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.";
                }
            }

            /**
             * ì¸ì‚¬ì´íŠ¸ ìƒì„±
             */
            generateInsights(sortedKeywords, emotionalPatterns) {
                const insights = [];
                
                if (sortedKeywords.length > 0) {
                    const topCategory = sortedKeywords[0][0];
                    const topCount = sortedKeywords[0][1];
                    
                    if (topCount >= 3) {
                        insights.push(`â€¢ ${topCategory === 'depression' ? 'ìš°ìš¸ê°' : topCategory === 'anxiety' ? 'ë¶ˆì•ˆê°' : 'ìŠ¤íŠ¸ë ˆìŠ¤'} ê´€ë ¨ ì£¼ì œê°€ ë°˜ë³µì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ê³  ìˆì–´ ì£¼ì˜ê¹Šì€ ê´€ì°°ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
                    }
                }
                
                if (emotionalPatterns.filter(e => e === 'negative').length > emotionalPatterns.length * 0.7) {
                    insights.push('â€¢ ë¶€ì •ì  ê°ì •ì´ ì§€ë°°ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ê³  ìˆì–´ ì „ë¬¸ì  ì§€ì›ì´ ë„ì›€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
                
                if (sortedKeywords.some(([cat]) => cat === 'relationships')) {
                    insights.push('â€¢ ì¸ê°„ê´€ê³„ ì˜ì—­ì—ì„œì˜ ì–´ë ¤ì›€ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                if (insights.length === 0) {
                    insights.push('â€¢ ë‹¤ì–‘í•œ ì£¼ì œì— ëŒ€í•´ ê· í˜•ì¡íŒ í‘œí˜„ì„ í•˜ê³  ê³„ì‹­ë‹ˆë‹¤.');
                }
                
                return insights.join('<br>');
            }

            /**
             * ê²°ê³¼ ìš”ì•½ ë° ê¶Œì¥ì‚¬í•­ ì œê³µ
             */
            provideSummaryAndRecommendations() {
                const assessmentType = this.conversationState.currentAssessmentType;
                const scores = this.session.scores[assessmentType];
                const totalScore = scores.reduce((sum, score) => sum + score, 0);
                const interpretation = this.interpretScore(totalScore, assessmentType);
                
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'message bot';
                
                summaryDiv.innerHTML = `
                    <div class="avatar bot-avatar">ğŸ“‹</div>
                    <div class="message-bubble">
                        <div class="summary-card">
                            <div class="summary-header">
                                <h3>ğŸ“Š í‰ê°€ ê²°ê³¼ ë° ë¶„ì„</h3>
                            </div>
                            
                            <div class="score-display">
                                <div class="score-number">${totalScore}</div>
                                <div class="score-interpretation">${this.assessmentData[assessmentType].name}</div>
                                <div style="margin-top: 10px; font-weight: 600; color: #7b1fa2;">
                                    í•´ì„: ${interpretation}
                                </div>
                            </div>

                            <div class="recommendations">
                                <h4>ğŸ’¡ ê¶Œì¥ì‚¬í•­</h4>
                                ${this.generateRecommendations(totalScore, assessmentType)}
                            </div>

                            <div style="margin-top: 20px; padding: 15px; background: rgba(33, 150, 243, 0.1); border-radius: 10px;">
                                <h4 style="color: #1976d2; margin-bottom: 10px;">ğŸ“š ì „ë¬¸ ê¸°ê´€ ì—°ë½ì²˜</h4>
                                <div class="recommendation-item">
                                    <div class="recommendation-icon">ğŸ“</div>
                                    <div>
                                        <strong>ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°:</strong> 1577-0199<br>
                                        <strong>ìƒëª…ì˜ì „í™”:</strong> 1393<br>
                                        <strong>ì²­ì†Œë…„ì „í™”:</strong> 1388
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(summaryDiv);
                this.scrollToBottom();

                // ìƒë‹´ ê³„ì† ì—¬ë¶€ í™•ì¸
                setTimeout(() => {
                    this.addBotMessage(
                        "ê²€ì‚¬ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¶”ê°€ ìƒë‹´ì„ ê³„ì†í•˜ì‹œê±°ë‚˜, ë‹¤ë¥¸ ê²€ì‚¬ë¥¼ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”?",
                        ["ëŒ€í™” ìƒë‹´ì„ ê³„ì†í•˜ê² ìŠµë‹ˆë‹¤", "ë‹¤ë¥¸ ê²€ì‚¬ë„ ë°›ì•„ë³´ê³  ì‹¶ì–´ìš”", "ìƒë‹´ì„ ì¢…ë£Œí•˜ê² ìŠµë‹ˆë‹¤"]
                    );
                    this.conversationState.phase = 'conversation';
                    this.session.mode = 'conversation';
                }, 1000);
            }

            /**
             * ì ìˆ˜ í•´ì„
             */
            interpretScore(score, assessmentType) {
                switch (assessmentType) {
                    case 'phq9':
                        if (score <= 4) return "ìµœì†Œ ìˆ˜ì¤€ì˜ ìš°ìš¸ê°";
                        else if (score <= 9) return "ê²½ë¯¸í•œ ìš°ìš¸ê°";
                        else if (score <= 14) return "ì¤‘ë“±ë„ ìš°ìš¸ê°";
                        else if (score <= 19) return "ì¤‘ë“±ë„-ì‹¬í•œ ìš°ìš¸ê°";
                        else return "ì‹¬í•œ ìš°ìš¸ê°";

                    case 'gad7':
                        if (score <= 4) return "ìµœì†Œ ìˆ˜ì¤€ì˜ ë¶ˆì•ˆê°";
                        else if (score <= 9) return "ê²½ë¯¸í•œ ë¶ˆì•ˆê°";
                        else if (score <= 14) return "ì¤‘ë“±ë„ ë¶ˆì•ˆê°";
                        else return "ì‹¬í•œ ë¶ˆì•ˆê°";

                    case 'stress':
                        if (score <= 13) return "ë‚®ì€ ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€";
                        else if (score <= 26) return "ë³´í†µ ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€";
                        else return "ë†’ì€ ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€";

                    default:
                        return "í‰ê°€ ì™„ë£Œ";
                }
            }

            /**
             * ë§ì¶¤í˜• ê¶Œì¥ì‚¬í•­ ìƒì„±
             */
            generateRecommendations(score, assessmentType) {
                let recommendations = '';

                if (assessmentType === 'phq9' && score >= 10) {
                    recommendations = `
                        <div class="recommendation-item">
                            <div class="recommendation-icon">ğŸ¥</div>
                            <div>
                                <strong>ì¤‘ë“±ë„ ì´ìƒì˜ ìš°ìš¸ê°ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</strong><br>
                                ì „ë¬¸ì ì¸ ìƒë‹´ì´ë‚˜ ì¹˜ë£Œë¥¼ ë°›ìœ¼ì‹œëŠ” ê²ƒì„ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤.
                            </div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">ğŸ†˜</div>
                            <div>
                                <strong>ì‘ê¸‰ìƒí™©:</strong> ìí•´ë‚˜ ìì‚´ ìƒê°ì´ ìˆë‹¤ë©´<br>
                                ì¦‰ì‹œ 119 ë˜ëŠ” ìƒëª…ì˜ì „í™”(1393)ì— ì—°ë½í•˜ì„¸ìš”.
                            </div>
                        </div>
                    `;
                } else if (assessmentType === 'gad7' && score >= 10) {
                    recommendations = `
                        <div class="recommendation-item">
                            <div class="recommendation-icon">ğŸ˜°</div>
                            <div>
                                <strong>ì¤‘ë“±ë„ ì´ìƒì˜ ë¶ˆì•ˆê°ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</strong><br>
                                ì´ì™„ ê¸°ë²•, ê·œì¹™ì ì¸ ìš´ë™, ì „ë¬¸ ìƒë‹´ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.
                            </div>
                        </div>
                    `;
                } else {
                    recommendations = `
                        <div class="recommendation-item">
                            <div class="recommendation-icon">ğŸŒ±</div>
                            <div><strong>ê·œì¹™ì ì¸ ìƒí™œ ë¦¬ë“¬ ìœ ì§€</strong></div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">ğŸƒ</div>
                            <div><strong>ì ì ˆí•œ ìš´ë™ê³¼ íœ´ì‹</strong></div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">ğŸ‘¥</div>
                            <div><strong>ì‚¬íšŒì  ì§€ì§€ì²´ê³„ í™œìš©</strong></div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">ğŸ’¬</div>
                            <div><strong>í•„ìš”ì‹œ ì „ë¬¸ê°€ ìƒë‹´</strong></div>
                        </div>
                    `;
                }

                return recommendations;
            }

            /**
             * ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€
             */
            addUserMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="avatar user-avatar">ğŸ‘¤</div>
                    <div class="message-bubble">${this.escapeHtml(message)}</div>
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * ë´‡ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€
             */
            addBotMessage(message, quickResponses = []) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                
                let quickResponsesHtml = '';
                if (quickResponses.length > 0) {
                    quickResponsesHtml = `
                        <div class="quick-responses">
                            ${quickResponses.map(response => 
                                `<div class="quick-response" onclick="chatbot.selectQuickResponse('${response}')">${response}</div>`
                            ).join('')}
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    <div class="avatar bot-avatar">ğŸ¤–</div>
                    <div class="message-bubble">
                        ${this.escapeHtml(message).replace(/\n/g, '<br>')}
                        ${quickResponsesHtml}
                    </div>
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
             */
            addSystemMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div class="avatar system-avatar">ğŸ“¢</div>
                    <div class="message-bubble">${this.escapeHtml(message)}</div>
                `;
                this.chatContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * ë¹ ë¥¸ ì‘ë‹µ ì„ íƒ ì²˜ë¦¬
             */
            selectQuickResponse(response) {
                this.messageInput.value = response;
                this.sendMessage();
            }

            /**
             * íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
             */
            showTypingIndicator() {
                this.isTyping = true;
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot typing-message';
                typingDiv.innerHTML = `
                    <div class="avatar bot-avatar">ğŸ¤–</div>
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <span>AI ìƒë‹´ì‚¬ê°€ ë¶„ì„ ì¤‘</span>
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                `;
                this.chatContainer.appendChild(typingDiv);
                this.scrollToBottom();
            }

            /**
             * íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
             */
            removeTypingIndicator() {
                this.isTyping = false;
                const typingMessage = this.chatContainer.querySelector('.typing-message');
                if (typingMessage) {
                    typingMessage.remove();
                }
            }

            /**
             * ìƒë‹´ ì¢…ë£Œ ì²˜ë¦¬
             */
            endConversation() {
                this.addSystemMessage("ìƒë‹´ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
                this.addBotMessage(
                    "ğŸ™ ìƒë‹´ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n" +
                    "ğŸ”’ ëª¨ë“  ëŒ€í™” ê¸°ë¡ì´ ì•ˆì „í•˜ê²Œ ì‚­ì œë©ë‹ˆë‹¤.\n" +
                    "ğŸ’š ì–¸ì œë“  ë‹¤ì‹œ ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì„œ ìƒˆë¡œìš´ ìƒë‹´ì„ ì‹œì‘í•˜ì„¸ìš”."
                );
                
                this.messageInput.disabled = true;
                this.sendButton.disabled = true;
                
                setTimeout(() => {
                    this.session = null;
                    console.log('ì„¸ì…˜ ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }, 2000);
            }

            /**
             * ì±„íŒ… ì»¨í…Œì´ë„ˆë¥¼ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
             */
            scrollToBottom() {
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }

            /**
             * HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ (XSS ë°©ì§€)
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * ë¹„ë™ê¸° ì§€ì—° í•¨ìˆ˜
             */
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        /**
         * ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
         */
        let chatbot;
        document.addEventListener('DOMContentLoaded', () => {
            chatbot = new EnhancedAICounselingChatbot();
        });
    </script>
</body>
</html>
